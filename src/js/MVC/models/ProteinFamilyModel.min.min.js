var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(c,e,a){c!=Array.prototype&&c!=Object.prototype&&(c[e]=a.value)};$jscomp.getGlobal=function(c){return"undefined"!=typeof window&&window===c?c:"undefined"!=typeof global&&null!=global?global:c};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var c=0;return function(e){return $jscomp.SYMBOL_PREFIX+(e||"")+c++}}();$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var c=$jscomp.global.Symbol.iterator;c||(c=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[c]&&$jscomp.defineProperty(Array.prototype,c,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(c){var e=0;return $jscomp.iteratorPrototype(function(){return e<c.length?{done:!1,value:c[e++]}:{done:!0}})};$jscomp.iteratorPrototype=function(c){$jscomp.initSymbolIterator();c={next:c};c[$jscomp.global.Symbol.iterator]=function(){return this};return c};$jscomp.makeIterator=function(c){$jscomp.initSymbolIterator();var e=c[Symbol.iterator];return e?e.call(c):$jscomp.arrayIterator(c)};$jscomp.polyfill=function(c,e,a,d){if(e){a=$jscomp.global;c=c.split(".");for(d=0;d<c.length-1;d++){var b=c[d];b in a||(a[b]={});a=a[b]}c=c[c.length-1];d=a[c];e=e(d);e!=d&&null!=e&&$jscomp.defineProperty(a,c,{configurable:!0,writable:!0,value:e})}};$jscomp.FORCE_POLYFILL_PROMISE=!1;$jscomp.polyfill("Promise",function(c){function e(){this.batch_=null}function a(a){return a instanceof b?a:new b(function(b,l){b(a)})}if(c&&!$jscomp.FORCE_POLYFILL_PROMISE)return c;e.prototype.asyncExecute=function(a){null==this.batch_&&(this.batch_=[],this.asyncExecuteBatch_());this.batch_.push(a);return this};e.prototype.asyncExecuteBatch_=function(){var a=this;this.asyncExecuteFunction(function(){a.executeBatch_()})};var d=$jscomp.global.setTimeout;e.prototype.asyncExecuteFunction=function(a){d(a,0)};e.prototype.executeBatch_=function(){for(;this.batch_&&this.batch_.length;){var a=this.batch_;this.batch_=[];for(var b=0;b<a.length;++b){var c=a[b];delete a[b];try{c()}catch(h){this.asyncThrow_(h)}}}this.batch_=null};e.prototype.asyncThrow_=function(a){this.asyncExecuteFunction(function(){throw a})};var b=function(a){this.state_=0;this.result_=void 0;this.onSettledCallbacks_=[];var b=this.createResolveAndReject_();try{a(b.resolve,b.reject)}catch(g){b.reject(g)}};b.prototype.createResolveAndReject_=function(){function a(a){return function(d){c||(c=!0,a.call(b,d))}}var b=this,c=!1;return{resolve:a(this.resolveTo_),reject:a(this.reject_)}};b.prototype.resolveTo_=function(a){if(a===this)this.reject_(new TypeError("A Promise cannot resolve to itself"));else if(a instanceof b)this.settleSameAsPromise_(a);else{a:switch(typeof a){case"object":var c=null!=a;break a;case"function":c=!0;break a;default:c=!1}c?this.resolveToNonPromiseObj_(a):this.fulfill_(a)}};b.prototype.resolveToNonPromiseObj_=function(a){var b=void 0;try{b=a.then}catch(g){this.reject_(g);return}"function"==typeof b?this.settleSameAsThenable_(b,a):this.fulfill_(a)};b.prototype.reject_=function(a){this.settle_(2,a)};b.prototype.fulfill_=function(a){this.settle_(1,a)};b.prototype.settle_=function(a,b){if(0!=this.state_)throw Error("Cannot settle("+a+", "+b|"): Promise already settled in state"+this.state_);this.state_=a;this.result_=b;this.executeOnSettledCallbacks_()};b.prototype.executeOnSettledCallbacks_=function(){if(null!=this.onSettledCallbacks_){for(var a=this.onSettledCallbacks_,b=0;b<a.length;++b)a[b].call(),a[b]=null;this.onSettledCallbacks_=null}};var f=new e;b.prototype.settleSameAsPromise_=function(a){var b=this.createResolveAndReject_();a.callWhenSettled_(b.resolve,b.reject)};b.prototype.settleSameAsThenable_=function(a,b){var c=this.createResolveAndReject_();try{a.call(b,c.resolve,c.reject)}catch(h){c.reject(h)}};b.prototype.then=function(a,c){function d(a,b){return"function"==typeof a?function(b){try{e(a(b))}catch(m){f(m)}}:b}var e,f,l=new b(function(a,b){e=a;f=b});this.callWhenSettled_(d(a,e),d(c,f));return l};b.prototype.catch=function(a){return this.then(void 0,a)};b.prototype.callWhenSettled_=function(a,b){function c(){switch(d.state_){case 1:a(d.result_);break;case 2:b(d.result_);break;default:throw Error("Unexpected state: "+d.state_)}}var d=this;null==this.onSettledCallbacks_?f.asyncExecute(c):this.onSettledCallbacks_.push(function(){f.asyncExecute(c)})};b.resolve=a;b.reject=function(a){return new b(function(b,c){c(a)})};b.race=function(c){return new b(function(b,d){for(var e=$jscomp.makeIterator(c),f=e.next();!f.done;f=e.next())a(f.value).callWhenSettled_(b,d)})};b.all=function(c){var d=$jscomp.makeIterator(c),e=d.next();return e.done?a([]):new b(function(b,c){function f(a){return function(c){g[a]=c;h--;0==h&&b(g)}}var g=[],h=0;do{g.push(void 0),h++,a(e.value).callWhenSettled_(f(g.length-1),c),e=d.next()}while(!e.done)})};return b},"es6","es3");$jscomp.findInternal=function(c,e,a){c instanceof String&&(c=String(c));for(var d=c.length,b=0;b<d;b++){var f=c[b];if(e.call(a,f,b,c))return{i:b,v:f}}return{i:-1,v:void 0}};$jscomp.polyfill("Array.prototype.find",function(c){return c?c:function(c,a){return $jscomp.findInternal(this,c,a).v}},"es6","es3");$jscomp.iteratorFromArray=function(c,e){$jscomp.initSymbolIterator();c instanceof String&&(c+="");var a=0,d={next:function(){if(a<c.length){var b=a++;return{value:e(b,c[b]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};$jscomp.polyfill("Array.prototype.values",function(c){return c?c:function(){return $jscomp.iteratorFromArray(this,function(c,a){return a})}},"es8","es3");var App=App||{},ProteinFamilyModel=function(){function c(a){return new Promise(function(c,b){var d=[],e=[],k=[];a.forEach(function(a,b){d.push(a.sequence);e.push(a.name)});d[0].forEach(function(a,b){k.push(["R",b])});c({data:d,index:e,columns:k})})}function e(){var a=this;a._selectedProtein=null;a._selectedProteinIndex=0;a._selectedProteinOffset=0;a._selectedResidues={left:[],right:[]};a._previousSelectedResidues={left:[],right:[]};a._sequenceSortingAlgorithms=null;a._proteinSorting="initial";a._proteinColoring="";a._proteinNames=null;a._parsedData=null;a._mappings={};a._max_frequencies=[];a.proteinFamilyAdded=new EventNotification(this);a.selectedProteinChanged=new EventNotification(this);a.proteinOverviewChanged=new EventNotification(this);a.selectedResiduesChanged=new EventNotification(this);a.proteinSortingChanged=new EventNotification(this);a.proteinColoringChanged=new EventNotification(this);a.mappingPromise=null;a.set_scores=function(c,b){b.forEach(function(b){_.find(a._rawData,function(a){return b.name===a.name}).scores[c]=b.score})};a.calculate_all_sorting_scores_main=function(c){a._sequenceSortingAlgorithms.calculateEditDistanceScores(c).then(function(b){a.set_scores("edit_distance",b);return a._sequenceSortingAlgorithms.calculateEditDistanceScores(c,{insertion:3,deletion:3,substitution:5})}).then(function(b){a.set_scores("weighted_edit_distance",b);return a._sequenceSortingAlgorithms.calculateCommonalityScores(c)}).then(function(b){a.set_scores("commonality_scores",b);a._sequenceSortingAlgorithms.calculateCommonalityScores(c,1)}).then(function(b){a.set_scores("normalized_commonality_scores",b);$("#sorting_list").find("li").removeClass("disabled")})}}e.prototype={isEmpty:function(){return!!this._parsedData},calculate_scores:function(a,c){if(window.Worker){var b=this._sequenceSortingAlgorithms.getAlgorithms(),d=b.length,e=0,k=this;b.forEach(function(b){var f=new Worker("src/js/utilities/sequenceSortingProcessing.js");f.postMessage({family:k._rawData,algorithm:b,protein:a});f.onmessage=function(a){k.set_scores(a.data.algorithm,a.data.score);e++;d===e&&($("#sorting_list").find("li").removeClass("disabled"),c&&c())}})}else this.calculate_all_sorting_scores_main(a)},setFamily:function(a,d){this._rawData=App.fileUtilities.parseAlignmentFile(a,d);c(this._rawData).then(function(a){this._sequenceSortingAlgorithms=new SequenceSorting(this._rawData);this._parsedData=a;this.setProteinNames();this.setSelectedProtein(this._proteinNames[0]);this.setColumnFrequencies();this.mappingPromise=this.setProteinMappings();this.calculate_scores(this._rawData[0]);this.proteinFamilyAdded.notify({family:this._parsedData,proteinCount:this._proteinNames.length,sequenceLength:this._rawData[0].length})}.bind(this))},clear:function(){this._rawData=null;this._mappings={};this._selectedProtein=null;self._selectedProteinIndex=0;this._selectedResidues={left:[],right:[]};this._previousSelectedResidues={left:[],right:[]};this.mappingPromise=null;this._max_frequencies=[];this._sequenceSortingAlgorithms=null;this._proteinSorting="initial";this._proteinColoring="";this._parsedData=this._proteinNames=null;this.selectedProteinChanged.clear();this.selectedResiduesChanged.clear()},getMaxSequenceFrequenciesFromRange:function(a){var c=[];this._sequenceSortingAlgorithms.getFragmentCountsFromRange(a[0],a[1]).forEach(function(a){c.push(_.maxBy(_.toPairs(a),function(a){return a[1]}))});return c},getSequenceFrequenciesFromRange:function(a){return this._sequenceSortingAlgorithms.getFragmentCountsFromRange(a[0],a[1])},getSequenceFrequencyAt:function(a){return this._max_frequencies[a]},getFamily:function(){return this._parsedData},getProteinMappings:function(){return this.mappingPromise},addProteinMapping:function(a,c){return 0>this._mappings[a].indexOf(c.pdb)?(this._mappings[a].push(c.pdb),!0):!1},setProteinMappings:function(){var a=this;return new Promise(function(c,b){var d=[],e=[];a._proteinNames.forEach(function(b,c,f){4===b.length&&d.push(b);e.push(b);a._mappings[b]=[]});Promise.all([App.dataUtilities.checkPDBs(d.join(",")),App.dataUtilities.queryForUniprotIdentifiers(e.join(","))]).then(function(b){b[0].forEach(function(b){"UNKNOWN"!==b.status&&0>a._mappings[b.pdb].indexOf(b.pdb)&&a._mappings[b.pdb].push(b.pdb)});b[1].forEach(function(b){b.pdb.split(";").forEach(function(c){0<c.length&&0>a._mappings[b.id].indexOf(c)&&a._mappings[b.id].push(c)})});c(a._mappings)})})},setProteinNames:function(a){this._proteinNames=d3.set(this._rawData.map(function(a){return a.name})).values()},setColumnFrequencies:function(){for(var a=0,c=$jscomp.makeIterator(this._parsedData.data[0]),b=c.next();!b.done;b=c.next())this._max_frequencies.push(this._sequenceSortingAlgorithms.getMostFrequentAt(a++))},getProteinNames:function(){return this._proteinNames},getProteinCount:function(){return this._proteinNames.length},getSequenceCount:function(){return this._rawData[0].length},getSelectedProtein:function(){return this._selectedProtein},setSortingProtein:function(){var a=this,c=a.getProteinNames();$("#proteinSelection").modal("show").on("shown.bs.modal",function(a){var b=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.whitespace,queryTokenizer:Bloodhound.tokenizers.whitespace,local:c});$("#proteinSortSelection").typeahead({hint:!0,highlight:!0,minLength:1},{name:"proteins",source:b});$(a.target).find("#proteinSortSelection").focus()}).on("hide.bs.modal",function(b){b=$(b.target).find("#proteinSortSelection");var c=b.val();c=_.filter(a._rawData,["name",c])[0];b.val("");c&&a.calculate_scores(c,a.setProteinSorting.bind(a,a._proteinSorting))})},setOverviewOffset:function(a){this._selectedProteinOffset=a;this._selectedProtein=_.filter(this._rawData,["name",this._proteinNames[this._selectedProteinIndex+this._selectedProteinOffset]])[0];this.proteinOverviewChanged.notify({selection:this._selectedProtein})},setSelectedProtein:function(a){this._selectedProtein=_.filter(this._rawData,["name",a])[0];this._selectedProteinIndex=this._selectedProteinOffset+this._proteinNames.indexOf(a);this.selectedProteinChanged.notify({selection:this._selectedProtein});return this},getSelectedResidues:function(a){return{selection:this._selectedResidues[a],previous:this._previousSelectedResidues[a]}},setSelectedResidues:function(a,c){this._previousSelectedResidues[a]=this._selectedResidues[a];this._selectedResidues[a]=c;this.selectedResiduesChanged.notify({semantic:a,selection:this._selectedResidues[a],previous:this._previousSelectedResidues[a]});return this},getProteinSorting:function(){return this._proteinSorting},getProteinColoring:function(){return this._proteinColoring},setProteinSorting:function(a){if(a){this._proteinSorting=a;var d=this;this._rawData=_.chain(this._rawData).sortBy(function(b){return b.scores[a]}).reverse().slice(0,this.ppv).value();c(this._rawData).then(function(a){d._parsedData=a;d.setProteinNames();d.setSelectedProtein(d._proteinNames[d._selectedProteinIndex+d._selectedProteinOffset]);d.proteinSortingChanged.notify({scheme:d._proteinSorting,data:a,colorScheme:d._proteinColoring});return Promise.resolve()})}return this},setProteinColoring:function(a){this._proteinColoring=a;this.proteinColoringChanged.notify({scheme:this._proteinColoring});return this}};return e}();