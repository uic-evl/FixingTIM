var App=App||{},BrushView=function(){function m(d,b){var a=this;a._model=d;a._scale=b.scale||null;a._orientation=b.orientation;a._tooltip=null;a._semantic=b.semantic;a._class="";a._menuSelection="";a.overlays=[];var e=b.block_size;a.brushMoved=null;a.proteinSelected=null;a._selection=a._orientation===App.OVERVIEW_PADDLE?b.position:[0,0];a.initialize(b);a.brushMoved=new EventNotification(this);a.proteinSelected=new EventNotification(this);a._model.selectedProteinChanged.attach(function(c,b){a.redraw(App.HORIZONTAL_PADDLE,
b)});a._model.selectedResiduesChanged.attach(function(c,b){a.redraw(App.VERTICAL_PADDLE,b)});a._model.proteinOverviewChanged.attach(function(c,b){a.redraw(App.OVERVIEW_PADDLE,b)});a.onBrush=function(){if(d3.event.sourceEvent&&d3.event.selection&&"brush"!==d3.event.sourceEvent.type){if(b.orientation===App.HORIZONTAL_PADDLE)d3.event.selection[0]=Math.floor(d3.event.selection[0]/e)*e,d3.event.selection[1]=Math.floor(d3.event.selection[1]/e)*e;else if(b.orientation===App.VERTICAL_PADDLE){d3.event.selection[0]=
parseInt(Math.round(d3.event.selection[0]/e)*e);d3.event.selection[1]=parseInt(Math.round(d3.event.selection[1]/e)*e);var c=d3.event.selection,d=a._model.getSelectedResidues(b.semantic).previous;if(a._orientation!==App.OVERVIEW_PADDLE){var k=Math.abs(c[1]-c[0]),f=b.maxPaddleSize*e,g=b.paddleSize*e;k>f?c[0]===d[0]?c[1]=c[0]+f:c[0]=c[1]-f:k<g&&(c[0]===d[0]?c[1]=c[0]+g:c[0]=c[1]-g)}}else d3.event.selection[0]=Math.round(d3.event.selection[0]/e)*e,d3.event.selection[1]=Math.round(d3.event.selection[1]/
e)*e;d3.select(this).call(d3.event.target.move,d3.event.selection);a._selection=d3.event.selection;a.brushMoved.notify({options:b,selection:d3.event.selection})}};a.addBrushOverlays=function(c){var d=c.node().parentNode,e=parseInt(c.selectAll("rect.selection").attr("y"))-1,f=parseInt(c.selectAll("rect.selection").attr("height")),g=parseInt(c.selectAll("rect.overlay").attr("height"));c=parseInt(c.selectAll("rect.overlay").attr("width"));var l=[];a._orientation===App.HORIZONTAL_PADDLE?l=[{x:0,y:e,width:c,
height:0,class_name:"horizontal_covers trend_covers"},{x:0,y:e+f,width:c,height:g-f,class_name:"horizontal_covers trend_covers"},{x:0,y:e,width:0,height:0,class_name:"left_vertical_covers vertical_covers trend_covers"},{x:0,y:e+f,width:0,height:g-f,class_name:"left_vertical_covers vertical_covers trend_covers"},{x:c,y:e,width:0,height:0,class_name:"right_vertical_covers vertical_covers trend_covers"},{x:c,y:e+f,width:0,height:g-f,class_name:"right_vertical_covers vertical_covers trend_covers"}]:a._orientation===
App.OVERVIEW_PADDLE&&(l=[{x:parseInt(b.extent[0][0])+1,y:e,width:c,height:0,class_name:"overview_covers trend_covers"},{x:parseInt(b.extent[0][0])+1,y:e+f,width:c,height:g-f,class_name:"overview_covers trend_covers"}]);d3.select(d).selectAll("paddle_overlays").data(l,function(a){return a}).enter().append("rect").attr("class",function(a){return a.class_name}).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("width",function(a){return a.width}).attr("height",function(a){return a.height}).attr("fill",
"#ecf0f1")};a.addContextMenu=function(){a.createContextMenu("g.horizontal.main rect.selection");$(".btn-left_viewer").on("click",function(c){$(".context-menu-list").trigger("contextmenu:hide");a.proteinSelected.notify({semantic:"left",protein:a._menuSelection})});$(".btn-right_viewer").on("click",function(c){$(".context-menu-list").trigger("contextmenu:hide");a.proteinSelected.notify({semantic:"right",protein:a._menuSelection})})};a.removeContextMenu=function(){$(".btn-left_viewer").off("click");
$(".btn-right_viewer").off("click")};_.mixin(a,new jQueryContextUtils(a))}m.prototype={initialize:function(d){var b=this;b.class=d.class;b.brushObj=App.BrushFactory.createBrush(d.orientation).setPaddleSize(d.paddleSize).setMaxPaddleSize(d.maxPaddleSize).setBrushClass(d.class).setPaddleExtent(d.extent).setInitialPosition(d.position).onBrush(function(){b.onBrush.call(this)});d.tooltip&&(b._tooltip=d3.tip().attr("class","d3-tip").offset([-10,0]).html(d.tooltip))},getInitialPosition:function(){return this.brushObj.getInitialPosition()},
getBrush:function(){return this.brushObj.brush},getSelection:function(){return this._selection},setSelection:function(d){this._selection=d},getScale:function(){return this._scale},getBrushElement:function(){return document.getElementsByClassName(this.brushObj.getBrushClass())[0]},render:function(d){d.selectAll(".overlay").style("pointer-events","none");d.selectAll(".selection").style("shape-rendering","auto");this.addBrushOverlays(d);this._orientation===App.HORIZONTAL_PADDLE&&this.addContextMenu();
this._tooltip&&(d.call(this._tooltip),d.select("rect.selection").on("mouseover",this._tooltip.show).on("mouseout",this._tooltip.hide))},redraw:function(d,b){var a=null;if(d===App.OVERVIEW_PADDLE){var e=parseInt(d3.select("g.horizontal rect.overlay").attr("height"));a=d3.select("g.overview rect.selection");var c=parseInt(a.attr("y"));var h=parseInt(a.attr("height"));d3.selectAll("rect.overview_covers").attr("y",function(a,b){return b?c+h:a.y}).attr("height",function(a,b){a=b?e-(c+h-a.y):c-a.y;return-1<
a?a:0})}else if(d===App.HORIZONTAL_PADDLE){var k=parseInt(d3.select("g.horizontal rect.overlay").attr("height"));a=d3.select("g.horizontal rect.selection");c=parseInt(a.attr("y"));h=parseInt(a.attr("height"));d3.selectAll("rect.horizontal_covers").attr("y",function(a,b){console.log(a.y);return b?c+h:a.y}).attr("height",function(a,b){return b?k-(c+h-a.y):c-a.y});d3.selectAll("rect.vertical_covers").attr("y",function(a,b){return(b+1)%2?a.y:c+h}).attr("height",function(a,b){return(b+1)%2?c-a.y:k-(c+
h-a.y)})}else if(d===App.VERTICAL_PADDLE)if(d=parseInt(d3.select("g.horizontal rect.overlay").attr("width")),"left"===b.semantic)d=d3.select("g.vertical-right rect.selection"),a=d3.select("g.vertical-left rect.selection"),b=parseInt(a.attr("x")),a=parseInt(a.attr("width")),d3.selectAll("rect.left_vertical_covers").attr("width",b),d3.selectAll("rect.horizontal_covers").attr("x",b+a).attr("width",parseInt(d.attr("x"))-(b+a));else if("right"===b.semantic){var f=d3.select("g.vertical-left rect.selection"),
g=parseInt(f.attr("width"));a=d3.select("g.vertical-right rect.selection");b=parseInt(a.attr("x"));a=parseInt(a.attr("width"));d3.selectAll("rect.right_vertical_covers").attr("x",b+a).attr("width",d-(b+a));d3.selectAll("rect.horizontal_covers").attr("width",b-(parseInt(f.attr("x"))+g))}}};return m}();
