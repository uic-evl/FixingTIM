"use strict";var App=App||{};const TertiaryStructureView=(function(){function d(e){let colorMapping=App.residueMappingUtility.getColor(e,"3D");return new pv.color.ColorOp(function(h,g,f){let color=colorMapping(h._residue._name).rgba;g[f+0]=color[0]/255;g[f+1]=color[1]/255;g[f+2]=color[2]/255;g[f+3]=color[3]/255})}function c(f,e){let p=d3.select(f).select("#proteinName p");p.text(_.toUpper(e))}function b(f,e){if(e.selection){this.picked.node().setSelection(e.selection)}else{let sel=this.selectResidue(this._model.getGeometry().selection(),e.residue);this._model.getGeometry().setSelection(sel)}this.pvViewer.requestRedraw()}function a(e,g){let self=this;self._model=e;self._id=g.id;self._position=g.position;self._dom=null;self.pvViewer=null;self.axis3D=null;self.splash=null;self.staticLabel="";function f(){hopscotch.startTour(App.tour_3D,1);console.log("help")}self.fileUploaded=new EventNotification(this);self.fileUpdated=new EventNotification(this);self.residueSelected=new EventNotification(this);self.residueDeselected=new EventNotification(this);self.colorChanged=new EventNotification(this);self.modelRotated=new EventNotification(this);self.modelZoomed=new EventNotification(this);self.cameraChanged=new EventNotification(this);self.clear_splash=function(){self.splash.find("#files").empty();self.splash.find("#protein-name").val("");self.splash.find("#fileUploadInput").val("")};self.clear_and_reinitialize=function(){if(!self._model.isEmpty()){self.initialize_file_update(d3.select(self._dom[0]).select("#proteinName"))}self.clear_splash()};self.initialize_file_update=function(h){h.classed("hidden",false).select(".settingsOpenPDB").classed("hidden",false);$(h.node()).click(function(){self._dom.find("#pvDiv").find(".tertiaryViewer, .axisViewer, .static-label").hide();self._dom.find("#splashOverlay").addClass("open");self._dom.find(".x_title").hide();self.splash.show()});self._dom.find("#overlayBackground, #overlayClose").click(function(){self.clear_splash();self.splash.hide();self._dom.find(".x_title").show();self._dom.find(".tertiaryViewer, .axisViewer, .static-label").show()});self.splash.find("#fileUploadInput").fileupload("destroy");self.splash.find("#fileUploadInput").unbind("fileuploadadd");App.fileUtilities.uploadSetup(self.splash.find("#fileUploadInput"),self.splash.find("#files"),function(j,i){self.fileUpdated.notify({metaData:j,file:i});self.clear_splash();c(self._dom[0],j.protein_name)})};self.initialize_menus=function(){$.get("./src/html/proteinGeometryListTemplate.html",function(h){self._dom.find("#geometry_list a").after(h);let geometryListModel=new FilteringMenuModel({items:["cartoon","tube","trace","sline","lines","lineTrace","spheres","points"]}),geometryListView=new FilteringMenuView(geometryListModel,{list:self._dom.find("#geometry_ul")}),geometryListController=new FilteringMenuController({menu:"geometry",models:{list:geometryListModel,connected:[self._model]},view:geometryListView,cb:function(i,j){self.pvViewer.rm(i.getName());self.render(i.getStructure(),i.getName(),j);self.pvViewer.requestRedraw()}});geometryListView.show()});$.get("./src/html/proteinColoringListTemplate.html",function(h){self._dom.find("#protein_coloring_list a").after(h);let coloringListModel=new FilteringMenuModel({items:["Side Chain Class","Side Chain Polarity","Selections Only"]}),coloringListView=new FilteringMenuView(coloringListModel,{list:self._dom.find("#protein_coloring_ul")}),coloringListController=new FilteringMenuController({menu:"coloring",models:{list:coloringListModel,connected:[self._model]},view:coloringListView,cb:function(i,j){self.recolor(j);self.colorChanged.notify({color:j});App.residueMappingUtility.createColorLegend("3D")}});coloringListView.show()});d3.select(self._dom[0]).select("#molecularViewerMenu").classed("hidden",false);$("#"+self._id+" #molecularViewerHelp").click(f)};self._model.proteinAdded.attach(function(h,i){$("#"+self._id).find("#popup-trigger-molecule").remove();self.splash.hide();self.initialize();self.render(i.structure,i.name,"tube");self._dom.find(".x_title").show();self.pvViewer.centerOn(i.structure);self.pvViewer.autoZoom();$("#coloring_list").find("li").removeClass("disabled");App.residueMappingUtility.createColorLegend("3D");let state=hopscotch.getState();if(state&&state.indexOf("introduction_tour:")===0){hopscotch.startTour(App.tour_3D,0)}});self._model.proteinColoringChanged.attach(function(i,h){self.recolor(h.scheme);self.pvViewer.requestRedraw()});self._model.residueSelected.attach(b.bind(self));self._model.residueDeselected.attach(b.bind(self));self._model.rotateModel.attach(function(h,i){self.pvViewer._redrawRequested=false;self.pvViewer.setRotation(i.rotation)});self._model.zoomModel.attach(function(h,i){if(self.pvViewer._cam._zoom===i.zoom){return}self.pvViewer.setZoom(i.zoom);self.pvViewer._draw()});self._model.cameraChanged.attach(function(h,i){self.pvViewer._redrawRequested=false;self.pvViewer.setCamera(i.rotation,i.center,i.zoom)});_.mixin(self,new pvUtils(self))}a.prototype={file_loaded:function(f,e){this.fileUploaded.notify({metaData:f,file:e});c(this._dom[0],f.protein_name);this.clear_and_reinitialize()},show:function(){let view=this;view._dom=$("#"+view._id);if(!view._model.isEmpty()){this._dom.find("#splash").load("./src/html/tertiarySplashTemplate.html",function(){let splash=$(this),splash_trigger=splash.find("#popup-trigger-molecule");splash_trigger.click(function(){splash.find("#splashOverlay").addClass("open").find(".signup-form input:first").select();splash_trigger.hide()});splash.find("#overlayBackground, #overlayClose").click(function(){splash.find("#splashOverlay").removeClass("open");if(splash_trigger[0]){splash_trigger.show()}});view.splash=splash;ko.applyBindings(view,splash.find("#splashTemplate")[0]);App.fileUtilities.uploadSetup(splash.find("#fileUploadInput"),splash.find("#files"),view.file_loaded.bind(view))})}},clear:function(){this._dom.find("#pvView *:not(#splash*)").remove();this.pvViewer=null;this.axis3D=null},downloadPDB:function(e){let name=(typeof e==="object")?$(e).serialize().split("=")[1]:e;this.fileUploaded.notify({metaData:{protein_name:name},file:null});this.clear_and_reinitialize();c(this._dom[0],name);return false},initialize:function(){let $dom=this._dom.find("#pvDiv"),dom=$dom[0];this.staticLabel=document.createElement("div");this.staticLabel.innerHTML="&nbsp;";this.staticLabel.className="static-label";dom.appendChild(this.staticLabel);let options={antialias:true,outline:false,quality:"low",near:0.1,background:"black",width:parseInt(d3.select(dom).style("width")),height:parseInt(d3.select(dom).style("height")),selectionColor:"#984ea3"};this.pvViewer=pv.Viewer(dom,options);this.linkInteractions();$dom.find("canvas").addClass("tertiaryViewer");dom.addEventListener("mousemove",this.mouseMoveEvent);this.pvViewer.on("click",this.mouseClickEvent);let axisDOM=document.createElement("div"),width=options.width/4,height=options.height/4;axisDOM.className="axisViewer";axisDOM.style.height=height;axisDOM.style.width=width;dom.append(axisDOM);this.axis3D=new AxisView3D({div:axisDOM,width:width,height:height});this.initialize_menus()},render:function(f,e,g){let geometry=this.pvViewer.renderAs(e,f,g,{color:d.call(this,this._model.getProteinColoring())});this._model.setGeometry(geometry)},recolor:function(e){let geometry=this._model.getGeometry(),viewer=this.pvViewer;if(geometry){geometry.colorBy(d.call(this,e));viewer.requestRedraw()}}};return a})();