(function(a,b){if(typeof define==="function"&&define.amd){define([],b)}else{if(typeof exports==="object"){exports=b();if(typeof module==="object"){module.exports=exports}}else{var c=b();a.pv=c;a.io=c.io;a.mol=c.mol;a.color=c.color;a.rgb=c.rgb;a.viewpoint=c.viewpoint;a.vec3=c.vec3;a.vec4=c.vec4;a.mat3=c.mat3;a.mat4=c.mat4;a.quat=c.quat}}}(this,function(){var o,w,r,U,J,c,S,Q,s,L,A,g,n,O,q,B,v,z,G,x,E,t,i,K,m,l,b,C,p,N,u,F,h,j,D,P,d,M,k,y,I,f,R,H,T,e,a;o=function(){var ab={};if(!ae){var ae=0.000001}if(!W){var W=typeof Float32Array!=="undefined"?Float32Array:Array}if(!aa){var aa=Math.random}var Y={};Y.setMatrixArrayType=function(af){W=af};ab.glMatrix=Y;var ad={};ad.create=function(){var af=new W(3);af[0]=0;af[1]=0;af[2]=0;return af};ad.clone=function(af){var ag=new W(3);ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];return ag};ad.fromValues=function(af,ai,ah){var ag=new W(3);ag[0]=af;ag[1]=ai;ag[2]=ah;return ag};ad.copy=function(ag,af){ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];return ag};ad.set=function(ag,af,ai,ah){ag[0]=af;ag[1]=ai;ag[2]=ah;return ag};ad.add=function(ah,ag,af){ah[0]=ag[0]+af[0];ah[1]=ag[1]+af[1];ah[2]=ag[2]+af[2];return ah};ad.subtract=function(ah,ag,af){ah[0]=ag[0]-af[0];ah[1]=ag[1]-af[1];ah[2]=ag[2]-af[2];return ah};ad.sub=ad.subtract;ad.multiply=function(ah,ag,af){ah[0]=ag[0]*af[0];ah[1]=ag[1]*af[1];ah[2]=ag[2]*af[2];return ah};ad.mul=ad.multiply;ad.divide=function(ah,ag,af){ah[0]=ag[0]/af[0];ah[1]=ag[1]/af[1];ah[2]=ag[2]/af[2];return ah};ad.div=ad.divide;ad.min=function(ah,ag,af){ah[0]=Math.min(ag[0],af[0]);ah[1]=Math.min(ag[1],af[1]);ah[2]=Math.min(ag[2],af[2]);return ah};ad.max=function(ah,ag,af){ah[0]=Math.max(ag[0],af[0]);ah[1]=Math.max(ag[1],af[1]);ah[2]=Math.max(ag[2],af[2]);return ah};ad.scale=function(ah,ag,af){ah[0]=ag[0]*af;ah[1]=ag[1]*af;ah[2]=ag[2]*af;return ah};ad.scaleAndAdd=function(ah,ag,af,ai){ah[0]=ag[0]+af[0]*ai;ah[1]=ag[1]+af[1]*ai;ah[2]=ag[2]+af[2]*ai;return ah};ad.distance=function(ah,ag){var af=ag[0]-ah[0],aj=ag[1]-ah[1],ai=ag[2]-ah[2];return Math.sqrt(af*af+aj*aj+ai*ai)};ad.dist=ad.distance;ad.squaredDistance=function(ah,ag){var af=ag[0]-ah[0],aj=ag[1]-ah[1],ai=ag[2]-ah[2];return af*af+aj*aj+ai*ai};ad.sqrDist=ad.squaredDistance;ad.length=function(ag){var af=ag[0],ai=ag[1],ah=ag[2];return Math.sqrt(af*af+ai*ai+ah*ah)};ad.len=ad.length;ad.squaredLength=function(ag){var af=ag[0],ai=ag[1],ah=ag[2];return af*af+ai*ai+ah*ah};ad.sqrLen=ad.squaredLength;ad.negate=function(ag,af){ag[0]=-af[0];ag[1]=-af[1];ag[2]=-af[2];return ag};ad.normalize=function(ai,ah){var ag=ah[0],ak=ah[1],aj=ah[2];var af=ag*ag+ak*ak+aj*aj;if(af>0){af=1/Math.sqrt(af);ai[0]=ah[0]*af;ai[1]=ah[1]*af;ai[2]=ah[2]*af}return ai};ad.dot=function(ag,af){return ag[0]*af[0]+ag[1]*af[1]+ag[2]*af[2]};ad.cross=function(ag,al,ak){var af=al[0],an=al[1],am=al[2],aj=ak[0],ai=ak[1],ah=ak[2];ag[0]=an*ah-am*ai;ag[1]=am*aj-af*ah;ag[2]=af*ai-an*aj;return ag};ad.lerp=function(ah,ag,af,ai){var al=ag[0],ak=ag[1],aj=ag[2];ah[0]=al+ai*(af[0]-al);ah[1]=ak+ai*(af[1]-ak);ah[2]=aj+ai*(af[2]-aj);return ah};ad.random=function(af,aj){aj=aj||1;var ah=aa()*2*Math.PI;var ai=aa()*2-1;var ag=Math.sqrt(1-ai*ai)*aj;af[0]=Math.cos(ah)*ag;af[1]=Math.sin(ah)*ag;af[2]=ai*aj;return af};ad.transformMat4=function(ai,ah,ag){var af=ah[0],ak=ah[1],aj=ah[2];ai[0]=ag[0]*af+ag[4]*ak+ag[8]*aj+ag[12];ai[1]=ag[1]*af+ag[5]*ak+ag[9]*aj+ag[13];ai[2]=ag[2]*af+ag[6]*ak+ag[10]*aj+ag[14];return ai};ad.transformMat3=function(ai,ah,ag){var af=ah[0],ak=ah[1],aj=ah[2];ai[0]=af*ag[0]+ak*ag[3]+aj*ag[6];ai[1]=af*ag[1]+ak*ag[4]+aj*ag[7];ai[2]=af*ag[2]+ak*ag[5]+aj*ag[8];return ai};ad.transformQuat=function(al,ar,af){var at=ar[0],aq=ar[1],ap=ar[2],an=af[0],am=af[1],ak=af[2],ao=af[3],ai=ao*at+am*ap-ak*aq,ah=ao*aq+ak*at-an*ap,ag=ao*ap+an*aq-am*at,aj=-an*at-am*aq-ak*ap;al[0]=ai*ao+aj*-an+ah*-ak-ag*-am;al[1]=ah*ao+aj*-am+ag*-an-ai*-ak;al[2]=ag*ao+aj*-ak+ai*-am-ah*-an;return al};ad.forEach=function(){var af=ad.create();return function(ai,am,an,al,ak,ag){var aj,ah;if(!am){am=3}if(!an){an=0}if(al){ah=Math.min(al*am+an,ai.length)}else{ah=ai.length}for(aj=an;aj<ah;aj+=am){af[0]=ai[aj];af[1]=ai[aj+1];af[2]=ai[aj+2];ak(af,af,ag);ai[aj]=af[0];ai[aj+1]=af[1];ai[aj+2]=af[2]}return ai}}();ad.str=function(af){return"vec3("+af[0]+", "+af[1]+", "+af[2]+")"};ab.vec3=ad;var ac={};ac.create=function(){var af=new W(4);af[0]=0;af[1]=0;af[2]=0;af[3]=0;return af};ac.clone=function(af){var ag=new W(4);ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[3];return ag};ac.fromValues=function(af,aj,ai,ag){var ah=new W(4);ah[0]=af;ah[1]=aj;ah[2]=ai;ah[3]=ag;return ah};ac.copy=function(ag,af){ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[3];return ag};ac.set=function(ah,af,aj,ai,ag){ah[0]=af;ah[1]=aj;ah[2]=ai;ah[3]=ag;return ah};ac.add=function(ah,ag,af){ah[0]=ag[0]+af[0];ah[1]=ag[1]+af[1];ah[2]=ag[2]+af[2];ah[3]=ag[3]+af[3];return ah};ac.subtract=function(ah,ag,af){ah[0]=ag[0]-af[0];ah[1]=ag[1]-af[1];ah[2]=ag[2]-af[2];ah[3]=ag[3]-af[3];return ah};ac.sub=ac.subtract;ac.multiply=function(ah,ag,af){ah[0]=ag[0]*af[0];ah[1]=ag[1]*af[1];ah[2]=ag[2]*af[2];ah[3]=ag[3]*af[3];return ah};ac.mul=ac.multiply;ac.divide=function(ah,ag,af){ah[0]=ag[0]/af[0];ah[1]=ag[1]/af[1];ah[2]=ag[2]/af[2];ah[3]=ag[3]/af[3];return ah};ac.div=ac.divide;ac.min=function(ah,ag,af){ah[0]=Math.min(ag[0],af[0]);ah[1]=Math.min(ag[1],af[1]);ah[2]=Math.min(ag[2],af[2]);ah[3]=Math.min(ag[3],af[3]);return ah};ac.max=function(ah,ag,af){ah[0]=Math.max(ag[0],af[0]);ah[1]=Math.max(ag[1],af[1]);ah[2]=Math.max(ag[2],af[2]);ah[3]=Math.max(ag[3],af[3]);return ah};ac.scale=function(ah,ag,af){ah[0]=ag[0]*af;ah[1]=ag[1]*af;ah[2]=ag[2]*af;ah[3]=ag[3]*af;return ah};ac.scaleAndAdd=function(ah,ag,af,ai){ah[0]=ag[0]+af[0]*ai;ah[1]=ag[1]+af[1]*ai;ah[2]=ag[2]+af[2]*ai;ah[3]=ag[3]+af[3]*ai;return ah};ac.distance=function(ai,ag){var af=ag[0]-ai[0],ak=ag[1]-ai[1],aj=ag[2]-ai[2],ah=ag[3]-ai[3];return Math.sqrt(af*af+ak*ak+aj*aj+ah*ah)};ac.dist=ac.distance;ac.squaredDistance=function(ai,ag){var af=ag[0]-ai[0],ak=ag[1]-ai[1],aj=ag[2]-ai[2],ah=ag[3]-ai[3];return af*af+ak*ak+aj*aj+ah*ah};ac.sqrDist=ac.squaredDistance;ac.length=function(ah){var af=ah[0],aj=ah[1],ai=ah[2],ag=ah[3];return Math.sqrt(af*af+aj*aj+ai*ai+ag*ag)};ac.len=ac.length;ac.squaredLength=function(ah){var af=ah[0],aj=ah[1],ai=ah[2],ag=ah[3];return af*af+aj*aj+ai*ai+ag*ag};ac.sqrLen=ac.squaredLength;ac.negate=function(ag,af){ag[0]=-af[0];ag[1]=-af[1];ag[2]=-af[2];ag[3]=-af[3];return ag};ac.normalize=function(aj,ai){var ag=ai[0],al=ai[1],ak=ai[2],ah=ai[3];var af=ag*ag+al*al+ak*ak+ah*ah;if(af>0){af=1/Math.sqrt(af);aj[0]=ai[0]*af;aj[1]=ai[1]*af;aj[2]=ai[2]*af;aj[3]=ai[3]*af}return aj};ac.dot=function(ag,af){return ag[0]*af[0]+ag[1]*af[1]+ag[2]*af[2]+ag[3]*af[3]};ac.lerp=function(ah,ag,af,ai){var al=ag[0],ak=ag[1],aj=ag[2],am=ag[3];ah[0]=al+ai*(af[0]-al);ah[1]=ak+ai*(af[1]-ak);ah[2]=aj+ai*(af[2]-aj);ah[3]=am+ai*(af[3]-am);return ah};ac.random=function(af,ag){ag=ag||1;af[0]=aa();af[1]=aa();af[2]=aa();af[3]=aa();ac.normalize(af,af);ac.scale(af,af,ag);return af};ac.transformMat4=function(aj,ai,ag){var af=ai[0],al=ai[1],ak=ai[2],ah=ai[3];aj[0]=ag[0]*af+ag[4]*al+ag[8]*ak+ag[12]*ah;aj[1]=ag[1]*af+ag[5]*al+ag[9]*ak+ag[13]*ah;aj[2]=ag[2]*af+ag[6]*al+ag[10]*ak+ag[14]*ah;aj[3]=ag[3]*af+ag[7]*al+ag[11]*ak+ag[15]*ah;return aj};ac.transformQuat=function(al,ar,af){var at=ar[0],aq=ar[1],ap=ar[2],an=af[0],am=af[1],ak=af[2],ao=af[3],ai=ao*at+am*ap-ak*aq,ah=ao*aq+ak*at-an*ap,ag=ao*ap+an*aq-am*at,aj=-an*at-am*aq-ak*ap;al[0]=ai*ao+aj*-an+ah*-ak-ag*-am;al[1]=ah*ao+aj*-am+ag*-an-ai*-ak;al[2]=ag*ao+aj*-ak+ai*-am-ah*-an;return al};ac.forEach=function(){var af=ac.create();return function(ai,am,an,al,ak,ag){var aj,ah;if(!am){am=4}if(!an){an=0}if(al){ah=Math.min(al*am+an,ai.length)}else{ah=ai.length}for(aj=an;aj<ah;aj+=am){af[0]=ai[aj];af[1]=ai[aj+1];af[2]=ai[aj+2];af[3]=ai[aj+3];ak(af,af,ag);ai[aj]=af[0];ai[aj+1]=af[1];ai[aj+2]=af[2];ai[aj+3]=af[3]}return ai}}();ac.str=function(af){return"vec4("+af[0]+", "+af[1]+", "+af[2]+", "+af[3]+")"};ab.vec4=ac;var X={};X.create=function(){var af=new W(9);af[0]=1;af[1]=0;af[2]=0;af[3]=0;af[4]=1;af[5]=0;af[6]=0;af[7]=0;af[8]=1;return af};X.fromMat4=function(ag,af){ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[4];ag[4]=af[5];ag[5]=af[6];ag[6]=af[8];ag[7]=af[9];ag[8]=af[10];return ag};X.clone=function(af){var ag=new W(9);ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[3];ag[4]=af[4];ag[5]=af[5];ag[6]=af[6];ag[7]=af[7];ag[8]=af[8];return ag};X.copy=function(ag,af){ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[3];ag[4]=af[4];ag[5]=af[5];ag[6]=af[6];ag[7]=af[7];ag[8]=af[8];return ag};X.identity=function(af){af[0]=1;af[1]=0;af[2]=0;af[3]=0;af[4]=1;af[5]=0;af[6]=0;af[7]=0;af[8]=1;return af};X.transpose=function(ah,ag){if(ah===ag){var aj=ag[1],ai=ag[2],af=ag[5];ah[1]=ag[3];ah[2]=ag[6];ah[3]=aj;ah[5]=ag[7];ah[6]=ai;ah[7]=af}else{ah[0]=ag[0];ah[1]=ag[3];ah[2]=ag[6];ah[3]=ag[1];ah[4]=ag[4];ah[5]=ag[7];ah[6]=ag[2];ah[7]=ag[5];ah[8]=ag[8]}return ah};X.invert=function(aj,aq){var ai=aq[0],ah=aq[1],ag=aq[2],au=aq[3],at=aq[4],ar=aq[5],ao=aq[6],an=aq[7],al=aq[8],ak=al*at-ar*an,af=-al*au+ar*ao,ap=an*au-at*ao,am=ai*ak+ah*af+ag*ap;if(!am){return null}am=1/am;aj[0]=ak*am;aj[1]=(-al*ah+ag*an)*am;aj[2]=(ar*ah-ag*at)*am;aj[3]=af*am;aj[4]=(al*ai-ag*ao)*am;aj[5]=(-ar*ai+ag*au)*am;aj[6]=ap*am;aj[7]=(-an*ai+ah*ao)*am;aj[8]=(at*ai-ah*au)*am;return aj};X.adjoint=function(ai,am){var ah=am[0],ag=am[1],af=am[2],ap=am[3],ao=am[4],an=am[5],al=am[6],ak=am[7],aj=am[8];ai[0]=ao*aj-an*ak;ai[1]=af*ak-ag*aj;ai[2]=ag*an-af*ao;ai[3]=an*al-ap*aj;ai[4]=ah*aj-af*al;ai[5]=af*ap-ah*an;ai[6]=ap*ak-ao*al;ai[7]=ag*al-ah*ak;ai[8]=ah*ao-ag*ap;return ai};X.determinant=function(al){var ah=al[0],ag=al[1],af=al[2],ao=al[3],an=al[4],am=al[5],ak=al[6],aj=al[7],ai=al[8];return ah*(ai*an-am*aj)+ag*(-ai*ao+am*ak)+af*(aj*ao-an*ak)};X.multiply=function(ar,ax,aw){var aA=ax[0],az=ax[1],ay=ax[2],ak=ax[3],aj=ax[4],ai=ax[5],aq=ax[6],ap=ax[7],ao=ax[8],an=aw[0],am=aw[1],al=aw[2],av=aw[3],au=aw[4],at=aw[5],ah=aw[6],ag=aw[7],af=aw[8];ar[0]=an*aA+am*ak+al*aq;ar[1]=an*az+am*aj+al*ap;ar[2]=an*ay+am*ai+al*ao;ar[3]=av*aA+au*ak+at*aq;ar[4]=av*az+au*aj+at*ap;ar[5]=av*ay+au*ai+at*ao;ar[6]=ah*aA+ag*ak+af*aq;ar[7]=ah*az+ag*aj+af*ap;ar[8]=ah*ay+ag*ai+af*ao;return ar};X.mul=X.multiply;X.translate=function(ai,ao,aq){var ah=ao[0],ag=ao[1],af=ao[2],at=ao[3],ar=ao[4],ap=ao[5],al=ao[6],ak=ao[7],aj=ao[8],an=aq[0],am=aq[1];ai[0]=ah;ai[1]=ag;ai[2]=af;ai[3]=at;ai[4]=ar;ai[5]=ap;ai[6]=an*ah+am*at+al;ai[7]=an*ag+am*ar+ak;ai[8]=an*af+am*ap+aj;return ai};X.rotate=function(ai,ao,an){var ah=ao[0],ag=ao[1],af=ao[2],ar=ao[3],aq=ao[4],ap=ao[5],al=ao[6],ak=ao[7],aj=ao[8],at=Math.sin(an),am=Math.cos(an);ai[0]=am*ah+at*ar;ai[1]=am*ag+at*aq;ai[2]=am*af+at*ap;ai[3]=am*ar-at*ah;ai[4]=am*aq-at*ag;ai[5]=am*ap-at*af;ai[6]=al;ai[7]=ak;ai[8]=aj;return ai};X.fromQuat=function(ar,ap){var al=ap[0],ak=ap[1],aj=ap[2],am=ap[3],at=al+al,af=ak+ak,an=aj+aj,ai=al*at,ah=al*af,ag=al*an,aq=ak*af,ao=ak*an,aw=aj*an,ax=am*at,av=am*af,au=am*an;ar[0]=1-(aq+aw);ar[3]=ah+au;ar[6]=ag-av;ar[1]=ah-au;ar[4]=1-(ai+aw);ar[7]=ao+ax;ar[2]=ag+av;ar[5]=ao-ax;ar[8]=1-(ai+aq);return ar};X.normalFromMat4=function(az,aE){var aI=aE[0],aG=aE[1],aF=aE[2],aC=aE[3],aj=aE[4],ai=aE[5],ah=aE[6],ag=aE[7],ay=aE[8],ax=aE[9],aw=aE[10],av=aE[11],aK=aE[12],aJ=aE[13],aH=aE[14],aD=aE[15],au=aI*ai-aG*aj,at=aI*ah-aF*aj,ar=aI*ag-aC*aj,aq=aG*ah-aF*ai,ap=aG*ag-aC*ai,ao=aF*ag-aC*ah,an=ay*aJ-ax*aK,am=ay*aH-aw*aK,al=ay*aD-av*aK,ak=ax*aH-aw*aJ,aB=ax*aD-av*aJ,aA=aw*aD-av*aH,af=au*aA-at*aB+ar*ak+aq*al-ap*am+ao*an;if(!af){return null}af=1/af;az[0]=(ai*aA-ah*aB+ag*ak)*af;az[1]=(ah*al-aj*aA-ag*am)*af;az[2]=(aj*aB-ai*al+ag*an)*af;az[3]=(aF*aB-aG*aA-aC*ak)*af;az[4]=(aI*aA-aF*al+aC*am)*af;az[5]=(aG*al-aI*aB-aC*an)*af;az[6]=(aJ*ao-aH*ap+aD*aq)*af;az[7]=(aH*ar-aK*ao-aD*at)*af;az[8]=(aK*ap-aJ*ar+aD*au)*af;return az};X.str=function(af){return"mat3("+af[0]+", "+af[1]+", "+af[2]+", "+af[3]+", "+af[4]+", "+af[5]+", "+af[6]+", "+af[7]+", "+af[8]+")"};ab.mat3=X;var V={};V.create=function(){var af=new W(16);af[0]=1;af[1]=0;af[2]=0;af[3]=0;af[4]=0;af[5]=1;af[6]=0;af[7]=0;af[8]=0;af[9]=0;af[10]=1;af[11]=0;af[12]=0;af[13]=0;af[14]=0;af[15]=1;return af};V.fromValues=function(aw,an,ai,av,au,am,ah,at,ar,al,ag,aq,ap,ak,af,ao){var aj=new W(16);aj[0]=aw;aj[1]=an;aj[2]=ai,aj[3]=av;aj[4]=au;aj[5]=am;aj[6]=ah;aj[7]=at;aj[8]=ar;aj[9]=al;aj[10]=ag;aj[11]=aq;aj[12]=ap;aj[13]=ak;aj[14]=af;aj[15]=ao;return aj};V.clone=function(af){var ag=new W(16);ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[3];ag[4]=af[4];ag[5]=af[5];ag[6]=af[6];ag[7]=af[7];ag[8]=af[8];ag[9]=af[9];ag[10]=af[10];ag[11]=af[11];ag[12]=af[12];ag[13]=af[13];ag[14]=af[14];ag[15]=af[15];return ag};V.copy=function(ag,af){ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=af[3];ag[4]=af[4];ag[5]=af[5];ag[6]=af[6];ag[7]=af[7];ag[8]=af[8];ag[9]=af[9];ag[10]=af[10];ag[11]=af[11];ag[12]=af[12];ag[13]=af[13];ag[14]=af[14];ag[15]=af[15];return ag};V.identity=function(af){af[0]=1;af[1]=0;af[2]=0;af[3]=0;af[4]=0;af[5]=1;af[6]=0;af[7]=0;af[8]=0;af[9]=0;af[10]=1;af[11]=0;af[12]=0;af[13]=0;af[14]=0;af[15]=1;return af};V.transpose=function(ai,ah){if(ai===ah){var am=ah[1],ak=ah[2],aj=ah[3],af=ah[6],al=ah[7],ag=ah[11];ai[1]=ah[4];ai[2]=ah[8];ai[3]=ah[12];ai[4]=am;ai[6]=ah[9];ai[7]=ah[13];ai[8]=ak;ai[9]=af;ai[11]=ah[14];ai[12]=aj;ai[13]=al;ai[14]=ag}else{ai[0]=ah[0];ai[1]=ah[4];ai[2]=ah[8];ai[3]=ah[12];ai[4]=ah[1];ai[5]=ah[5];ai[6]=ah[9];ai[7]=ah[13];ai[8]=ah[2];ai[9]=ah[6];ai[10]=ah[10];ai[11]=ah[14];ai[12]=ah[3];ai[13]=ah[7];ai[14]=ah[11];ai[15]=ah[15]}return ai};V.invert=function(az,aE){var aI=aE[0],aG=aE[1],aF=aE[2],aC=aE[3],aj=aE[4],ai=aE[5],ah=aE[6],ag=aE[7],ay=aE[8],ax=aE[9],aw=aE[10],av=aE[11],aK=aE[12],aJ=aE[13],aH=aE[14],aD=aE[15],au=aI*ai-aG*aj,at=aI*ah-aF*aj,ar=aI*ag-aC*aj,aq=aG*ah-aF*ai,ap=aG*ag-aC*ai,ao=aF*ag-aC*ah,an=ay*aJ-ax*aK,am=ay*aH-aw*aK,al=ay*aD-av*aK,ak=ax*aH-aw*aJ,aB=ax*aD-av*aJ,aA=aw*aD-av*aH,af=au*aA-at*aB+ar*ak+aq*al-ap*am+ao*an;if(!af){return null}af=1/af;az[0]=(ai*aA-ah*aB+ag*ak)*af;az[1]=(aF*aB-aG*aA-aC*ak)*af;az[2]=(aJ*ao-aH*ap+aD*aq)*af;az[3]=(aw*ap-ax*ao-av*aq)*af;az[4]=(ah*al-aj*aA-ag*am)*af;az[5]=(aI*aA-aF*al+aC*am)*af;az[6]=(aH*ar-aK*ao-aD*at)*af;az[7]=(ay*ao-aw*ar+av*at)*af;az[8]=(aj*aB-ai*al+ag*an)*af;az[9]=(aG*al-aI*aB-aC*an)*af;az[10]=(aK*ap-aJ*ar+aD*au)*af;az[11]=(ax*ar-ay*ap-av*au)*af;az[12]=(ai*am-aj*ak-ah*an)*af;az[13]=(aI*ak-aG*am+aF*an)*af;az[14]=(aJ*at-aK*aq-aH*au)*af;az[15]=(ay*aq-ax*at+aw*au)*af;return az};V.adjoint=function(an,aq){var av=aq[0],at=aq[1],ar=aq[2],ao=aq[3],ai=aq[4],ah=aq[5],ag=aq[6],af=aq[7],am=aq[8],al=aq[9],ak=aq[10],aj=aq[11],ax=aq[12],aw=aq[13],au=aq[14],ap=aq[15];an[0]=ah*(ak*ap-aj*au)-al*(ag*ap-af*au)+aw*(ag*aj-af*ak);an[1]=-(at*(ak*ap-aj*au)-al*(ar*ap-ao*au)+aw*(ar*aj-ao*ak));an[2]=at*(ag*ap-af*au)-ah*(ar*ap-ao*au)+aw*(ar*af-ao*ag);an[3]=-(at*(ag*aj-af*ak)-ah*(ar*aj-ao*ak)+al*(ar*af-ao*ag));an[4]=-(ai*(ak*ap-aj*au)-am*(ag*ap-af*au)+ax*(ag*aj-af*ak));an[5]=av*(ak*ap-aj*au)-am*(ar*ap-ao*au)+ax*(ar*aj-ao*ak);an[6]=-(av*(ag*ap-af*au)-ai*(ar*ap-ao*au)+ax*(ar*af-ao*ag));an[7]=av*(ag*aj-af*ak)-ai*(ar*aj-ao*ak)+am*(ar*af-ao*ag);an[8]=ai*(al*ap-aj*aw)-am*(ah*ap-af*aw)+ax*(ah*aj-af*al);an[9]=-(av*(al*ap-aj*aw)-am*(at*ap-ao*aw)+ax*(at*aj-ao*al));an[10]=av*(ah*ap-af*aw)-ai*(at*ap-ao*aw)+ax*(at*af-ao*ah);an[11]=-(av*(ah*aj-af*al)-ai*(at*aj-ao*al)+am*(at*af-ao*ah));an[12]=-(ai*(al*au-ak*aw)-am*(ah*au-ag*aw)+ax*(ah*ak-ag*al));an[13]=av*(al*au-ak*aw)-am*(at*au-ar*aw)+ax*(at*ak-ar*al);an[14]=-(av*(ah*au-ag*aw)-ai*(at*au-ar*aw)+ax*(at*ag-ar*ah));an[15]=av*(ah*ak-ag*al)-ai*(at*ak-ar*al)+am*(at*ag-ar*ah);return an};V.determinant=function(aB){var aG=aB[0],aE=aB[1],aC=aB[2],aA=aB[3],ai=aB[4],ah=aB[5],ag=aB[6],af=aB[7],ax=aB[8],aw=aB[9],av=aB[10],au=aB[11],aI=aB[12],aH=aB[13],aF=aB[14],aD=aB[15],at=aG*ah-aE*ai,ar=aG*ag-aC*ai,aq=aG*af-aA*ai,ap=aE*ag-aC*ah,ao=aE*af-aA*ah,an=aC*af-aA*ag,am=ax*aH-aw*aI,al=ax*aF-av*aI,ak=ax*aD-au*aI,aj=aw*aF-av*aH,az=aw*aD-au*aH,ay=av*aD-au*aF;return at*ay-ar*az+aq*aj+ap*ak-ao*al+an*am};V.multiply=function(ar,aw,at){var aA=aw[0],az=aw[1],ax=aw[2],au=aw[3],al=aw[4],aj=aw[5],ah=aw[6],af=aw[7],aq=aw[8],ap=aw[9],ao=aw[10],an=aw[11],aC=aw[12],aB=aw[13],ay=aw[14],av=aw[15];var am=at[0],ak=at[1],ai=at[2],ag=at[3];ar[0]=am*aA+ak*al+ai*aq+ag*aC;ar[1]=am*az+ak*aj+ai*ap+ag*aB;ar[2]=am*ax+ak*ah+ai*ao+ag*ay;ar[3]=am*au+ak*af+ai*an+ag*av;am=at[4];ak=at[5];ai=at[6];ag=at[7];ar[4]=am*aA+ak*al+ai*aq+ag*aC;ar[5]=am*az+ak*aj+ai*ap+ag*aB;ar[6]=am*ax+ak*ah+ai*ao+ag*ay;ar[7]=am*au+ak*af+ai*an+ag*av;am=at[8];ak=at[9];ai=at[10];ag=at[11];ar[8]=am*aA+ak*al+ai*aq+ag*aC;ar[9]=am*az+ak*aj+ai*ap+ag*aB;ar[10]=am*ax+ak*ah+ai*ao+ag*ay;ar[11]=am*au+ak*af+ai*an+ag*av;am=at[12];ak=at[13];ai=at[14];ag=at[15];ar[12]=am*aA+ak*al+ai*aq+ag*aC;ar[13]=am*az+ak*aj+ai*ap+ag*aB;ar[14]=am*ax+ak*ah+ai*ao+ag*ay;ar[15]=am*au+ak*af+ai*an+ag*av;return ar};V.fromMat3=function(ag,af){ag[0]=af[0];ag[1]=af[1];ag[2]=af[2];ag[3]=0;ag[4]=af[3];ag[5]=af[4];ag[6]=af[5];ag[7]=0;ag[8]=af[6];ag[9]=af[7];ag[10]=af[8];ag[11]=0;ag[12]=0;ag[13]=0;ag[14]=0;ag[15]=1;return ag};V.mul=V.multiply;V.translate=function(ar,au,am){var al=am[0],ak=am[1],aj=am[2],ax,aw,av,at,ai,ah,ag,af,aq,ap,ao,an;if(au===ar){ar[12]=au[0]*al+au[4]*ak+au[8]*aj+au[12];ar[13]=au[1]*al+au[5]*ak+au[9]*aj+au[13];ar[14]=au[2]*al+au[6]*ak+au[10]*aj+au[14];ar[15]=au[3]*al+au[7]*ak+au[11]*aj+au[15]}else{ax=au[0];aw=au[1];av=au[2];at=au[3];ai=au[4];ah=au[5];ag=au[6];af=au[7];aq=au[8];ap=au[9];ao=au[10];an=au[11];ar[0]=ax;ar[1]=aw;ar[2]=av;ar[3]=at;ar[4]=ai;ar[5]=ah;ar[6]=ag;ar[7]=af;ar[8]=aq;ar[9]=ap;ar[10]=ao;ar[11]=an;ar[12]=ax*al+ai*ak+aq*aj+au[12];ar[13]=aw*al+ah*ak+ap*aj+au[13];ar[14]=av*al+ag*ak+ao*aj+au[14];ar[15]=at*al+af*ak+an*aj+au[15]}return ar};V.scale=function(ai,ag,ah){var af=ah[0],ak=ah[1],aj=ah[2];ai[0]=ag[0]*af;ai[1]=ag[1]*af;ai[2]=ag[2]*af;ai[3]=ag[3]*af;ai[4]=ag[4]*ak;ai[5]=ag[5]*ak;ai[6]=ag[6]*ak;ai[7]=ag[7]*ak;ai[8]=ag[8]*aj;ai[9]=ag[9]*aj;ai[10]=ag[10]*aj;ai[11]=ag[11]*aj;ai[12]=ag[12];ai[13]=ag[13];ai[14]=ag[14];ai[15]=ag[15];return ai};V.rotate=function(aA,aH,aJ,af){var ap=af[0],ao=af[1],an=af[2],aB=Math.sqrt(ap*ap+ao*ao+an*an),av,aF,au,aL,aK,aI,aG,am,al,ak,aj,az,ay,ax,aw,at,ar,aq,aE,aD,aC,ai,ah,ag;if(Math.abs(aB)<ae){return null}aB=1/aB;ap*=aB;ao*=aB;an*=aB;av=Math.sin(aJ);aF=Math.cos(aJ);au=1-aF;aL=aH[0];aK=aH[1];aI=aH[2];aG=aH[3];am=aH[4];al=aH[5];ak=aH[6];aj=aH[7];az=aH[8];ay=aH[9];ax=aH[10];aw=aH[11];at=ap*ap*au+aF;ar=ao*ap*au+an*av;aq=an*ap*au-ao*av;aE=ap*ao*au-an*av;aD=ao*ao*au+aF;aC=an*ao*au+ap*av;ai=ap*an*au+ao*av;ah=ao*an*au-ap*av;ag=an*an*au+aF;aA[0]=aL*at+am*ar+az*aq;aA[1]=aK*at+al*ar+ay*aq;aA[2]=aI*at+ak*ar+ax*aq;aA[3]=aG*at+aj*ar+aw*aq;aA[4]=aL*aE+am*aD+az*aC;aA[5]=aK*aE+al*aD+ay*aC;aA[6]=aI*aE+ak*aD+ax*aC;aA[7]=aG*aE+aj*aD+aw*aC;aA[8]=aL*ai+am*ah+az*ag;aA[9]=aK*ai+al*ah+ay*ag;aA[10]=aI*ai+ak*ah+ax*ag;aA[11]=aG*ai+aj*ah+aw*ag;if(aH!==aA){aA[12]=aH[12];aA[13]=aH[13];aA[14]=aH[14];aA[15]=aH[15]}return aA};V.rotateX=function(af,am,al){var ar=Math.sin(al),ak=Math.cos(al),aq=am[4],ap=am[5],ao=am[6],an=am[7],aj=am[8],ai=am[9],ah=am[10],ag=am[11];if(am!==af){af[0]=am[0];af[1]=am[1];af[2]=am[2];af[3]=am[3];af[12]=am[12];af[13]=am[13];af[14]=am[14];af[15]=am[15]}af[4]=aq*ak+aj*ar;af[5]=ap*ak+ai*ar;af[6]=ao*ak+ah*ar;af[7]=an*ak+ag*ar;af[8]=aj*ak-aq*ar;af[9]=ai*ak-ap*ar;af[10]=ah*ak-ao*ar;af[11]=ag*ak-an*ar;return af};V.rotateY=function(aj,aq,ap){var ar=Math.sin(ap),ao=Math.cos(ap),ai=aq[0],ah=aq[1],ag=aq[2],af=aq[3],an=aq[8],am=aq[9],al=aq[10],ak=aq[11];if(aq!==aj){aj[4]=aq[4];aj[5]=aq[5];aj[6]=aq[6];aj[7]=aq[7];aj[12]=aq[12];aj[13]=aq[13];aj[14]=aq[14];aj[15]=aq[15]}aj[0]=ai*ao-an*ar;aj[1]=ah*ao-am*ar;aj[2]=ag*ao-al*ar;aj[3]=af*ao-ak*ar;aj[8]=ai*ar+an*ao;aj[9]=ah*ar+am*ao;aj[10]=ag*ar+al*ao;aj[11]=af*ar+ak*ao;return aj};V.rotateZ=function(aj,am,al){var ar=Math.sin(al),ak=Math.cos(al),ai=am[0],ah=am[1],ag=am[2],af=am[3],aq=am[4],ap=am[5],ao=am[6],an=am[7];if(am!==aj){aj[8]=am[8];aj[9]=am[9];aj[10]=am[10];aj[11]=am[11];aj[12]=am[12];aj[13]=am[13];aj[14]=am[14];aj[15]=am[15]}aj[0]=ai*ak+aq*ar;aj[1]=ah*ak+ap*ar;aj[2]=ag*ak+ao*ar;aj[3]=af*ak+an*ar;aj[4]=aq*ak-ai*ar;aj[5]=ap*ak-ah*ar;aj[6]=ao*ak-ag*ar;aj[7]=an*ak-af*ar;return aj};V.fromRotationTranslation=function(at,aq,ao){var al=aq[0],ak=aq[1],aj=aq[2],am=aq[3],au=al+al,af=ak+ak,an=aj+aj,ai=al*au,ah=al*af,ag=al*an,ar=ak*af,ap=ak*an,ax=aj*an,ay=am*au,aw=am*af,av=am*an;at[0]=1-(ar+ax);at[1]=ah+av;at[2]=ag-aw;at[3]=0;at[4]=ah-av;at[5]=1-(ai+ax);at[6]=ap+ay;at[7]=0;at[8]=ag+aw;at[9]=ap-ay;at[10]=1-(ai+ar);at[11]=0;at[12]=ao[0];at[13]=ao[1];at[14]=ao[2];at[15]=1;return at};V.fromQuat=function(ar,ap){var al=ap[0],ak=ap[1],aj=ap[2],am=ap[3],at=al+al,af=ak+ak,an=aj+aj,ai=al*at,ah=al*af,ag=al*an,aq=ak*af,ao=ak*an,aw=aj*an,ax=am*at,av=am*af,au=am*an;ar[0]=1-(aq+aw);ar[1]=ah+au;ar[2]=ag-av;ar[3]=0;ar[4]=ah-au;ar[5]=1-(ai+aw);ar[6]=ao+ax;ar[7]=0;ar[8]=ag+av;ar[9]=ao-ax;ar[10]=1-(ai+aq);ar[11]=0;ar[12]=0;ar[13]=0;ar[14]=0;ar[15]=1;return ar};V.frustum=function(aj,ag,ao,af,an,al,ak){var am=1/(ao-ag),ai=1/(an-af),ah=1/(al-ak);aj[0]=al*2*am;aj[1]=0;aj[2]=0;aj[3]=0;aj[4]=0;aj[5]=al*2*ai;aj[6]=0;aj[7]=0;aj[8]=(ao+ag)*am;aj[9]=(an+af)*ai;aj[10]=(ak+al)*ah;aj[11]=-1;aj[12]=0;aj[13]=0;aj[14]=ak*al*2*ah;aj[15]=0;return aj};V.perspective=function(ai,ah,ag,aj,af){var al=1/Math.tan(ah/2),ak=1/(aj-af);ai[0]=al/ag;ai[1]=0;ai[2]=0;ai[3]=0;ai[4]=0;ai[5]=al;ai[6]=0;ai[7]=0;ai[8]=0;ai[9]=0;ai[10]=(af+aj)*ak;ai[11]=-1;ai[12]=0;ai[13]=0;ai[14]=2*af*aj*ak;ai[15]=0;return ai};V.ortho=function(ai,ag,ao,af,am,al,ak){var aj=1/(ag-ao),an=1/(af-am),ah=1/(al-ak);ai[0]=-2*aj;ai[1]=0;ai[2]=0;ai[3]=0;ai[4]=0;ai[5]=-2*an;ai[6]=0;ai[7]=0;ai[8]=0;ai[9]=0;ai[10]=2*ah;ai[11]=0;ai[12]=(ag+ao)*aj;ai[13]=(am+af)*an;ai[14]=(ak+al)*ah;ai[15]=1;return ai};V.lookAt=function(au,aB,aC,al){var aA,az,ax,ah,ag,af,ao,an,am,av,ay=aB[0],aw=aB[1],at=aB[2],ak=al[0],aj=al[1],ai=al[2],ar=aC[0],aq=aC[1],ap=aC[2];if(Math.abs(ay-ar)<ae&&Math.abs(aw-aq)<ae&&Math.abs(at-ap)<ae){return V.identity(au)}ao=ay-ar;an=aw-aq;am=at-ap;av=1/Math.sqrt(ao*ao+an*an+am*am);ao*=av;an*=av;am*=av;aA=aj*am-ai*an;az=ai*ao-ak*am;ax=ak*an-aj*ao;av=Math.sqrt(aA*aA+az*az+ax*ax);if(!av){aA=0;az=0;ax=0}else{av=1/av;aA*=av;az*=av;ax*=av}ah=an*ax-am*az;ag=am*aA-ao*ax;af=ao*az-an*aA;av=Math.sqrt(ah*ah+ag*ag+af*af);if(!av){ah=0;ag=0;af=0}else{av=1/av;ah*=av;ag*=av;af*=av}au[0]=aA;au[1]=ah;au[2]=ao;au[3]=0;au[4]=az;au[5]=ag;au[6]=an;au[7]=0;au[8]=ax;au[9]=af;au[10]=am;au[11]=0;au[12]=-(aA*ay+az*aw+ax*at);au[13]=-(ah*ay+ag*aw+af*at);au[14]=-(ao*ay+an*aw+am*at);au[15]=1;return au};V.str=function(af){return"mat4("+af[0]+", "+af[1]+", "+af[2]+", "+af[3]+", "+af[4]+", "+af[5]+", "+af[6]+", "+af[7]+", "+af[8]+", "+af[9]+", "+af[10]+", "+af[11]+", "+af[12]+", "+af[13]+", "+af[14]+", "+af[15]+")"};ab.mat4=V;var Z={};Z.create=function(){var af=new W(4);af[0]=0;af[1]=0;af[2]=0;af[3]=1;return af};Z.rotationTo=function(){var af=ad.create();var ag=ad.fromValues(1,0,0);var ah=ad.fromValues(0,1,0);return function(al,aj,ai){var ak=ad.dot(aj,ai);if(ak<-0.999999){ad.cross(af,ag,aj);if(ad.length(af)<0.000001){ad.cross(af,ah,aj)}ad.normalize(af,af);Z.setAxisAngle(al,af,Math.PI);return al}else{if(ak>0.999999){al[0]=0;al[1]=0;al[2]=0;al[3]=1;return al}else{ad.cross(af,aj,ai);al[0]=af[0];al[1]=af[1];al[2]=af[2];al[3]=1+ak;return Z.normalize(al,al)}}}}();Z.setAxes=function(){var af=X.create();return function(ai,ah,aj,ag){af[0]=aj[0];af[3]=aj[1];af[6]=aj[2];af[1]=ag[0];af[4]=ag[1];af[7]=ag[2];af[2]=ah[0];af[5]=ah[1];af[8]=ah[2];return Z.normalize(ai,Z.fromMat3(ai,af))}}();Z.clone=ac.clone;Z.fromValues=ac.fromValues;Z.copy=ac.copy;Z.set=ac.set;Z.identity=function(af){af[0]=0;af[1]=0;af[2]=0;af[3]=1;return af};Z.setAxisAngle=function(ag,ai,af){af=af*0.5;var ah=Math.sin(af);ag[0]=ah*ai[0];ag[1]=ah*ai[1];ag[2]=ah*ai[2];ag[3]=Math.cos(af);return ag};Z.add=ac.add;Z.multiply=function(ah,an,am){var af=an[0],ap=an[1],ao=an[2],ag=an[3],ak=am[0],aj=am[1],ai=am[2],al=am[3];ah[0]=af*al+ag*ak+ap*ai-ao*aj;ah[1]=ap*al+ag*aj+ao*ak-af*ai;ah[2]=ao*al+ag*ai+af*aj-ap*ak;ah[3]=ag*al-af*ak-ap*aj-ao*ai;return ah};Z.mul=Z.multiply;Z.scale=ac.scale;Z.rotateX=function(ah,al,aj){aj*=0.5;var af=al[0],an=al[1],am=al[2],ag=al[3],ai=Math.sin(aj),ak=Math.cos(aj);ah[0]=af*ak+ag*ai;ah[1]=an*ak+am*ai;ah[2]=am*ak-an*ai;ah[3]=ag*ak-af*ai;return ah};Z.rotateY=function(ah,al,aj){aj*=0.5;var af=al[0],an=al[1],am=al[2],ag=al[3],ai=Math.sin(aj),ak=Math.cos(aj);ah[0]=af*ak-am*ai;ah[1]=an*ak+ag*ai;ah[2]=am*ak+af*ai;ah[3]=ag*ak-an*ai;return ah};Z.rotateZ=function(ah,al,aj){aj*=0.5;var af=al[0],an=al[1],am=al[2],ag=al[3],ai=Math.sin(aj),ak=Math.cos(aj);ah[0]=af*ak+an*ai;ah[1]=an*ak-af*ai;ah[2]=am*ak+ag*ai;ah[3]=ag*ak-am*ai;return ah};Z.calculateW=function(ah,ag){var af=ag[0],aj=ag[1],ai=ag[2];ah[0]=af;ah[1]=aj;ah[2]=ai;ah[3]=-Math.sqrt(Math.abs(1-af*af-aj*aj-ai*ai));return ah};Z.dot=ac.dot;Z.lerp=ac.lerp;Z.slerp=function(aj,ar,aq,av){var af=ar[0],aA=ar[1],au=ar[2],ah=ar[3],ao=aq[0],an=aq[1],am=aq[2],ap=aq[3];var at,ag,ai,al,ak;ag=af*ao+aA*an+au*am+ah*ap;if(ag<0){ag=-ag;ao=-ao;an=-an;am=-am;ap=-ap}if(1-ag>0.000001){at=Math.acos(ag);ai=Math.sin(at);al=Math.sin((1-av)*at)/ai;ak=Math.sin(av*at)/ai}else{al=1-av;ak=av}aj[0]=al*af+ak*ao;aj[1]=al*aA+ak*an;aj[2]=al*au+ak*am;aj[3]=al*ah+ak*ap;return aj};Z.invert=function(al,ah){var aj=ah[0],ag=ah[1],af=ah[2],am=ah[3],ai=aj*aj+ag*ag+af*af+am*am,ak=ai?1/ai:0;al[0]=-aj*ak;al[1]=-ag*ak;al[2]=-af*ak;al[3]=am*ak;return al};Z.conjugate=function(ag,af){ag[0]=-af[0];ag[1]=-af[1];ag[2]=-af[2];ag[3]=af[3];return ag};Z.length=ac.length;Z.len=Z.length;Z.squaredLength=ac.squaredLength;Z.sqrLen=Z.squaredLength;Z.normalize=ac.normalize;Z.fromMat3=function(){var af=typeof Int8Array!=="undefined"?new Int8Array([1,2,0]):[1,2,0];return function(ak,ag){var ah=ag[0]+ag[4]+ag[8];var am;if(ah>0){am=Math.sqrt(ah+1);ak[3]=0.5*am;am=0.5/am;ak[0]=(ag[7]-ag[5])*am;ak[1]=(ag[2]-ag[6])*am;ak[2]=(ag[3]-ag[1])*am}else{var al=0;if(ag[4]>ag[0]){al=1}if(ag[8]>ag[al*3+al]){al=2}var aj=af[al];var ai=af[aj];am=Math.sqrt(ag[al*3+al]-ag[aj*3+aj]-ag[ai*3+ai]+1);ak[al]=0.5*am;am=0.5/am;ak[3]=(ag[ai*3+aj]-ag[aj*3+ai])*am;ak[aj]=(ag[aj*3+al]+ag[al*3+aj])*am;ak[ai]=(ag[ai*3+al]+ag[al*3+ai])*am}return ak}}();Z.str=function(af){return"quat("+af[0]+", "+af[1]+", "+af[2]+", "+af[3]+")"};ab.quat=Z;return ab}();w=function(){var X=o.vec4;var W={};W.rgb={};var ab=W.rgb;W.rgb.create=X.create;W.rgb.scale=X.scale;W.rgb.copy=X.copy;W.rgb.fromValues=X.fromValues;W.rgb.mix=function(ai,al,ak,aj){var ah=1-aj;ai[0]=al[0]*aj+ak[0]*ah;ai[1]=al[1]*aj+ak[1]*ah;ai[2]=al[2]*aj+ak[2]*ah;ai[3]=al[3]*aj+ak[3]*ah;return ai};var ac={white:ab.fromValues(1,1,1,1),black:ab.fromValues(0,0,0,1),grey:ab.fromValues(0.5,0.5,0.5,1),lightgrey:ab.fromValues(0.8,0.8,0.8,1),darkgrey:ab.fromValues(0.3,0.3,0.3,1),red:ab.fromValues(1,0,0,1),darkred:ab.fromValues(0.5,0,0,1),lightred:ab.fromValues(1,0.5,0.5,1),green:ab.fromValues(0,1,0,1),darkgreen:ab.fromValues(0,0.5,0,1),lightgreen:ab.fromValues(0.5,1,0.5,1),blue:ab.fromValues(0,0,1,1),darkblue:ab.fromValues(0,0,0.5,1),lightblue:ab.fromValues(0.5,0.5,1,1),yellow:ab.fromValues(1,1,0,1),darkyellow:ab.fromValues(0.5,0.5,0,1),lightyellow:ab.fromValues(1,1,0.5,1),cyan:ab.fromValues(0,1,1,1),darkcyan:ab.fromValues(0,0.5,0.5,1),lightcyan:ab.fromValues(0.5,1,1,1),magenta:ab.fromValues(1,0,1,1),darkmagenta:ab.fromValues(0.5,0,0.5,1),lightmagenta:ab.fromValues(1,0.5,1,1),orange:ab.fromValues(1,0.5,0,1),darkorange:ab.fromValues(0.5,0.25,0,1),lightorange:ab.fromValues(1,0.75,0.5,1)};W.hex2rgb=function(aj){var an,am,ah,ai;if(aj.length===4||aj.length===5){an=parseInt(aj[1],16);am=parseInt(aj[2],16);ah=parseInt(aj[3],16);ai=15;if(aj.length===5){ai=parseInt(aj[4],16)}var al=1/15;return ab.fromValues(al*an,al*am,al*ah,al*ai)}if(aj.length===7||aj.length===9){an=parseInt(aj.substr(1,2),16);am=parseInt(aj.substr(3,2),16);ah=parseInt(aj.substr(5,2),16);ai=255;if(aj.length===9){ai=parseInt(aj.substr(7,2),16)}var ak=1/255;return ab.fromValues(ak*an,ak*am,ak*ah,ak*ai)}};W.setColorPalette=function(ah){console.log("setting colors");ac=ah;W.initGradients()};W.forceRGB=function(ah){if(typeof ah==="string"){var ai=ac[ah];if(ai!==undefined){return ai}if(ah.length>0&&ah[0]==="#"){return W.hex2rgb(ah)}}if(ah.length===3){return[ah[0],ah[1],ah[2],1]}return ah};function Y(ah,aj){this._colors=ah;for(var ai=0;ai<this._colors.length;++ai){this._colors[ai]=W.forceRGB(this._colors[ai])}this._stops=aj}Y.prototype={colorAt:function(aj,ao){if(ao<=this._stops[0]){return X.copy(aj,this._colors[0])}if(ao>=this._stops[this._stops.length-1]){return X.copy(aj,this._colors[this._stops.length-1])}var an=0;for(var al=1;al<this._stops.length;++al){if(this._stops[al]>ao){break}an=al}var am=an+1;var ai=this._stops[an];var ah=this._stops[am];var ak=(ao-ai)/(ah-ai);return ab.mix(aj,this._colors[am],this._colors[an],ak)}};var af={};W.gradient=function(ah,aj){if(typeof ah==="string"){return af[ah]}aj=aj||"equal";if(aj==="equal"){aj=[];for(var ai=0;ai<ah.length;++ai){aj.push(ai*1/(ah.length-1))}}return new Y(ah,aj)};var ad=W.gradient;W.initGradients=function(){af.rainbow=ad(["red","yellow","green","blue"]);af.reds=ad(["lightred","darkred"]);af.greens=ad(["lightgreen","darkgreen"]);af.blues=ad(["lightblue","darkblue"]);af.trafficlight=ad(["green","yellow","red"]);af.heatmap=ad(["red","white","blue"])};function aa(ai,aj,ah){this.colorFor=ai;this._beginFunc=aj;this._endFunc=ah}aa.prototype={begin:function(ah){if(this._beginFunc){this._beginFunc(ah)}},end:function(ah){if(this._endFunc){this._endFunc(ah)}}};W.ColorOp=aa;W.uniform=function(ah){ah=W.forceRGB(ah||"white");return new aa(function(ak,aj,ai){aj[ai+0]=ah[0];aj[ai+1]=ah[1];aj[ai+2]=ah[2];aj[ai+3]=ah[3]},null,null)};var ag={H:[1,1,1],C:[0.83,0.83,0.83],N:[0.13,0.2,1],O:[1,0.13,0],F:[0.12,0.94,0.12],CL:[0.12,0.94,0.12],BR:[0.6,0.13,0],I:[0.4,0,0.73],HE:[0,1,1],NE:[0,1,1],AR:[0,1,1],XE:[0,1,1],KR:[0,1,1],P:[1,0.6,0],S:[0.87,0.87,0],B:[1,0.67,0.47],LI:[0.47,0,1],NA:[0.47,0,1],K:[0.47,0,1],RB:[0.47,0,1],CS:[0.47,0,1],FR:[0.47,0,1],BE:[0,0.47,0],MG:[0,0.47,0],SR:[0,0.47,0],BA:[0,0.47,0],RA:[0,0.47,0],TI:[0.6,0.6,0.6],FE:[0.87,0.47,0]};W.byElement=function(){return new aa(function(ak,aj,ai){var al=ak.element();var ah=ag[al];if(ah!==undefined){aj[ai]=ah[0];aj[ai+1]=ah[1];aj[ai+2]=ah[2];aj[ai+3]=1;return aj}aj[ai]=1;aj[ai+1]=0;aj[ai+2]=1;aj[ai+3]=1;return aj},null,null)};W.bySS=function(){return new aa(function(aj,ai,ah){switch(aj.residue().ss()){case"C":ai[ah]=0.8;ai[ah+1]=0.8;ai[ah+2]=0.8;ai[ah+3]=1;return;case"H":ai[ah]=0.6;ai[ah+1]=0.6;ai[ah+2]=0.9;ai[ah+3]=1;return;case"E":ai[ah]=0.2;ai[ah+1]=0.8;ai[ah+2]=0.2;ai[ah+3]=1;return}},null,null)};W.rainbow=function(ai){if(!ai){ai=ad("rainbow")}var ah=new aa(function(al,ao,an){var ap=0;var am=this.chainLimits[al.residue().chain().name()];if(am!==undefined){var ak=al.residue().index();ap=(ak-am[0])/(am[1]-am[0])}var aj=[1,1,1,1];ai.colorAt(aj,ap);ao[an]=aj[0];ao[an+1]=aj[1];ao[an+2]=aj[2];ao[an+3]=aj[3]},function(ap){var ao=ap.chains();this.chainLimits={};for(var am=0;am<ao.length;++am){var aq=ao[am].backboneTraces();if(aq.length===0){continue}var ak=aq[0].residueAt(0).index(),al=aq[0].residueAt(aq[0].length()-1).index();for(var aj=1;aj<aq.length;++aj){var an=aq[aj];ak=Math.min(ak,an.residueAt(0).index());al=Math.max(al,an.residueAt(an.length()-1).index())}if(ak!==al){this.chainLimits[ao[am].name()]=[ak,al]}}},function(){this.chainLimits=null});return ah};W.ssSuccession=function(aj,ah){if(!aj){aj=ad("rainbow")}if(!ah){ah=W.forceRGB("lightgrey")}var ai=new aa(function(am,aq,ap){var al=am.residue().index();var ao=this.chainLimits[am.residue().chain().name()];var an=ao.indices[al];if(an===-1){aq[ap]=ah[0];aq[ap+1]=ah[1];aq[ap+2]=ah[2];aq[ap+3]=ah[3];return}var ar=0;if(ao.max===null){}if(ao.max!==null){ar=an/(ao.max>0?ao.max:1)}var ak=[0,0,0,0];aj.colorAt(ak,ar);aq[ap]=ak[0];aq[ap+1]=ak[1];aq[ap+2]=ak[2];aq[ap+3]=ak[3]},function(an){var aq=an.chains();this.chainLimits={};for(var ao=0;ao<aq.length;++ao){var ar=aq[ao].residues();var al=null;var at={};var ak=0;var ap="C";for(var am=0;am<ar.length;++am){var au=ar[am].ss();if(au==="C"){if(ap!=="C"){ak++}at[ar[am].index()]=-1}else{al=ak;at[ar[am].index()]=ak}ap=au}this.chainLimits[aq[ao].name()]={indices:at,max:al}}},function(){this.chainLimits=null});return ai};W.byChain=function(ai){if(!ai){ai=ad("rainbow")}var ah=new aa(function(ak,am,al){var ao=this.chainIndices[ak.residue().chain().name()];var an=ao*this.scale;var aj=[0,0,0,0];ai.colorAt(aj,an);am[al+0]=aj[0];am[al+1]=aj[1];am[al+2]=aj[2];am[al+3]=aj[3]},function(al){var ak=al.chains();this.chainIndices={};for(var aj=0;aj<ak.length;++aj){this.chainIndices[ak[aj].name()]=aj}this.scale=ak.length>1?1/(ak.length-1):1},function(){this.chainIndices=null});return ah};function V(al,ai,ak){var aj=null;var ah=null;al[ai](function(am){var an=am.prop(ak);if(aj===null&&ah===null){aj=ah=an;return}aj=Math.min(aj,an);ah=Math.max(ah,an)});return{min:aj,max:ah}}var Z=function(){var ah=X.create();return function(aj,ai,al,ak){al.colorAt(ah,ak);aj[ai+0]=ah[0];aj[ai+1]=ah[1];aj[ai+2]=ah[2];aj[ai+3]=ah[3]}}();function ae(ak,al,ai,ah,aj){if(!al){al=ad("rainbow")}return new aa(function(am,ao,an){var ap=0;if(this._min!==this._max){ap=(aj(am).prop(ak)-this._min)/(this._max-this._min)}Z(ao,an,al,ap)},function(am){if(ai!==undefined){this._min=ai[0];this._max=ai[1];return}ai=V(am,ah,ak);this._min=ai.min;this._max=ai.max},function(){})}W.byAtomProp=function(ai,aj,ah){return ae(ai,aj,ah,"eachAtom",function(ak){return ak})};W.byResidueProp=function(ai,aj,ah){return ae(ai,aj,ah,"eachResidue",function(ak){return ak.residue()})};W.interpolateColor=function(ah,am){var aj=new Float32Array((am*(ah.length/4-1)+1)*4);var an=0;var al=X.create(),ao=X.create();var ap=1/am;for(var ak=0;ak<ah.length/4-1;++ak){X.set(al,ah[4*ak+0],ah[4*ak+1],ah[4*ak+2],ah[4*ak+3]);X.set(ao,ah[4*ak+4],ah[4*ak+5],ah[4*ak+6],ah[4*ak+7]);for(var ai=0;ai<am;++ai){var aq=ap*ai;aj[an+0]=al[0]*(1-aq)+ao[0]*aq;aj[an+1]=al[1]*(1-aq)+ao[1]*aq;aj[an+2]=al[2]*(1-aq)+ao[2]*aq;aj[an+3]=al[3]*(1-aq)+ao[3]*aq;an+=4}}aj[an+0]=ao[0];aj[an+1]=ao[1];aj[an+2]=ao[2];aj[an+3]=ao[3];return aj};W.initGradients();return W}();r=function(){function W(Y,Z,X){this._pool=Y;this._start=Z;this._next=Z;this._end=X}W.prototype={nextId:function(X){var Y=this._next;console.assert(this._next<this._end);this._next++;this._pool._objects[Y]=X;return Y},hasLeft:function(){return this._next<this._end},recycle:function(){this._pool.recycle(this)},length:function(){return this._end-this._start}};function V(){this.clear()}V.prototype={MAX_ID:16777216,getContinuousRange:function(ab){var ac=-1;var ad=null;for(var aa=0;aa<this._free.length;++aa){var ae=this._free[aa];var Y=ae.length();if(Y>=ab&&(ad===null||Y<ad)){ad=Y;ac=aa}}if(ac!==-1){var ag=this._free[ac];this._free.splice(ac,1);this._usedCount++;return ag}var X=this._unusedRangeStart;var Z=X+ab;if(Z>this.MAX_ID){console.error("not enough free object ids.");return null}this._unusedRangeStart=Z;var af=new W(this,X,Z);this._usedCount++;return af},clear:function(){this._objects={};this._unusedRangeStart=1;this._free=[];this._usedCount=0},recycle:function(X){for(var Y=X._start;Y<X._next;++Y){delete this._objects[Y]}X._next=X._start;this._free.push(X);this._usedCount--;console.assert(this._usedCount>=0);if(this._free.length>0&&this._usedCount===0){this.clear()}},objectForId:function(X){return this._objects[X]}};return V}();U=function(){var V={};V.derive=function(Y,ab,aa){for(var ac in ab.prototype){Y.prototype[ac]=ab.prototype[ac]}if(aa===undefined){return}for(var Z in aa){Y.prototype[Z]=aa[Z]}};V.bind=function(Z,Y){return function(){return Y.apply(Z,arguments)}};V.copy=function(Z){Z=Z||{};var Y={};for(var aa in Z){if(Z.hasOwnProperty(aa)){Y[aa]=Z[aa]}}return Y};function W(Y,Z){return Y<Z}V.binarySearch=function(aa,ae,Z){if(aa.length===0){return -1}Z=Z||W;var Y=0,ad=aa.length;var ab=Y+ad>>1;while(true){var ac=aa[ab];if(Z(ae,ac)){ad=ab}else{if(Z(ac,ae)){Y=ab}else{return ab}}var af=Y+ad>>1;if(af===ab){return -1}ab=af}return -1};V.indexFirstLargerEqualThan=function(aa,ae,Z){Z=Z||W;if(aa.length===0||Z(aa[aa.length-1],ae)){return -1}var Y=0,ad=aa.length;var ab=Y+ad>>1;while(true){var ac=aa[ab];if(Z(ae,ac)){ad=ab}else{if(Z(ac,ae)){Y=ab+1}else{ad=ab}}var af=Y+ad>>1;if(af===ab){return ab}ab=af}};V.indexLastSmallerThan=function(aa,ae,Z){Z=Z||W;if(aa.length===0||Z(aa[aa.length-1],ae)){return aa.length-1}if(Z(ae,aa[0])||!Z(aa[0],ae)){return -1}var Y=0,ad=aa.length;var ab=Y+ad>>1;while(true){var ac=aa[ab];if(Z(ae,ac)||!Z(ac,ae)){ad=ab}else{Y=ab}var af=Y+ad>>1;if(af===ab){return ab}ab=af}};V.indexLastSmallerEqualThan=function(aa,ae,Z){Z=Z||W;if(aa.length===0||Z(aa[aa.length-1],ae)){return aa.length-1}if(Z(ae,aa[0])){return -1}var Y=0,ad=aa.length;var ab=Y+ad>>1;while(true){var ac=aa[ab];if(Z(ae,ac)){ad=ab}else{Y=ab}var af=Y+ad>>1;if(af===ab){return ab}ab=af}};function X(Z,Y){if(Z===undefined||Y===undefined){this._empty=true;this._min=this._max=null}else{this._empty=false;this._min=Z;this._max=Y}}X.prototype={min:function(){return this._min},max:function(){return this._max},length:function(){return this._max-this._min},empty:function(){return this._empty},center:function(){return(this._max+this._min)*0.5},extend:function(Y){this._min-=Y;this._max+=Y},update:function(Y){if(!this._empty){if(Y<this._min){this._min=Y}else{if(Y>this._max){this._max=Y}}return}this._min=this._max=Y;this._empty=false}};V.Range=X;return V}();J=function(){function W(Z){if(document.readyState!=="complete"&&document.readyState!=="loaded"&&document.readyState!=="interactive"){console.error("isWebGLSupported only works after DOMContentLoaded");return false}if(Z===undefined){try{var X=document.createElement("canvas");return !!(window.WebGLRenderingContext&&X.getContext("experimental-webgl"))}catch(Y){return false}}return !!Z}function V(X,Y){this._width=Y.width;this._antialias=Y.antialias;this._height=Y.height;this._resize=false;this._lastTimestamp=null;this._domElement=X;this._initCanvas();this._backgroundColor=Y.backgroundColor;this._forceManualAntialiasing=Y.forceManualAntialiasing}V.prototype={_ensureSize:function(){if(!this._resize){return}this._resize=false;var Y=this._width*this._samples;var X=this._height*this._samples;this._realWidth=Y;this._realHeight=X;this._gl.viewport(0,0,Y,X);this._canvas.width=Y;this._canvas.height=X;if(this._samples>1){this._initManualAntialiasing(this._samples)}},resize:function(Y,X){if(Y===this._width&&X===this._height){return}this._resize=true;this._width=Y;this._height=X},fitParent:function(){var X=this._domElement.getBoundingClientRect();this.resize(X.width,X.height)},gl:function(){return this._gl},imageData:function(){return this._canvas.toDataURL()},_initContext:function(){try{var X={antialias:this._antialias&&!this._forceManualAntialiasing,preserveDrawingBuffer:true};this._gl=this._canvas.getContext("experimental-webgl",X)}catch(Y){console.error("WebGL not supported",Y);return false}if(!this._gl){console.error("WebGL not supported");return false}return true},_initManualAntialiasing:function(Z){var aa=1/Z;var X=-(1-aa)*0.5*this._realWidth;var ad=-(1-aa)*0.5*this._realHeight;var ac="translate("+X+"px, "+ad+"px)";var ab="scale("+aa+", "+aa+")";var Y=ac+" "+ab;this._canvas.style.webkitTransform=Y;this._canvas.style.transform=Y;this._canvas.style.ieTransform=Y;this._canvas.width=this._realWidth;this._canvas.height=this._realHeight},initGL:function(){var X=1;if(!this._initContext()){return false}var Y=this._gl;if((!Y.getContextAttributes().antialias||this._forceManualAntialiasing)&&this._antialias){X=2}this._realWidth=this._width*X;this._realHeight=this._height*X;this._samples=X;if(X>1){this._initManualAntialiasing(X)}Y.viewportWidth=this._realWidth;Y.viewportHeight=this._realHeight;Y.clearColor(this._backgroundColor[0],this._backgroundColor[1],this._backgroundColor[2],1);Y.lineWidth(2);Y.cullFace(Y.FRONT);Y.enable(Y.CULL_FACE);Y.enable(Y.DEPTH_TEST);return true},_shaderFromString:function(Y,Z,X){var ab;var ac=this._gl;if(Z==="fragment"){ab=ac.createShader(ac.FRAGMENT_SHADER)}else{if(Z==="vertex"){ab=ac.createShader(ac.VERTEX_SHADER)}else{console.error("could not determine type for shader");return null}}var aa=Y.replace("${PRECISION}",X);ac.shaderSource(ab,aa);ac.compileShader(ab);if(!ac.getShaderParameter(ab,ac.COMPILE_STATUS)){console.log(aa);console.error(ac.getShaderInfoLog(ab));return null}return ab},initShader:function(Y,ad,aa){var Z=this._gl;var ab=this._shaderFromString(ad,"fragment",aa);var af=this._shaderFromString(Y,"vertex",aa);var X=Z.createProgram();Z.attachShader(X,af);Z.attachShader(X,ab);Z.linkProgram(X);if(!Z.getProgramParameter(X,Z.LINK_STATUS)){console.error("could not initialise shaders");console.error(Z.getShaderInfoLog(X));return null}var ac=U.bind(Z,Z.getAttribLocation);var ae=U.bind(Z,Z.getUniformLocation);X.posAttrib=ac(X,"attrPos");X.colorAttrib=ac(X,"attrColor");X.normalAttrib=ac(X,"attrNormal");X.objIdAttrib=ac(X,"attrObjId");X.selectAttrib=ac(X,"attrSelect");X.symId=ae(X,"symId");X.projection=ae(X,"projectionMat");X.modelview=ae(X,"modelviewMat");X.rotation=ae(X,"rotationMat");X.fog=ae(X,"fog");X.fogFar=ae(X,"fogFar");X.fogNear=ae(X,"fogNear");X.fogColor=ae(X,"fogColor");X.outlineColor=ae(X,"outlineColor");X.outlineWidth=ae(X,"outlineWidth");X.relativePixelSize=ae(X,"relativePixelSize");X.screenDoorTransparency=ae(X,"screenDoorTransparency");X.selectionColor=ae(X,"selectionColor");X.pointSize=ae(X,"pointSize");X.zoom=ae(X,"zoom");return X},on:function(X,Y){this._canvas.addEventListener(X,Y,false)},removeEventListener:function(X,Y){this._canvas.removeEventListener(X,Y,false)},onWheel:function(Y,X){if("onwheel" in this._canvas){this.on("wheel",Y)}else{this.on("mousewheel",X)}},domElement:function(){return this._canvas},bind:function(){this._ensureSize();this._gl.viewport(0,0,this._realWidth,this._realHeight)},superSamplingFactor:function(){return this._samples},viewportWidth:function(){return this._realWidth},viewportHeight:function(){return this._realHeight},width:function(){return this._width},height:function(){return this._height},_initCanvas:function(){this._canvas=document.createElement("canvas");this._canvas.width=this._width;this._canvas.height=this._height;this._domElement.appendChild(this._canvas)},isWebGLSupported:function(){return W(this._gl)},destroy:function(){this._canvas.width=1;this._canvas.height=1;this._canvas.parentElement.removeChild(this._canvas);this._canvas=null}};return{Canvas:V,isWebGLSupported:W}}();c=function(){function V(X,W){this._width=W.width;this._height=W.height;this._colorBufferWidth=this._width;this._colorBufferHeight=this._height;this._gl=X;this._colorHandle=X.createFramebuffer();X.bindFramebuffer(X.FRAMEBUFFER,this._colorHandle);this._depthHandle=X.createRenderbuffer();X.bindRenderbuffer(X.RENDERBUFFER,this._depthHandle);X.renderbufferStorage(X.RENDERBUFFER,X.DEPTH_COMPONENT16,this._width,this._height);X.framebufferRenderbuffer(X.FRAMEBUFFER,X.DEPTH_ATTACHMENT,X.RENDERBUFFER,this._depthHandle);this._colorTexture=X.createTexture();this._initColorBuffer()}V.prototype={width:function(){return this._width},height:function(){return this._height},bind:function(){var W=this._gl;W.bindFramebuffer(W.FRAMEBUFFER,this._colorHandle);W.bindRenderbuffer(W.RENDERBUFFER,this._depthHandle);if(this._colorBufferWidth!==this._width||this._colorBufferHeight!==this._height){this._resizeBuffers()}W.viewport(0,0,this._width,this._height)},colorTexture:function(){return this._colorTexture},_initColorBuffer:function(){this.bind();var W=this._gl;W.bindTexture(W.TEXTURE_2D,this._colorTexture);W.texImage2D(W.TEXTURE_2D,0,W.RGBA,this._width,this._height,0,W.RGBA,W.UNSIGNED_BYTE,null);W.framebufferTexture2D(W.FRAMEBUFFER,W.COLOR_ATTACHMENT0,W.TEXTURE_2D,this._colorTexture,0);W.texParameteri(W.TEXTURE_2D,W.TEXTURE_MIN_FILTER,W.LINEAR);W.texParameteri(W.TEXTURE_2D,W.TEXTURE_MAG_FILTER,W.LINEAR);W.texParameteri(W.TEXTURE_2D,W.TEXTURE_WRAP_S,W.CLAMP_TO_EDGE);W.texParameteri(W.TEXTURE_2D,W.TEXTURE_WRAP_T,W.CLAMP_TO_EDGE);W.bindTexture(W.TEXTURE_2D,null);this.release()},_resizeBuffers:function(){var W=this._gl;W.bindRenderbuffer(W.RENDERBUFFER,this._depthHandle);W.renderbufferStorage(W.RENDERBUFFER,W.DEPTH_COMPONENT16,this._width,this._height);W.bindTexture(W.TEXTURE_2D,this._colorTexture);W.texImage2D(W.TEXTURE_2D,0,W.RGBA,this._width,this._height,0,W.RGBA,W.UNSIGNED_BYTE,null);W.framebufferTexture2D(W.FRAMEBUFFER,W.COLOR_ATTACHMENT0,W.TEXTURE_2D,this._colorTexture,0);W.framebufferRenderbuffer(W.FRAMEBUFFER,W.DEPTH_ATTACHMENT,W.RENDERBUFFER,this._depthHandle);W.bindTexture(W.TEXTURE_2D,null);this._colorBufferWidth=this._width;this._colorBufferHeight=this._height},resize:function(X,W){this._width=X;this._height=W},release:function(){var W=this._gl;W.bindFramebuffer(W.FRAMEBUFFER,null);W.bindRenderbuffer(W.RENDERBUFFER,null)}};return V}();S=function(){function V(W){this._freeArrays=[];this._bufferType=W}V.prototype.request=function(ac){var Z=-1;var X=null;for(var Y=0;Y<this._freeArrays.length;++Y){var ab=this._freeArrays[Y];var aa=ab.length;if(aa>=ac&&(X===null||aa<X)){X=aa;Z=Y}}if(Z!==-1){var W=this._freeArrays[Z];this._freeArrays.splice(Z,1);return W}return new this._bufferType(ac)};V.prototype.release=function(W){this._freeArrays.push(W)};return V}();Q=function(){var X=o.vec3;var W=o.mat4;function V(Y){this._projection=W.create();this._camModelView=W.create();this._modelView=W.create();this._rotation=W.create();this._translation=W.create();this._near=0.1;this._far=4000;this._fogNear=-5;this._fogFar=50;this._fog=true;this._fovY=Math.PI*45/180;this._fogColor=X.fromValues(1,1,1);this._outlineColor=X.fromValues(0.1,0.1,0.1);this._outlineWidth=1;this._selectionColor=X.fromValues(0.1,1,0.1);this._center=X.create();this._zoom=50;this._screenDoorTransparency=false;this._updateProjectionMat=true;this._updateModelViewMat=true;this._upsamplingFactor=1;this._gl=Y;this._currentShader=null;this._stateId=0;this.setViewportSize(Y.viewportWidth,Y.viewportHeight)}V.prototype={_incrementStateId:function(){this._stateId+=1;if(this._stateId>68719476735){this._stateId=0}},setScreenDoorTransparency:function(Y){this._screenDoorTransparency=Y;this._incrementStateId()},setOutlineWidth:function(Y){if(this._outlineWidth!==Y){this._outlineWidth=Y;this._incrementStateId()}},setRotation:function(Y){if(Y.length===16){W.copy(this._rotation,Y)}else{W.fromMat3(this._rotation,Y)}this._updateModelViewMat=true},upsamplingFactor:function(){return this._upsamplingFactor},setUpsamplingFactor:function(Z){if(this._upsamplingFactor!==Z){this._incrementStateId();this._upsamplingFactor=Z;var Y=this._upsamplingFactor/this._width;var aa=this._upsamplingFactor/this._height;this._relativePixelSize=new Float32Array([Y,aa])}},mainAxes:function(){return[X.fromValues(this._rotation[0],this._rotation[4],this._rotation[8]),X.fromValues(this._rotation[1],this._rotation[5],this._rotation[9]),X.fromValues(this._rotation[2],this._rotation[6],this._rotation[10])]},fieldOfViewY:function(){return this._fovY},setFieldOfViewY:function(Y){this._fovY=Y;this._updateProjectionMat=true},aspectRatio:function(){return this._width/this._height},rotation:function(){return this._rotation},_updateIfRequired:function(){var Y=false;if(this._updateModelViewMat){W.identity(this._camModelView);W.translate(this._camModelView,this._camModelView,[-this._center[0],-this._center[1],-this._center[2]]);W.mul(this._camModelView,this._rotation,this._camModelView);W.identity(this._translation);W.translate(this._translation,this._translation,[0,0,-this._zoom]);W.mul(this._camModelView,this._translation,this._camModelView);Y=true}if(this._updateProjectionMat){W.identity(this._projection);W.perspective(this._projection,this._fovY,this._width/this._height,this._near,this._far);Y=true}this._updateProjectionMat=false;this._updateModelViewMat=false;if(Y){this._incrementStateId()}return Y},setViewportSize:function(Z,Y){this._updateProjectionMat=true;this._width=Z;this._height=Y;this._relativePixelSize=new Float32Array([this._upsamplingFactor/Z,this._upsamplingFactor/Y])},viewportWidth:function(){return this._width},viewportHeight:function(){return this._height},setCenter:function(Y){this._updateModelViewMat=true;X.copy(this._center,Y)},fog:function(Y){if(Y!==undefined&&Y!==this._fog){this._fog=Y;this._incrementStateId()}return this._fog},rotateZ:function(){var Y=W.create();return function(Z){W.identity(Y);this._updateModelViewMat=true;W.rotate(Y,Y,Z,[0,0,1]);W.mul(this._rotation,Y,this._rotation)}}(),rotateX:function(){var Y=W.create();return function(Z){W.identity(Y);this._updateModelViewMat=true;W.rotate(Y,Y,Z,[1,0,0]);W.mul(this._rotation,Y,this._rotation)}}(),rotateY:function(){var Y=W.create();return function(Z){W.identity(Y);this._updateModelViewMat=true;W.rotate(Y,Y,Z,[0,1,0]);W.mul(this._rotation,Y,this._rotation)}}(),panX:function(Y){return this.panXY(Y,0)},panY:function(Y){return this.panXY(0,Y)},panXY:function(){var Z=W.create();var Y=X.create();return function(ab,aa){W.transpose(Z,this._rotation);this._updateModelViewMat=true;X.set(Y,-ab,aa,0);X.transformMat4(Y,Y,Z);X.add(Y,Y,this._center);this.setCenter(Y)}}(),nearOffset:function(){return this._near},farOffset:function(){return this._far},setNearFar:function(Z,Y){if(Z===this._near&&Y===this._far){return}this._near=Z;this._far=Y;this._updateProjectionMat=true},setFogNearFar:function(Z,Y){this._fogNear=Z;this._fogFar=Y;this._updateProjectionMat=true},setZoom:function(Y){this._updateModelViewMat=true;this._zoom=Y;return this._zoom},zoom:function(Z){if(Z===undefined){return this._zoom}this._updateModelViewMat=true;var Y=1+Z*0.1;this._zoom=Math.min(1000,Math.max(2,Y*this._zoom));return this._zoom},center:function(){return this._center},setFogColor:function(Y){this._fogColor=X.clone(Y)},currentShader:function(){return this._currentShader},invalidateCurrentShader:function(){this._currentShader=null},setOutlineColor:function(Y){this._outlineColor=X.clone(Y)},setSelectionColor:function(Y){this._selectionColor=X.clone(Y)},bind:function(ab,Y){var Z=false;var ac=this._gl;if(this._currentShader!==ab){this._currentShader=ab;ac.useProgram(ab);Z=true}Z=this._updateIfRequired()||Z;if(Y){W.mul(this._modelView,this._camModelView,Y);ac.uniformMatrix4fv(ab.modelview,false,this._modelView)}else{ac.uniformMatrix4fv(ab.modelview,false,this._camModelView)}if(this._stateId===ab.stateId){return}ab.stateId=this._stateId;ac.uniformMatrix4fv(ab.projection,false,this._projection);if(ab.rotation){ac.uniformMatrix4fv(ab.rotation,false,this._rotation)}ac.uniform1i(ab.fog,this._fog);var aa=this._zoom;ac.uniform1f(ab.fogFar,this._fogFar+aa);ac.uniform1f(ab.zoom,this._zoom);ac.uniform1f(ab.fogNear,this._fogNear+aa);ac.uniform3fv(ab.fogColor,this._fogColor);ac.uniform3fv(ab.outlineColor,this._outlineColor);ac.uniform3fv(ab.selectionColor,this._selectionColor);ac.uniform2fv(ab.relativePixelSize,this._relativePixelSize);ac.uniform1f(ab.outlineWidth,this._outlineWidth);ac.uniform1i(ab.screenDoorTransparency,this._screenDoorTransparency)}};return V}();s={PRELUDE_FS:"\nprecision ${PRECISION} float;\nuniform bool screenDoorTransparency;\nvec4 handleAlpha(vec4 inColor) {\n  if (screenDoorTransparency) {\n    ivec2 pxCoord = ivec2(gl_FragCoord.xy);\n    ivec2 mod = pxCoord - (pxCoord/2) * 2;\n    if (inColor.a < 0.99 &&\n        (inColor.a < 0.01 || mod.x != 0 || mod.y != 0)) { discard; }\n    return vec4(inColor.rgb, 1.0);\n  } else {\n    if (inColor.a == 0.0) { discard; }\n    return inColor;\n  } \n} \nuniform vec3 selectionColor;\n\nvec3 handleSelect(vec3 inColor, float vertSelect) { \n  return mix(inColor, selectionColor, step(0.5, vertSelect) * 0.7); \n} \n\nuniform bool fog;\nuniform float fogNear;\nuniform float fogFar;\nuniform vec3 fogColor;\nvec3 handleFog(vec3 inColor) {\n  if (fog) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = smoothstep(fogNear, fogFar, depth);\n    return mix(inColor, fogColor, fogFactor);\n  } else {\n    return inColor;\n  }\n}",LINES_FS:"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\n\nvoid main(void) {\n  gl_FragColor = handleAlpha(vertColor);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n}",SELECT_LINES_FS:"\nprecision ${PRECISION} float;\n\nvarying float vertSelect;\nvarying vec3 vertNormal;\nuniform float fogNear;\nuniform float fogFar;\nuniform vec3 fogColor;\nuniform bool fog;\nuniform vec3 selectionColor;\n\nvoid main(void) {\n  gl_FragColor = mix(vec4(0.0, 0.0, 0.0, 0.0), vec4(selectionColor, 1.0), \n                     vertSelect);\n  gl_FragColor.a = step(0.5, vertSelect);\n  if (gl_FragColor.a == 0.0) { discard; }\n  float depth = gl_FragCoord.z / gl_FragCoord.w;\n  if (fog) {\n    float fog_factor = smoothstep(fogNear, fogFar, depth);\n    gl_FragColor = mix(gl_FragColor, vec4(fogColor, gl_FragColor.w),\n                        fog_factor);\n  }\n}",SELECT_LINES_VS:"\nattribute vec3 attrPos;\nattribute float attrSelect;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform float pointSize;\nvarying float vertSelect;\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  gl_Position.z += gl_Position.w * 0.000001; \n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera); \n  vertSelect = attrSelect;\n}",SELECT_VS:"\nprecision ${PRECISION} float;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform float pointSize;\nattribute vec3 attrPos;\nattribute float attrObjId;\n\nvarying float objId;\n\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera); \n  objId = attrObjId;\n}",SELECT_FS:"\nprecision ${PRECISION} float;\n\nvarying float objId;\nuniform int symId;\n\nint intMod(int x, int y) { \n  int z = x/y;\n  return x-y*z;\n}\nvoid main(void) {\n  // ints are only required to be 7bit...\n  int integralObjId = int(objId+0.5);\n  int red = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int green = intMod(integralObjId, 256);\n  integralObjId/=256;\n  int blue = intMod(integralObjId, 256);\n  int alpha = symId;\n  gl_FragColor = vec4(float(red), float(green), \n                      float(blue), float(alpha))/255.0;\n}",LINES_VS:"\nattribute vec3 attrPos;\nattribute vec4 attrColor;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying vec4 vertColor;\nuniform float pointSize;\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  float distToCamera = vec4(modelviewMat * vec4(attrPos, 1.0)).z;\n  gl_PointSize = pointSize * 200.0 / abs(distToCamera); \n  vertColor = attrColor;\n}",HEMILIGHT_FS:"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying float vertSelect;\n\nvoid main(void) {\n  float dp = dot(vertNormal, vec3(0.0, 0.0, 1.0));\n  float hemi = min(1.0, max(0.0, dp)*0.6+0.5);\n  gl_FragColor = vec4(vertColor.rgb*hemi, vertColor.a);\n  gl_FragColor.rgb = handleFog(handleSelect(gl_FragColor.rgb, vertSelect));\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",PHONG_FS:"\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying vec3 vertPos;\nuniform float zoom;\nvarying float vertSelect;\n\nvoid main(void) {\n  vec3 eyePos = vec3(0.0, 0.0, zoom);\n  float dp = dot(vertNormal, normalize(eyePos - vertPos));\n  float hemi = min(1.0, max(0.3, dp)+0.2);\n  //hemi *= vertColor.a;\n  vec3 rgbColor = vertColor.rgb * hemi; \n  rgbColor += min(vertColor.rgb, 0.8) * pow(max(0.0, dp), 18.0);\n  rgbColor = handleSelect(rgbColor, vertSelect);\n  gl_FragColor = vec4(clamp(rgbColor, 0.0, 1.0), vertColor.a);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",HEMILIGHT_VS:"\nattribute vec3 attrPos;\nattribute vec4 attrColor;\nattribute vec3 attrNormal;\nattribute float attrSelect;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying vec4 vertColor;\nvarying vec3 vertNormal;\nvarying vec3 vertPos;\nvarying float vertSelect;\nvoid main(void) {\n  vertPos = (modelviewMat * vec4(attrPos, 1.0)).xyz;\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  vec4 n = (modelviewMat * vec4(attrNormal, 0.0));\n  vertNormal = n.xyz;\n  vertColor = attrColor;\n  vertSelect = attrSelect;\n}",OUTLINE_FS:"\nvarying float vertAlpha;\nvarying float vertSelect;\n\nuniform vec3 outlineColor;\n\nvoid main() {\n  gl_FragColor = vec4(mix(outlineColor, selectionColor, \n                          step(0.5, vertSelect)), \n                      vertAlpha);\n  gl_FragColor.rgb = handleFog(gl_FragColor.rgb);\n  gl_FragColor = handleAlpha(gl_FragColor);\n}",OUTLINE_VS:"\nprecision ${PRECISION} float;\n\nattribute vec3 attrPos;\nattribute vec3 attrNormal;\nattribute vec4 attrColor;\nattribute float attrSelect;\n\nuniform vec3 outlineColor;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nvarying float vertAlpha;\nvarying float vertSelect;\nuniform vec2 relativePixelSize;\nuniform float outlineWidth;\n\nvoid main(void) {\n  gl_Position = projectionMat * modelviewMat * vec4(attrPos, 1.0);\n  vec4 normal = modelviewMat * vec4(attrNormal, 0.0);\n  vertAlpha = attrColor.a;\n  vertSelect = attrSelect;\n  vec2 expansion = relativePixelSize * \n       (outlineWidth + 2.0 * step(0.5, attrSelect));\n  vec2 offset = normal.xy * expansion;\n  gl_Position.xy += gl_Position.w * offset;\n}",TEXT_VS:"\nprecision ${PRECISION} float;\n\nattribute vec3 attrCenter;\nattribute vec2 attrCorner;\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform mat4 rotationMat;\nvarying vec2 vertTex;\nuniform float width;\nuniform float height;\nvoid main() { \n  vec4 pos = modelviewMat* vec4(attrCenter, 1.0);\n  pos.z += 4.0;\n  gl_Position = projectionMat * pos;\n  gl_Position.xy += vec2(width,height)*attrCorner*gl_Position.w; \n  vertTex = (attrCorner+abs(attrCorner))/(2.0*abs(attrCorner)); \n}",TEXT_FS:"\nprecision ${PRECISION} float;\n\nuniform mat4 projectionMat;\nuniform mat4 modelviewMat;\nuniform sampler2D sampler;\nuniform float xScale;\nuniform float yScale;\nvarying vec2 vertTex;\nvoid main() { \n  vec2 texCoord = vec2(vertTex.x*xScale, vertTex.y*yScale);\n  gl_FragColor = texture2D(sampler, texCoord);\n  if (gl_FragColor.a == 0.0) { discard; }\n}"};L=function(){function V(ab,ad,ac){this._element=ab;this._element.addEventListener("touchmove",U.bind(this,this._touchMove));this._element.addEventListener("touchstart",U.bind(this,this._touchStart));this._element.addEventListener("touchend",U.bind(this,this._touchEnd));this._element.addEventListener("touchcancel",U.bind(this,this._touchEnd));this._touchState={scale:1,rotation:0,center:null};this._lastSingleTap=null;this._viewer=ad;this._cam=ac}function Z(ae){var ad=0,ac=0;for(var ab=0;ab<ae.length;++ab){ad+=ae[ab].clientX;ac+=ae[ab].clientY}ad/=ae.length;ac/=ae.length;return{x:ad,y:ac}}function aa(ad,ab){var ae=ab.x-ad.x;var ac=ab.y-ad.y;return Math.sqrt(ae*ae+ac*ac)}function X(ae,ac){var ab=aa(ae[0],ae[1]);var ad=aa(ac[0],ac[1]);return ad/(ab===0?1:ab)}function W(ae,ad){var ac=ad.x-ae.x;var ab=ad.y-ae.y;return Math.atan2(ab,ac)}function Y(ac,ab){return W(ab[1],ab[0])-W(ac[1],ac[0])}V.prototype={_extractEventAttributes:function(ab,ae){var af={};af.center=Z(ae.targetTouches);af.pointers=[];for(var ad=0;ad<ae.targetTouches.length;++ad){var ac=ae.targetTouches[ad];af.pointers.push({x:ac.clientX,y:ac.clientY})}af.numTouches=ae.targetTouches.length;af.rotation=0;af.scale=1;af.deltaScale=0;af.deltaRotation=0;if(ab.center){af.deltaCenter={x:af.center.x-ab.center.x,y:af.center.y-ab.center.y}}if(ab.numTouches!==2||af.numTouches!==2){return af}if(ab.initialPointers){af.initialPointers=ab.initialPointers}else{af.initialPointers=ab.pointers}af.scale=X(af.initialPointers,af.pointers);af.deltaScale=af.scale-ab.scale;af.rotation=Y(af.initialPointers,af.pointers);af.deltaRotation=af.rotation-ab.rotation;return af},_touchMove:function(ac){ac.preventDefault();var ae=this._extractEventAttributes(this._touchState,ac);var af=-ae.deltaScale*4;if(af!==0){this._cam.zoom(af)}if(ae.numTouches===2&&this._touchState.numTouches===2){var ad=0.002*Math.tan(0.5*this._cam.fieldOfViewY())*this._cam.zoom();this._cam.panXY(ae.deltaCenter.x*ad,ae.deltaCenter.y*ad)}var ab=-ae.deltaRotation;this._cam.rotateZ(ab);if(ae.numTouches===1&&this._touchState.numTouches===1){this._cam.rotateX(ae.deltaCenter.y*0.005);this._cam.rotateY(ae.deltaCenter.x*0.005)}this._viewer.requestRedraw();this._touchState=ae},_touchStart:function(ac){ac.preventDefault();if(ac.targetTouches.length===1){var ab=new Date().getTime();if(this._lastSingleTap!==null){var ad=ab-this._lastSingleTap;if(ad<500){this._viewer._mouseDoubleClick({clientX:ac.targetTouches[0].clientX,clientY:ac.targetTouches[0].clientY})}}this._lastSingleTap=ab}else{this._lastSingleTap=null}this._touchState=this._extractEventAttributes(this._touchState,ac)},_touchEnd:function(ab){ab.preventDefault()}};return V}();A=function(){function V(W,Z,X,Y){this._viewer=Z;this._canvas=W;this._cam=X;this._canvas=W;this._animationTime=Y;this._lastMouseUpTime=null;this._init()}V.prototype={_centerOnClicked:function(W){if(W===null){return}this._viewer.setCenter(W.pos(),this._animationTime)},_mouseUp:function(aa){var W=this._canvas;var Z=new Date().getTime();if((this._lastMouseUpTime===null||Z-this._lastMouseUpTime>300)&Z-this._lastMouseDownTime<300){var Y=this._canvas.domElement().getBoundingClientRect();var X=this._viewer.pick({x:aa.clientX-Y.left,y:aa.clientY-Y.top});this._viewer._dispatchEvent(aa,"click",X)}this._lastMouseUpTime=Z;W.removeEventListener("mousemove",this._mouseRotateListener);W.removeEventListener("mousemove",this._mousePanListener);W.removeEventListener("mouseup",this._mouseUpListener);document.removeEventListener("mouseup",this._mouseUpListener);document.removeEventListener("mousemove",this._mouseRotateListener);document.removeEventListener("mousemove",this._mousePanListener)},setCam:function(W){this._cam=W},_init:function(){this._mousePanListener=U.bind(this,this._mousePan);this._mouseRotateListener=U.bind(this,this._mouseRotate);this._mouseUpListener=U.bind(this,this._mouseUp);this._canvas.onWheel(U.bind(this,this._mouseWheelFF),U.bind(this,this._mouseWheel));this._canvas.on("dblclick",U.bind(this,this._mouseDoubleClick));this._canvas.on("mousedown",U.bind(this,this._mouseDown));return true},_mouseWheel:function(W){this._cam.zoom(W.wheelDelta<0?-1:1);W.preventDefault();this._viewer.requestRedraw()},_mouseWheelFF:function(W){this._cam.zoom(W.deltaY<0?1:-1);W.preventDefault();this._viewer.requestRedraw()},_mouseDoubleClick:function(){return function(Y){var X=this._canvas.domElement().getBoundingClientRect();var W=this._viewer.pick({x:Y.clientX-X.left,y:Y.clientY-X.top});this._viewer._dispatchEvent(Y,"doubleClick",W);this._viewer.requestRedraw()}}(),_mouseDown:function(W){if(W.button!==0){return}this._lastMouseDownTime=new Date().getTime();W.preventDefault();if(W.shiftKey===true){this._canvas.on("mousemove",this._mousePanListener);document.addEventListener("mousemove",this._mousePanListener,false)}else{this._canvas.on("mousemove",this._mouseRotateListener);document.addEventListener("mousemove",this._mouseRotateListener,false)}this._canvas.on("mouseup",this._mouseUpListener);document.addEventListener("mouseup",this._mouseUpListener,false);this._lastMousePos={x:W.pageX,y:W.pageY}},_mouseRotate:function(X){var W={x:X.pageX,y:X.pageY};var Z={x:W.x-this._lastMousePos.x,y:W.y-this._lastMousePos.y};var Y=0.005;this._cam.rotateX(Y*Z.y);this._cam.rotateY(Y*Z.x);this._lastMousePos=W;this._viewer.requestRedraw()},_mousePan:function(X){var W={x:X.pageX,y:X.pageY};var Z={x:W.x-this._lastMousePos.x,y:W.y-this._lastMousePos.y};var Y=0.002*Math.tan(0.5*this._cam.fieldOfViewY())*this._cam.zoom();this._cam.panXY(Y*Z.x,Y*Z.y);this._lastMousePos=W;this._viewer.requestRedraw()}};return V}();g=function(){var ac=o.vec3;var ab=o.vec4;var V=o.mat3;var W=o.quat;var Y=function(){var aj=ac.create();return function(al,ak,am){ac.cross(aj,al,ak);return Math.atan2(ac.dot(aj,am),ac.dot(al,ak))}}();var af=function(){var aj=ac.create();return function(ak,al){ac.copy(aj,al);if(Math.abs(al[0])<Math.abs(al[1])){if(Math.abs(al[0])<Math.abs(al[2])){aj[0]+=1}else{aj[2]+=1}}else{if(Math.abs(al[1])<Math.abs(al[2])){aj[1]+=1}else{aj[2]+=1}}return ac.cross(ak,al,aj)}}();var X=function(ao,al,am){var au=Math.sin(am),an=Math.cos(am),av=al[0],at=al[1],ar=al[2],aj=av*av,ax=av*at,aw=av*ar,aq=at*at,ap=at*ar,ak=ar*ar;ao[0]=aj+an-aj*an;ao[1]=ax-an*ax-au*ar;ao[2]=aw-an*aw+au*at;ao[3]=ax-an*ax+au*ar;ao[4]=aq+an-an*aq;ao[5]=ap-an*ap-au*av;ao[6]=aw-an*aw-au*at;ao[7]=ap-an*ap+au*av;ao[8]=ak+an-an*ak;return ao};var ai=function(){var aj=ac.create();return function(ak,ap,ax,aq,au,av,an){var ao=av*av;var aw=3-2*av;var ar=ao*aw;var at=1-ar;var am=ao*(av-2)+av;var al=ao*(av-1);ac.copy(aj,ap);ac.scale(aj,aj,at);ac.scaleAndAdd(aj,aj,ax,am);ac.scaleAndAdd(aj,aj,aq,ar);ac.scaleAndAdd(aj,aj,au,al);ak[an]=aj[0];ak[an+1]=aj[1];ak[an+2]=aj[2]}}();function aa(ak,al,aj){if(aj){return ak*al}else{return al*(ak-1)+1}}function Z(au,aC,am,az,aB,an){aB=aB||false;az=az||0.5;var aw=null;var aA=aa(aC,am,aB)*3;if(an){aw=an.request(aA)}else{aw=new Float32Array(aA)}var ak=0;var ay=1/am;var al=ac.create(),ar=ac.create();var aj=ac.create(),aq=ac.create(),ap=ac.create(),ao=ac.create();var av,at,ax;ac.set(aq,au[0],au[1],au[2]);ac.set(ap,au[3],au[4],au[5]);if(aB){ac.set(aj,au[au.length-3],au[au.length-2],au[au.length-1]);ac.sub(al,ap,aj);ac.scale(al,al,az)}else{ac.set(aj,au[0],au[1],au[2]);ac.set(al,0,0,0)}for(av=1,ax=aC-1;av<ax;++av){ac.set(ao,au[3*(av+1)],au[3*(av+1)+1],au[3*(av+1)+2]);ac.sub(ar,ao,aq);ac.scale(ar,ar,az);for(at=0;at<am;++at){ai(aw,aq,al,ap,ar,ay*at,ak);ak+=3}ac.copy(aj,aq);ac.copy(aq,ap);ac.copy(ap,ao);ac.copy(al,ar)}if(aB){ac.set(ao,au[0],au[1],au[3]);ac.sub(ar,ao,aq);ac.scale(ar,ar,az)}else{ac.set(ar,0,0,0)}for(at=0;at<am;++at){ai(aw,aq,al,ap,ar,ay*at,ak);ak+=3}if(!aB){aw[ak]=au[3*(aC-1)+0];aw[ak+1]=au[3*(aC-1)+1];aw[ak+2]=au[3*(aC-1)+2];return aw}ac.copy(aj,aq);ac.copy(aq,ap);ac.copy(ap,ao);ac.copy(al,ar);ac.set(ao,au[3],au[4],au[5]);ac.sub(ar,ao,aq);ac.scale(ar,ar,az);for(at=0;at<am;++at){ai(aw,aq,al,ap,ar,ay*at,ak);ak+=3}return aw}function ad(ak,aj){this._center=ak||ac.create();this._radius=aj||1}var ae=function(){var am=V.create();var an=V.create();var al=V.create();var aj=V.create();var ao=W.create();var ak=ac.create();var ap=ac.create();return function(aC){var aA=24;var ar=W.fromValues(0,0,0,1);for(var aw=0;aw<aA;++aw){V.fromQuat(am,ar);var aB=V.transpose(al,am);V.mul(an,am,V.mul(aj,aC,aB));ac.set(ak,an[5],an[2],an[1]);ac.set(ap,Math.abs(ak[0]),Math.abs(ak[1]),Math.abs(ak[2]));var au=ap[0]>ap[1]&&ap[0]>ap[2]?0:ap[1]>ap[2]?1:2;var ay=(au+1)%3;var ax=(au+2)%3;if(ak[au]===0){break}var at=(an[ax*3+ax]-an[ay*3+ay])/(2*ak[au]);var av=at>0?1:-1;at*=av;var aq=at+(at<1000000?Math.sqrt(at*at+1):at);var aD=av/aq;var az=1/Math.sqrt(aD*aD+1);if(az===1){break}ab.set(ao,0,0,0,0);ao[au]=av*Math.sqrt((1-az)/2);ao[au]*=-1;ao[3]=Math.sqrt(1-ao[au]*ao[au]);if(ao[3]===1){break}ar=W.mul(ar,ar,ao);W.normalize(ar,ar)}return ar}}();ad.prototype.center=function(){return this._center};ad.prototype.radius=function(){return this._radius};var ah=function(){return function(ak,an,am,aj,al){if(al){ac.cross(aj,an,am)}else{af(aj,an)}ac.cross(am,aj,an);ac.normalize(aj,aj);ac.normalize(am,am);ak[0]=am[0];ak[1]=am[1];ak[2]=am[2];ak[3]=aj[0];ak[4]=aj[1];ak[5]=aj[2];ak[6]=an[0];ak[7]=an[1];ak[8]=an[2]}}();function ag(ar,an){var ak=new Float32Array(an*(ar.length-1)+1);var ao=0;var am=0,ap=0;var aq=1/an;for(var al=0;al<ar.length-1;++al){am=ar[al];ap=ar[al+1];for(var aj=0;aj<an;++aj){var at=aq*aj;ak[ao+0]=am*(1-at)+ap*at;ao+=1}}ak[ao+0]=ap;return ak}return{signedAngle:Y,axisRotation:X,ortho:af,diagonalizer:ae,catmullRomSpline:Z,cubicHermiteInterpolate:ai,interpolateScalars:ag,catmullRomSplineNumPoints:aa,Sphere:ad,buildRotation:ah}}();n=function(){var W=o.vec3;function V(aa,Z){this._arcs=Z;this._stacks=aa;this._indices=new Uint16Array(3*Z*aa*2);this._verts=new Float32Array(3*Z*aa);var ai=Math.PI/(aa-1);var aj=Math.PI*2/Z;var ac,ab;for(ac=0;ac<this._stacks;++ac){var ag=Math.sin(ac*ai);var ah=Math.cos(ac*ai);for(ab=0;ab<this._arcs;++ab){var ae=ag*Math.cos(ab*aj);var ad=ag*Math.sin(ab*aj);this._verts[3*(ab+ac*this._arcs)]=ae;this._verts[3*(ab+ac*this._arcs)+1]=ad;this._verts[3*(ab+ac*this._arcs)+2]=ah}}var af=0;for(ac=0;ac<this._stacks-1;++ac){for(ab=0;ab<this._arcs;++ab){this._indices[af]=ac*this._arcs+ab;this._indices[af+1]=ac*this._arcs+(ab+1)%this._arcs;this._indices[af+2]=(ac+1)*this._arcs+ab;af+=3;this._indices[af]=ac*this._arcs+(ab+1)%this._arcs;this._indices[af+1]=(ac+1)*this._arcs+(ab+1)%this._arcs;this._indices[af+2]=(ac+1)*this._arcs+ab;af+=3}}}V.prototype={addTransformed:function(){var aa=W.create(),Z=W.create();return function(ah,ad,ac,ae,ag){var ab=ah.numVerts();for(var af=0;af<this._stacks*this._arcs;++af){W.set(Z,this._verts[3*af],this._verts[3*af+1],this._verts[3*af+2]);W.copy(aa,Z);W.scale(aa,aa,ac);W.add(aa,aa,ad);ah.addVertex(aa,Z,ae,ag)}for(af=0;af<this._indices.length/3;++af){ah.addTriangle(ab+this._indices[af*3],ab+this._indices[af*3+1],ab+this._indices[af*3+2])}}}(),numIndices:function(){return this._indices.length},numVerts:function(){return this._verts.length/3}};function Y(ad,ab,af){var aa=g.catmullRomSpline(ad,ad.length/3,ab,af,true);this._indices=new Uint16Array(aa.length*2);this._verts=aa;this._normals=new Float32Array(aa.length);this._arcs=aa.length/3;var ae=W.create();for(var ac=0;ac<this._arcs;++ac){var Z=ac===0?this._arcs-1:ac-1;var ag=ac===this._arcs-1?0:ac+1;ae[0]=this._verts[3*ag+1]-this._verts[3*Z+1];ae[1]=this._verts[3*Z]-this._verts[3*ag];W.normalize(ae,ae);this._normals[3*ac]=ae[0];this._normals[3*ac+1]=ae[1];this._normals[3*ac+2]=ae[2]}for(ac=0;ac<this._arcs;++ac){this._indices[6*ac]=ac;this._indices[6*ac+1]=ac+this._arcs;this._indices[6*ac+2]=(ac+1)%this._arcs+this._arcs;this._indices[6*ac+3]=ac;this._indices[6*ac+4]=(ac+1)%this._arcs+this._arcs;this._indices[6*ac+5]=(ac+1)%this._arcs}}Y.prototype={addTransformed:function(){var aa=W.create(),Z=W.create();return function(al,ac,aj,an,af,ai,ag,ad){var ab=this._arcs;var ae=this._normals;var am=this._verts;var ak=al.numVerts()-ab;for(var ah=0;ah<ab;++ah){W.set(aa,aj*am[3*ah],aj*am[3*ah+1],0);W.transformMat3(aa,aa,an);W.add(aa,aa,ac);W.set(Z,ae[3*ah],ae[3*ah+1],0);W.transformMat3(Z,Z,an);al.addVertex(aa,Z,af,ad)}if(ai){return}if(ag===0){for(ah=0;ah<this._indices.length/3;++ah){al.addTriangle(ak+this._indices[ah*3],ak+this._indices[ah*3+1],ak+this._indices[ah*3+2])}return}for(ah=0;ah<ab;++ah){al.addTriangle(ak+(ah+ag)%ab,ak+ah+ab,ak+(ah+1)%ab+ab);al.addTriangle(ak+(ah+ag)%ab,ak+(ah+1)%ab+ab,ak+(ah+1+ag)%ab)}}}()};function X(aa){this._arcs=aa;this._indices=new Uint16Array(aa*3*2);this._verts=new Float32Array(3*aa*2);this._normals=new Float32Array(3*aa*2);var ab=Math.PI*2/this._arcs;for(var Z=0;Z<this._arcs;++Z){var ad=Math.cos(ab*Z);var ac=Math.sin(ab*Z);this._verts[3*Z]=ad;this._verts[3*Z+1]=ac;this._verts[3*Z+2]=-0.5;this._verts[3*aa+3*Z]=ad;this._verts[3*aa+3*Z+1]=ac;this._verts[3*aa+3*Z+2]=0.5;this._normals[3*Z]=ad;this._normals[3*Z+1]=ac;this._normals[3*aa+3*Z]=ad;this._normals[3*aa+3*Z+1]=ac}for(Z=0;Z<this._arcs;++Z){this._indices[6*Z]=Z%this._arcs;this._indices[6*Z+1]=aa+(Z+1)%this._arcs;this._indices[6*Z+2]=(Z+1)%this._arcs;this._indices[6*Z+3]=Z%this._arcs;this._indices[6*Z+4]=aa+Z%this._arcs;this._indices[6*Z+5]=aa+(Z+1)%this._arcs}}X.prototype={numVerts:function(){return this._verts.length/3},numIndices:function(){return this._indices.length},addTransformed:function(){var aa=W.create(),Z=W.create();return function(al,ac,af,aj,aq,ak,ae,ag,ao){var am=al.numVerts();var an=this._verts;var ah=this._normals;var ab=this._arcs;for(var ai=0;ai<2*ab;++ai){W.set(aa,aj*an[3*ai],aj*an[3*ai+1],af*an[3*ai+2]);W.transformMat3(aa,aa,aq);W.add(aa,aa,ac);W.set(Z,ah[3*ai],ah[3*ai+1],ah[3*ai+2]);W.transformMat3(Z,Z,aq);var ad=ai<ab?ag:ao;al.addVertex(aa,Z,ai<ab?ak:ae,ad)}var ap=this._indices;for(ai=0;ai<ap.length/3;++ai){al.addTriangle(am+ap[ai*3],am+ap[ai*3+1],am+ap[ai*3+2])}}}()};return{TubeProfile:Y,ProtoCylinder:X,ProtoSphere:V}}();O=R=function(){function V(W){this._children=[];this._visible=true;this._name=name||"";this._gl=W;this._order=1}V.prototype={order:function(W){if(W!==undefined){this._order=W}return this._order},add:function(W){this._children.push(W)},draw:function(aa,Z,X,Y){for(var W=0,ab=this._children.length;W!==ab;++W){this._children[W].draw(aa,Z,X,Y)}},show:function(){this._visible=true},hide:function(){this._visible=false},name:function(W){if(W!==undefined){this._name=W}return this._name},destroy:function(){for(var W=0;W<this._children.length;++W){this._children[W].destroy()}},visible:function(){return this._visible}};return V}();q=e=function(){var W=o.vec3;function Y(Z,aa){Z.eachResidue(function(ab){var ac=ab.centralAtom();if(ac===null){return}aa(ac,ac.pos())})}var V=function(){var Z=W.create();return function(ac,ak,al){for(var ag=0;ag<ak.length;++ag){var ah=ak[ag];var ai=ac.chainsByName(ah.chains());for(var af=0;af<ah.matrices().length;++af){var aj=ah.matrix(af);for(var ae=0;ae<ai.length;++ae){var aa=ai[ae];for(var ab=0;ab<aa.residues().length;++ab){var ad=aa.residues()[ab].centralAtom();if(ad===null){continue}W.transformMat4(Z,ad.pos(),aj);al(ad,Z)}}}}}}();function X(Z){R.call(this,Z);this._idRanges=[];this._vertAssocs=[];this._showRelated=null;this._selection=null}U.derive(X,R,{setShowRelated:function(Z){if(Z&&Z!=="asym"){if(this.structure().assembly(Z)===null){console.error("no assembly with name",Z,". Falling back to asymmetric unit");return}}this._showRelated=Z;return Z},symWithIndex:function(aa){if(this.showRelated()==="asym"){return null}var Z=this.structure().assembly(this.showRelated());if(!Z){return null}var ac=Z.generators();for(var ab=0;ab<ac.length;++ab){if(ac[ab].matrices().length>aa){return ac[ab].matrix(aa)}aa-=ac[ab].matrices().length}return null},showRelated:function(){return this._showRelated},select:function(Z){return this.structure().select(Z)},structure:function(){return this._vertAssocs[0]._structure},getColorForAtom:function(aa,Z){return this._vertAssocs[0].getColorForAtom(aa,Z)},addIdRange:function(Z){this._idRanges.push(Z)},destroy:function(){R.prototype.destroy.call(this);for(var Z=0;Z<this._idRanges.length;++Z){this._idRanges[Z].recycle()}},eachCentralAtom:function(ac){var ab=this;var Z=ab.structure();var aa=Z.assembly(ab.showRelated());if(aa===null){return Y(Z,ac)}return V(Z,aa.generators(),ac)},addVertAssoc:function(Z){this._vertAssocs.push(Z)},_vertArraysInvolving:function(ac){var ad=this.vertArrays();var ab=[];var ae={};for(var aa=0;aa<ac.length;++aa){ae[ac[aa]]=true}for(var Z=0;Z<ad.length;++Z){if(ae[ad[Z].chain()]===true){ab.push(ad[Z])}}return ab},_drawSymmetryRelated:function(ae,ac,aa){var ad=aa.generators();for(var ab=0;ab<ad.length;++ab){var af=ad[ab];var Z=this._vertArraysInvolving(af.chains());this._drawVertArrays(ae,ac,Z,af.matrices())}},_updateProjectionIntervalsAsym:function(ac,Z,ae,ag,ad,ab){var af=this.vertArrays();for(var aa=0;aa<af.length;++aa){af[aa].updateProjectionIntervals(ac,Z,ae,ag,ad,ab)}},updateProjectionIntervals:function(ab,Z,an,am,ad,aj){if(!this._visible){return}var ak=this.showRelated();if(ak==="asym"){return this._updateProjectionIntervalsAsym(ab,Z,an,am,ad,aj)}var ah=this.structure().assembly(ak);var al=ah.generators();for(var ag=0;ag<al.length;++ag){var ai=al[ag];var aa=this._vertArraysInvolving(ai.chains());for(var af=0;af<ai.matrices().length;++af){for(var ae=0;ae<aa.length;++ae){var ac=ai.matrix(af);aa[ae].updateProjectionIntervals(ab,Z,an,am,ad,aj,ac)}}}},_updateSquaredSphereRadiusAsym:function(aa,Z){var ac=this.vertArrays();for(var ab=0;ab<ac.length;++ab){Z=ac[ab].updateSquaredSphereRadius(aa,Z)}return Z},updateSquaredSphereRadius:function(Z,ag){if(!this._visible){return ag}var ah=this.showRelated();if(ah==="asym"){return this._updateSquaredSphereRadiusAsym(Z,ag)}var ae=this.structure().assembly(ah);var ai=ae.generators();for(var ad=0;ad<ai.length;++ad){var af=ai[ad];var aa=this._vertArraysInvolving(af.chains());for(var ac=0;ac<af.matrices().length;++ac){for(var ab=0;ab<aa.length;++ab){ag=aa[ab].updateSquaredSphereRadius(Z,ag)}}}return ag},draw:function(af,ae,ab,ad){if(!this._visible){return}var ac=this.shaderForStyleAndPass(ae,ab,ad);if(!ac){return}var Z=this.showRelated();if(Z==="asym"){return this._drawVertArrays(af,ac,this.vertArrays(),null)}var aa=this.structure().assembly(Z);return this._drawSymmetryRelated(af,ac,aa)},colorBy:function(aa,Z){console.time("BaseGeom.colorBy");this._ready=false;Z=Z||this.structure();for(var ab=0;ab<this._vertAssocs.length;++ab){this._vertAssocs[ab].recolor(aa,Z)}},setOpacity:function(ab,Z){console.time("BaseGeom.setOpacity");this._ready=false;Z=Z||this.structure();for(var aa=0;aa<this._vertAssocs.length;++aa){this._vertAssocs[aa].setOpacity(ab,Z)}console.timeEnd("BaseGeom.setOpacity")},setSelection:function(Z){console.time("BaseGeom.setSelection");this._selection=Z;this._ready=false;for(var aa=0;aa<this._vertAssocs.length;++aa){this._vertAssocs[aa].setSelection(Z)}console.timeEnd("BaseGeom.setSelection")},selection:function(){if(this._selection===null){this._selection=this.structure().createEmptyView()}return this._selection}});return X}();B=H=function(){var W=o.vec3;function V(aa,X,Y){this._gl=aa;this._vertBuffer=aa.createBuffer();this._float32Allocator=Y||null;this._ready=false;this._boundingSphere=null;var Z=this._FLOATS_PER_VERT*X;this._vertData=Y.request(Z)}V.prototype={setColor:function(Z,ac,ab,X,Y){var aa=Z*this._FLOATS_PER_VERT+this._COLOR_OFFSET;this._vertData[aa+0]=ac;this._vertData[aa+1]=ab;this._vertData[aa+2]=X;this._vertData[aa+3]=Y;this._ready=false},getColor:function(Y,X){var Z=Y*this._FLOATS_PER_VERT+this._COLOR_OFFSET;X[0]=this._vertData[Z+0];X[1]=this._vertData[Z+1];X[2]=this._vertData[Z+2];X[3]=this._vertData[Z+3];return X},setOpacity:function(Y,X){var Z=Y*this._FLOATS_PER_VERT+this._COLOR_OFFSET;this._vertData[Z+3]=X;this._ready=false},setSelected:function(Y,X){var Z=Y*this._FLOATS_PER_VERT+this._SELECT_OFFSET;this._vertData[Z]=X;this._ready=false},boundingSphere:function(){if(!this._boundingSphere){this._boundingSphere=this._calculateBoundingSphere()}return this._boundingSphere},_calculateBoundingSphere:function(){var aa=this.numVerts();if(aa===0){return null}var Y=W.create();var ac,ad;for(ad=0;ad<aa;++ad){ac=ad*this._FLOATS_PER_VERT;Y[0]+=this._vertData[ac+0];Y[1]+=this._vertData[ac+1];Y[2]+=this._vertData[ac+2]}W.scale(Y,Y,1/aa);var ae=0;for(ad=0;ad<aa;++ad){ac=ad*this._FLOATS_PER_VERT;var ab=Y[0]-this._vertData[ac+0];var Z=Y[1]-this._vertData[ac+1];var X=Y[2]-this._vertData[ac+2];ae=Math.max(ae,ab*ab+Z*Z+X*X)}return new g.Sphere(Y,Math.sqrt(ae))},destroy:function(){this._gl.deleteBuffer(this._vertBuffer);this._float32Allocator.release(this._vertData)},bindBuffers:function(){this._gl.bindBuffer(this._gl.ARRAY_BUFFER,this._vertBuffer);if(this._ready){return}this._gl.bufferData(this._gl.ARRAY_BUFFER,this._vertData,this._gl.STATIC_DRAW);this._ready=true},updateSquaredSphereRadius:function(){var X=W.create();return function(Z,Y,aa){var ab=this.boundingSphere();if(!ab){return Y}if(aa){W.transformMat4(X,ab.center(),aa);return Math.max(W.sqrDist(X,Z),Y)}var ac=ab.radius()*ab.radius();return Math.max(W.sqrDist(ab.center(),Z)+ac,Y)}}(),updateProjectionIntervals:function(){var X=W.create();return function(ab,Z,ai,ah,ac,af,ad){var Y=this.boundingSphere();if(!Y){return}if(ad){W.transformMat4(X,Y.center(),ad)}else{W.copy(X,Y.center())}var ae=W.dot(ab,X);var ag=W.dot(Z,X);var aa=W.dot(ai,X);ah.update(ae-Y.radius());ah.update(ae+Y.radius());ac.update(ag-Y.radius());ac.update(ag+Y.radius());af.update(aa-Y.radius());af.update(aa+Y.radius())}}()};return V}();v=function(){function V(Y,W,X){H.call(this,Y,W,X);this._numVerts=0;this._primitiveType=this._gl.LINES}U.derive(V,H,{_FLOATS_PER_VERT:9,_POS_OFFSET:0,_COLOR_OFFSET:3,_ID_OFFSET:7,_SELECT_OFFSET:8,numVerts:function(){return this._numVerts},setDrawAsPoints:function(W){if(W){this._primitiveType=this._gl.POINTS}else{this._primitiveType=this._gl.LINES}},addPoint:function(Z,W,Y){var X=this._FLOATS_PER_VERT*this._numVerts;this._vertData[X++]=Z[0];this._vertData[X++]=Z[1];this._vertData[X++]=Z[2];this._vertData[X++]=W[0];this._vertData[X++]=W[1];this._vertData[X++]=W[2];this._vertData[X++]=W[3];this._vertData[X++]=Y;this._vertData[X++]=0;this._numVerts+=1;this._ready=false;this._boundingSphere=null},addLine:function(Y,aa,X,Z,W,ab){this.addPoint(Y,aa,W);this.addPoint(X,Z,ab)},bindAttribs:function(W){this._gl.vertexAttribPointer(W.posAttrib,3,this._gl.FLOAT,false,this._FLOATS_PER_VERT*4,this._POS_OFFSET*4);if(W.colorAttrib!==-1){this._gl.vertexAttribPointer(W.colorAttrib,4,this._gl.FLOAT,false,this._FLOATS_PER_VERT*4,this._COLOR_OFFSET*4);this._gl.enableVertexAttribArray(W.colorAttrib)}this._gl.enableVertexAttribArray(W.posAttrib);if(W.objIdAttrib!==-1){this._gl.vertexAttribPointer(W.objIdAttrib,1,this._gl.FLOAT,false,this._FLOATS_PER_VERT*4,this._ID_OFFSET*4);this._gl.enableVertexAttribArray(W.objIdAttrib)}if(W.selectAttrib!==-1){this._gl.vertexAttribPointer(W.selectAttrib,1,this._gl.FLOAT,false,this._FLOATS_PER_VERT*4,this._SELECT_OFFSET*4);this._gl.enableVertexAttribArray(W.selectAttrib)}},releaseAttribs:function(W){this._gl.disableVertexAttribArray(W.posAttrib);if(W.colorAttrib!==-1){this._gl.disableVertexAttribArray(W.colorAttrib)}if(W.objIdAttrib!==-1){this._gl.disableVertexAttribArray(W.objIdAttrib)}if(W.selectAttrib!==-1){this._gl.disableVertexAttribArray(W.selectAttrib)}},bind:function(W){this.bindBuffers();this.bindAttribs(W)},draw:function(){this._gl.drawArrays(this._primitiveType,0,this._numVerts)}});return V}();z=T=function(){function V(aa,X,Z,Y,W){H.call(this,aa,X,Y);this._indexBuffer=aa.createBuffer();this._uint16Allocator=W;this._numVerts=0;this._maxVerts=X;this._numTriangles=0;this._indexData=W.request(Z)}U.derive(V,H,{destroy:function(){H.prototype.destroy.call(this);this._gl.deleteBuffer(this._indexBuffer);this._uint16Allocator.release(this._indexData)},setIndexData:function(X){this._ready=false;this._numTriangles=X.length/3;for(var W=0;W<X.length;++W){this._indexData[W]=X[W]}},setVertData:function(X){this._ready=false;this._numVerts=X.length/this._FLOATS_PER_VERT;for(var W=0;W<X.length;++W){this._vertData[W]=X[W]}},numVerts:function(){return this._numVerts},maxVerts:function(){return this._maxVerts},numIndices:function(){return this._numTriangles*3},addVertex:function(aa,Z,W,Y){if(this._numVerts===this._maxVerts){console.error("maximum number of vertices reached");return}var X=this._numVerts*this._FLOATS_PER_VERT;this._vertData[X++]=aa[0];this._vertData[X++]=aa[1];this._vertData[X++]=aa[2];this._vertData[X++]=Z[0];this._vertData[X++]=Z[1];this._vertData[X++]=Z[2];this._vertData[X++]=W[0];this._vertData[X++]=W[1];this._vertData[X++]=W[2];this._vertData[X++]=W[3];this._vertData[X++]=Y;this._vertData[X++]=0;this._numVerts+=1;this._ready=false},_FLOATS_PER_VERT:12,_BYTES_PER_VERT:12*4,_OBJID_OFFSET:10,_OBJID_BYTE_OFFSET:10*4,_SELECT_OFFSET:11,_SELECT_BYTE_OFFSET:11*4,_COLOR_OFFSET:6,_COLOR_BYTE_OFFSET:6*4,_NORMAL_OFFSET:3,_NORMAL_BYTE_OFFSET:3*4,_POS_OFFSET:0,_POS_BYTE_OFFSET:0*4,addTriangle:function(Z,X,W){var Y=3*this._numTriangles;if(Y+2>=this._indexData.length){return}this._indexData[Y++]=Z;this._indexData[Y++]=X;this._indexData[Y++]=W;this._numTriangles+=1;this._ready=false},bindBuffers:function(){var W=this._ready;var X=this._gl;H.prototype.bindBuffers.call(this);X.bindBuffer(X.ELEMENT_ARRAY_BUFFER,this._indexBuffer);if(W){return}X.bufferData(X.ELEMENT_ARRAY_BUFFER,this._indexData,X.STATIC_DRAW)},bindAttribs:function(X){var Y=this._gl;var W=this._BYTES_PER_VERT;Y.enableVertexAttribArray(X.posAttrib);Y.vertexAttribPointer(X.posAttrib,3,Y.FLOAT,false,W,this._POS_BYTE_OFFSET);if(X.normalAttrib!==-1){Y.enableVertexAttribArray(X.normalAttrib);Y.vertexAttribPointer(X.normalAttrib,3,Y.FLOAT,false,W,this._NORMAL_BYTE_OFFSET)}if(X.colorAttrib!==-1){Y.vertexAttribPointer(X.colorAttrib,4,Y.FLOAT,false,W,this._COLOR_BYTE_OFFSET);Y.enableVertexAttribArray(X.colorAttrib)}if(X.objIdAttrib!==-1){Y.vertexAttribPointer(X.objIdAttrib,1,Y.FLOAT,false,W,this._OBJID_BYTE_OFFSET);Y.enableVertexAttribArray(X.objIdAttrib)}if(X.selectAttrib!==-1){Y.vertexAttribPointer(X.selectAttrib,1,Y.FLOAT,false,W,this._SELECT_BYTE_OFFSET);Y.enableVertexAttribArray(X.selectAttrib)}},releaseAttribs:function(W){var X=this._gl;X.disableVertexAttribArray(W.posAttrib);if(W.colorAttrib!==-1){X.disableVertexAttribArray(W.colorAttrib)}if(W.normalAttrib!==-1){X.disableVertexAttribArray(W.normalAttrib)}if(W.objIdAttrib!==-1){X.disableVertexAttribArray(W.objIdAttrib)}if(W.selectAttrib!==-1){X.disableVertexAttribArray(W.selectAttrib)}},bind:function(W){this.bindBuffers();this.bindAttribs(W)},draw:function(){var W=this._gl;W.drawElements(W.TRIANGLES,this._numTriangles*3,W.UNSIGNED_SHORT,0)}});return V}();G=function(V){function X(Z,ab,Y,aa){V.call(this,ab,Y,aa);this._chain=Z}U.derive(X,V,{chain:function(){return this._chain},drawSymmetryRelated:function(ab,aa,Z){this.bind(aa);for(var Y=0;Y<Z.length;++Y){ab.bind(aa,Z[Y]);this._gl.uniform1i(aa.symId,Y);this.draw()}this.releaseAttribs(aa)}});function W(aa,ad,Z,ac,ab,Y){T.call(this,ad,Z,ac,ab,Y);this._chain=aa}U.derive(W,T,{chain:function(){return this._chain}});W.prototype.drawSymmetryRelated=X.prototype.drawSymmetryRelated;return{LineChainData:X,MeshChainData:W}}(v);x=function(Y,V){var W=Y.MeshChainData;function X(ab,aa,Z){e.call(this,ab);this._indexedVAs=[];this._float32Allocator=aa;this._uint16Allocator=Z;this._remainingVerts=null;this._remainingIndices=null}U.derive(X,e,{_boundedVertArraySize:function(Z){return Math.min(65536,Z)},addChainVertArray:function(aa,Z,ab){this._remainingVerts=Z;this._remainingIndices=ab;var ac=new W(aa.name(),this._gl,this._boundedVertArraySize(Z),ab,this._float32Allocator,this._uint16Allocator);this._indexedVAs.push(ac);return ac},addVertArray:function(Z,aa){this._remainingVerts=Z;this._remainingIndices=aa;var ab=new V(this._gl,this._boundedVertArraySize(Z),aa,this._float32Allocator,this._uint16Allocator);this._indexedVAs.push(ab);return ab},vertArrayWithSpaceFor:function(Z){var ab=this._indexedVAs[this._indexedVAs.length-1];var aa=ab.maxVerts()-ab.numVerts();if(aa>=Z){return ab}this._remainingVerts-=ab.numVerts();this._remainingIndices-=ab.numIndices();Z=this._boundedVertArraySize(this._remainingVerts);var ac=null;if(ab instanceof W){ac=new W(ab.chain(),this._gl,Z,this._remainingIndices,this._float32Allocator,this._uint16Allocator)}else{ac=new V(this._gl,Z,this._remainingIndices,this._float32Allocator,this._uint16Allocator)}this._indexedVAs.push(ac);return ac},vertArray:function(Z){return this._indexedVAs[Z]},destroy:function(){e.prototype.destroy.call(this);for(var Z=0;Z<this._indexedVAs.length;++Z){this._indexedVAs[Z].destroy()}this._indexedVAs=[]},numVerts:function(){return this._indexedVAs[0].numVerts()},shaderForStyleAndPass:function(ac,Z,ab){if(ab==="normal"){if(Z==="hemilight"){return ac.hemilight}else{return ac.phong}}if(ab==="select"){return ac.select}if(ab==="outline"){return ac.outline}var aa=ac[ab];return aa!==undefined?aa:null},_drawVertArrays:function(ad,ab,ac,Z){var aa;if(Z){for(aa=0;aa<ac.length;++aa){ac[aa].drawSymmetryRelated(ad,ab,Z)}}else{ad.bind(ab);this._gl.uniform1i(ab.symId,255);for(aa=0;aa<ac.length;++aa){ac[aa].bind(ab);ac[aa].draw();ac[aa].releaseAttribs(ab)}}},vertArrays:function(){return this._indexedVAs},addVertex:function(ad,ac,Z,aa){var ab=this._indexedVAs[0];ab.addVertex(ad,ac,Z,aa)},addTriangle:function(ab,aa,Z){var ac=this._indexedVAs[0];ac.addTriangle(ab,aa,Z)}});return X}(G,z);E=function(V){var X=V.LineChainData;function W(Z,Y){e.call(this,Z);this._vertArrays=[];this._float32Allocator=Y;this._lineWidth=0.5;this._pointSize=1}U.derive(W,e,{addChainVertArray:function(Z,Y){var aa=new X(Z.name(),this._gl,Y,this._float32Allocator);this._vertArrays.push(aa);return aa},setLineWidth:function(Y){this._lineWidth=Y},setPointSize:function(Y){this._pointSize=Y},vertArrays:function(){return this._vertArrays},shaderForStyleAndPass:function(aa,Y,Z){if(Z==="outline"){return aa.selectLines}if(Z==="select"){return aa.select}return aa.lines},destroy:function(){e.prototype.destroy.call(this);for(var Y=0;Y<this._vertArrays.length;++Y){this._vertArrays[Y].destroy()}this._vertArrays=[]},_drawVertArrays:function(ab,aa,ad,Y){var ac=ab.upsamplingFactor();if(aa.selectAttrib!==-1){ac=4*ab.upsamplingFactor()}var Z;if(Y){ab.bind(aa);this._gl.lineWidth(ac*this._lineWidth);if(aa.pointSize){this._gl.uniform1f(aa.pointSize,ac*this._pointSize)}for(Z=0;Z<ad.length;++Z){ad[Z].drawSymmetryRelated(ab,aa,Y)}}else{ab.bind(aa);this._gl.lineWidth(ac*this._lineWidth);this._gl.uniform1i(aa.symId,255);if(aa.pointSize){this._gl.uniform1f(aa.pointSize,ac*this._pointSize)}for(Z=0;Z<ad.length;++Z){ad[Z].bind(aa);ad[Z].draw();ad[Z].releaseAttribs(aa)}}},vertArray:function(){return this._va}});return W}(G);t=function(){function V(X,Y){this._structure=X;this._assocs=[];this._callBeginEnd=Y}V.prototype={addAssoc:function(Y,X,aa,Z){this._assocs.push({atom:Y,vertexArray:X,vertStart:aa,vertEnd:Z})},recolor:function(ak,ah){var Z=new Float32Array(ah.atomCount()*4);if(this._callBeginEnd){ak.begin(this._structure)}var Y={};ah.eachAtom(function(al,ai){Y[al.index()]=ai;ak.colorFor(al,Z,ai*4)});if(this._callBeginEnd){ak.end(this._structure)}for(var ab=0;ab<this._assocs.length;++ab){var ad=this._assocs[ab];var ae=Y[ad.atom.index()];if(ae===undefined){continue}var X=Z[ae*4+0],ac=Z[ae*4+1],ag=Z[ae*4+2],aj=Z[ae*4+3];var af=ad.vertexArray;for(var aa=ad.vertStart;aa<ad.vertEnd;++aa){af.setColor(aa,X,ac,ag,aj)}}},getColorForAtom:function(Z,X){for(var Y=0;Y<this._assocs.length;++Y){var aa=this._assocs[Y];if(aa.atom.full()===Z.full()){return aa.vertexArray.getColor(aa.vertStart,X)}}return null},setSelection:function(Y){var ad={};Y.eachAtom(function(af){ad[af.index()]=true});for(var aa=0;aa<this._assocs.length;++aa){var ae=this._assocs[aa];var X=ad[ae.atom.index()];var ab=X!==true?0:1;var ac=ae.vertexArray;for(var Z=ae.vertStart;Z<ae.vertEnd;++Z){ac.setSelected(Z,ab)}}},setOpacity:function(ae,Y){var ac={};Y.eachAtom(function(af){ac[af.index()]=true});for(var aa=0;aa<this._assocs.length;++aa){var ad=this._assocs[aa];var X=ac[ad.atom.index()];if(X!==true){continue}var ab=ad.vertexArray;for(var Z=ad.vertStart;Z<ad.vertEnd;++Z){ab.setOpacity(Z,ae)}}}};function W(X,Y,Z){this._structure=X;this._assocs=[];this._callBeginEnd=Z;this._interpolation=Y||1;this._perResidueColors={}}W.prototype={setPerResidueColors:function(Y,X){this._perResidueColors[Y]=X},addAssoc:function(X,ab,aa,Z,Y){this._assocs.push({traceIndex:X,slice:aa,vertStart:Z,vertEnd:Y,vertexArray:ab})},recolor:function(ao,am){if(this._callBeginEnd){ao.begin(this._structure)}var Z=[];var ad,aa;var al=this._structure.backboneTraces();console.assert(this._perResidueColors,"per-residue colors must be set for recoloring to work");for(ad=0;ad<al.length;++ad){var ac=this._perResidueColors[ad];console.assert(ac,"no per-residue colors. Seriously, man?");var af=0;var ab=al[ad];for(aa=0;aa<ab.length();++aa){if(!am.containsResidue(ab.residueAt(aa))){af+=4;continue}ao.colorFor(ab.centralAtomAt(aa),ac,af);af+=4}if(this._interpolation>1){Z.push(w.interpolateColor(ac,this._interpolation))}else{Z.push(ac)}}for(ad=0;ad<this._assocs.length;++ad){var ag=this._assocs[ad];var ah=ag.slice;var Y=Z[ag.traceIndex];var X=Y[ah*4],ae=Y[ah*4+1],ak=Y[ah*4+2],an=Y[ah*4+3];var aj=ag.vertexArray;for(aa=ag.vertStart;aa<ag.vertEnd;++aa){aj.setColor(aa,X,ae,ak,an)}}if(this._callBeginEnd){ao.end(this._structure)}},getColorForAtom:function(ad,Y){var ac,Z;var af=this._structure.backboneTraces();var X=ad.full().residue();for(ac=0;ac<af.length;++ac){var ab=this._perResidueColors[ac];var ae=0;var aa=af[ac];for(Z=0;Z<aa.length();++Z){if(X===aa.residueAt(Z).full()){Y[0]=ab[ae+0];Y[1]=ab[ae+1];Y[2]=ab[ae+2];Y[3]=ab[ae+3];return Y}ae+=4}}return null},setSelection:function(ak){var af=[];var ac,Z;var aj=this._structure.backboneTraces();for(ac=0;ac<aj.length;++ac){var aa=new Float32Array(this._perResidueColors[ac].length);var ad=0;var ab=aj[ac];for(Z=0;Z<ab.length();++Z){var Y=ak.containsResidue(ab.residueAt(Z))?1:0;aa[ad]=Y;ad+=1}if(this._interpolation>1){af.push(g.interpolateScalars(aa,this._interpolation))}else{af.push(aa)}}for(ac=0;ac<this._assocs.length;++ac){var ae=this._assocs[ac];var ag=ae.slice;var X=af[ae.traceIndex];var al=X[ag];var ah=ae.vertexArray;for(Z=ae.vertStart;Z<ae.vertEnd;++Z){ah.setSelected(Z,al)}}},setOpacity:function(Y,ak){var Z=[];var ad,aa;var aj=this._structure.backboneTraces();for(ad=0;ad<aj.length;++ad){var ac=this._perResidueColors[ad];var ae=0;var ab=aj[ad];for(aa=0;aa<ab.length();++aa){if(!ak.containsResidue(ab.residueAt(aa))){ae+=4;continue}ac[ae+3]=Y;ae+=4}if(this._interpolation>1){Z.push(w.interpolateColor(ac,this._interpolation))}else{Z.push(ac)}}for(ad=0;ad<this._assocs.length;++ad){var af=this._assocs[ad];var ag=af.slice;var X=Z[af.traceIndex];var al=X[ag*4+3];var ah=af.vertexArray;for(aa=af.vertStart;aa<af.vertEnd;++aa){ah.setOpacity(aa,al)}}}};return{TraceVertexAssoc:W,AtomVertexAssoc:V}}();i=function(Y,ag,ao,ad){var aJ=o.vec3;var aI=o.vec4;var X=o.mat3;var aA=Y.TubeProfile;var ac=Y.ProtoSphere;var ak=Y.ProtoCylinder;var ae=ad.TraceVertexAssoc;var V=ad.AtomVertexAssoc;var aj=w.interpolateColor;var aE={};var Z=0.7071;var ah=[-Z,-Z,0,Z,-Z,0,Z,Z,0,-Z,Z,0];var af=[-6*Z,-0.9*Z,0,-5.8*Z,-1*Z,0,5.8*Z,-1*Z,0,6*Z,-0.9*Z,0,6*Z,0.9*Z,0,5.8*Z,1*Z,0,-5.8*Z,1*Z,0,-6*Z,0.9*Z,0];var aH=[-10*Z,-0.9*Z,0,-9.8*Z,-1*Z,0,9.8*Z,-1*Z,0,10*Z,-0.9*Z,0,10*Z,0.9*Z,0,9.8*Z,1*Z,0,-9.8*Z,1*Z,0,-10*Z,0.9*Z,0];var am=function(){var aN=aJ.create(),aM=aJ.create(),aO=aJ.create();return function(aR,aU,aT,aQ){aU=Math.max(aU,1);aT=Math.min(aQ-1,aT);var aS=3*(aU-1);aJ.set(aN,aR[aS],aR[aS+1],aR[aS+2]);aJ.set(aO,aR[3*aU],aR[3*aU+1],aR[3*aU+2]);for(var aP=aU;aP<aT;++aP){aS=3*(aP+1);aJ.set(aM,aR[aS],aR[aS+1],aR[aS+2]);aR[3*aP+0]=aM[0]*0.25+aO[0]*0.5+aN[0]*0.25;aR[3*aP+1]=aM[1]*0.25+aO[1]*0.5+aN[1]*0.25;aR[3*aP+2]=aM[2]*0.25+aO[2]*0.5+aN[2]*0.25;aJ.copy(aN,aO);aJ.copy(aO,aM)}}}();var an=function(){var aM=aI.fromValues(0,0,0,1);return function(aS,aV,aO,aP){var aN=aP.atomCount();var aU=aO.idPool.getContinuousRange(aN);aS.addIdRange(aU);var aQ=aO.protoSphere.numVerts();var aR=aO.protoSphere.numIndices();var aT=1.5*aO.radiusMultiplier;aS.addChainVertArray(aP,aQ*aN,aR*aN);aP.eachAtom(function(aY){var aX=aS.vertArrayWithSpaceFor(aQ);aO.color.colorFor(aY,aM,0);var a0=aX.numVerts();var aW=aU.nextId({geom:aS,atom:aY});aO.protoSphere.addTransformed(aX,aY.pos(),aT,aM,aW);var aZ=aX.numVerts();aV.addAssoc(aY,aX,a0,aZ)})}}();aE.spheres=function(aN,aR,aQ){console.time("spheres");var aM=new ac(aQ.sphereDetail,aQ.sphereDetail);aQ.protoSphere=aM;var aO=new ag(aR,aQ.float32Allocator,aQ.uint16Allocator);var aP=new V(aN,true);aO.addVertAssoc(aP);aO.setShowRelated(aQ.showRelated);aQ.color.begin(aN);aN.eachChain(function(aS){an(aO,aP,aQ,aS)});aQ.color.end(aN);console.timeEnd("spheres");return aO};var az=function(){var aR=aJ.create(),aO=aJ.create();var aN=aI.fromValues(0,0,0,1);var aQ=aJ.create(),aM=aJ.create();var aP=X.create();return function(aW,aY,aT,aU){var aS=aU.atomCount();var aV=0;aU.eachAtom(function(a1){aV+=a1.bonds().length});var a0=aS*aT.protoSphere.numVerts()+aV*aT.protoCyl.numVerts();var aZ=aS*aT.protoSphere.numIndices()+aV*aT.protoCyl.numIndices();aW.addChainVertArray(aU,a0,aZ);var aX=aT.idPool.getContinuousRange(aS);aW.addIdRange(aX);aU.eachAtom(function(a4){var a1=aT.protoSphere.numVerts()+a4.bondCount()*aT.protoCyl.numVerts();var a3=aW.vertArrayWithSpaceFor(a1);var a6=a3.numVerts();var a2=aX.nextId({geom:aW,atom:a4});aT.color.colorFor(a4,aN,0);aT.protoSphere.addTransformed(a3,a4.pos(),aT.radius,aN,a2);a4.eachBond(function(a8){a8.mid_point(aR);aJ.sub(aO,a4.pos(),aR);var a7=aJ.length(aO);aJ.scale(aO,aO,1/a7);g.buildRotation(aP,aO,aQ,aM,false);aJ.add(aR,aR,a4.pos());aJ.scale(aR,aR,0.5);aT.protoCyl.addTransformed(a3,aR,a7,aT.radius,aP,aN,aN,a2,a2)});var a5=a3.numVerts();aY.addAssoc(a4,a3,a6,a5)})}}();aE.ballsAndSticks=function(aN,aS,aQ){console.time("ballsAndSticks");var aP=new V(aN,true);var aM=new ac(aQ.sphereDetail,aQ.sphereDetail);var aO=new ak(aQ.arcDetail);aQ.protoSphere=aM;aQ.protoCyl=aO;var aR=new ag(aS,aQ.float32Allocator,aQ.uint16Allocator);aR.addVertAssoc(aP);aR.setShowRelated(aQ.showRelated);aQ.color.begin(aN);aN.eachChain(function(aT){az(aR,aP,aQ,aT)});aQ.color.end(aN);console.timeEnd("ballsAndSticks");return aR};var ar=function(){var aM=aI.fromValues(0,0,0,1);return function(aR,aQ,aN,aP){var aT=aN.atomCount();var aS=aP.idPool.getContinuousRange(aT);aR.addIdRange(aS);var aO=aR.addChainVertArray(aN,aT);aO.setDrawAsPoints(true);aN.eachAtom(function(aV){var aX=aO.numVerts();aP.color.colorFor(aV,aM,0);var aU=aS.nextId({geom:aR,atom:aV});aO.addPoint(aV.pos(),aM,aU);var aW=aO.numVerts();aQ.addAssoc(aV,aO,aX,aW)})}}();aE.points=function(aM,aQ,aO){console.time("points");var aN=new V(aM,true);aO.color.begin(aM);var aP=new ao(aQ,aO.float32Allocator);aP.setPointSize(aO.pointSize);aP.addVertAssoc(aN);aP.setShowRelated(aO.showRelated);aM.eachChain(function(aR){ar(aP,aN,aR,aO)});aO.color.end(aM);console.timeEnd("points");return aP};var aw=function(){var aN=aJ.create();var aM=aI.fromValues(0,0,0,1);return function(aT,aS,aP,aR){var aO=0;var aV=aP.atomCount();var aU=aR.idPool.getContinuousRange(aV);aT.addIdRange(aU);aP.eachAtom(function(aX){var aW=aX.bonds().length;if(aW){aO+=aW}else{aO+=3}});var aQ=aT.addChainVertArray(aP,aO*2);aP.eachAtom(function(aY){var a0=aQ.numVerts();var aW=aU.nextId({geom:aT,atom:aY});if(aY.bonds().length){aY.eachBond(function(a2){a2.mid_point(aN);aR.color.colorFor(aY,aM,0);aQ.addLine(aY.pos(),aM,aN,aM,aW,aW)})}else{var aX=0.2;var a1=aY.pos();aR.color.colorFor(aY,aM,0);aQ.addLine([a1[0]-aX,a1[1],a1[2]],aM,[a1[0]+aX,a1[1],a1[2]],aM,aW,aW);aQ.addLine([a1[0],a1[1]-aX,a1[2]],aM,[a1[0],a1[1]+aX,a1[2]],aM,aW,aW);aQ.addLine([a1[0],a1[1],a1[2]-aX],aM,[a1[0],a1[1],a1[2]+aX],aM,aW,aW)}var aZ=aQ.numVerts();aS.addAssoc(aY,aQ,a0,aZ)})}}();aE.lines=function(aM,aQ,aO){console.time("lines");var aN=new V(aM,true);aO.color.begin(aM);var aP=new ao(aQ,aO.float32Allocator);aP.setLineWidth(aO.lineWidth);aP.addVertAssoc(aN);aP.setShowRelated(aO.showRelated);aM.eachChain(function(aR){aw(aP,aN,aR,aO)});aO.color.end(aM);console.timeEnd("lines");return aP};var aa=function(aN){var aM=0;for(var aO=0;aO<aN.length;++aO){aM+=2*(aN[aO].length()-1)}return aM};var ax=function(){var aQ=aI.fromValues(0,0,0,1),aP=aI.fromValues(0,0,0,1);var aO=aJ.create(),aN=aJ.create();return function aM(aX,a2,aZ,aY,aW,aR){a2.addAssoc(aY,aZ,0,aZ.numVerts(),aZ.numVerts()+1);var aS=aR.float32Allocator.request(aW.length()*4);var a1=aR.idPool.getContinuousRange(aW.length());aX.addIdRange(a1);var aU=a1.nextId({geom:aX,atom:aW.centralAtomAt(0)});var a0;for(var aV=1;aV<aW.length();++aV){aR.color.colorFor(aW.centralAtomAt(aV-1),aQ,0);aS[(aV-1)*4+0]=aQ[0];aS[(aV-1)*4+1]=aQ[1];aS[(aV-1)*4+2]=aQ[2];aS[(aV-1)*4+3]=aQ[3];aR.color.colorFor(aW.centralAtomAt(aV),aP,0);aW.posAt(aO,aV-1);aW.posAt(aN,aV);a0=a1.nextId({geom:aX,atom:aW.centralAtomAt(aV)});aZ.addLine(aO,aQ,aN,aP,aU,a0);aU=a0;a0=null;var aT=aZ.numVerts();a2.addAssoc(aY,aZ,aV,aT-1,aT+(aV===aW.length()-1?0:1))}aS[aW.length()*4-4]=aP[0];aS[aW.length()*4-3]=aP[1];aS[aW.length()*4-2]=aP[2];aS[aW.length()*4-1]=aP[3];a2.setPerResidueColors(aY,aS);return aY+1}}();var au=function(aQ,aT,aM,aR,aN){var aO=aN.backboneTraces();var aU=aa(aO);var aS=aQ.addChainVertArray(aN,aU);for(var aP=0;aP<aO.length;++aP){aR=ax(aQ,aT,aS,aR,aO[aP],aM)}return aR};aE.lineTrace=function(aM,aR,aP){console.time("lineTrace");var aO=new ae(aM,1,true);aP.color.begin(aM);var aQ=new ao(aR,aP.float32Allocator);aQ.setLineWidth(aP.lineWidth);var aN=0;aM.eachChain(function(aS){aN=au(aQ,aO,aP,aN,aS)});aQ.addVertAssoc(aO);aQ.setShowRelated(aP.showRelated);aP.color.end(aM);console.timeEnd("lineTrace");return aQ};var W=function(aN,aP){var aM=0;for(var aO=0;aO<aN.length;++aO){aM+=2*(aP*(aN[aO].length()-1)+1)}return aM};var ab=function(){var aN=aJ.create(),aM=aJ.create();var aP=aI.fromValues(0,0,0,1),aO=aI.fromValues(0,0,0,1);return function(a0,aT,aU,a4,aW,a8){var a3=a8.fullTraceIndex(0);var aZ=a4.float32Allocator.request(a8.length()*3);var a1=a4.float32Allocator.request(a8.length()*4);var bb=[];var a9;var a7=a4.idPool.getContinuousRange(a8.length());a0.addIdRange(a7);for(a9=0;a9<a8.length();++a9){var aS=a8.centralAtomAt(a9);a8.smoothPosAt(aN,a9,a4.strength);a4.color.colorFor(aS,a1,4*a9);aZ[a9*3]=aN[0];aZ[a9*3+1]=aN[1];aZ[a9*3+2]=aN[2];bb.push(a7.nextId({geom:a0,atom:aS}))}var a2=bb[0],aV=0;var a5=g.catmullRomSpline(aZ,a8.length(),a4.splineDetail,a4.strength,false,a4.float32Allocator);var a6=aj(a1,a4.splineDetail);var aQ=aU.numVerts();aT.addAssoc(aW,aU,a3,aQ,aQ+1);var aR=Math.floor(a4.splineDetail/2);var ba=g.catmullRomSplineNumPoints(a8.length(),a4.splineDetail,false);for(a9=1;a9<ba;++a9){aN[0]=a5[3*(a9-1)];aN[1]=a5[3*(a9-1)+1];aN[2]=a5[3*(a9-1)+2];aM[0]=a5[3*(a9-0)];aM[1]=a5[3*(a9-0)+1];aM[2]=a5[3*(a9-0)+2];aP[0]=a6[4*(a9-1)+0];aP[1]=a6[4*(a9-1)+1];aP[2]=a6[4*(a9-1)+2];aP[3]=a6[4*(a9-1)+3];aO[0]=a6[4*(a9-0)+0];aO[1]=a6[4*(a9-0)+1];aO[2]=a6[4*(a9-0)+2];aO[3]=a6[4*(a9-0)+3];var aY=Math.floor((a9+aR)/a4.splineDetail);aV=bb[Math.min(bb.length-1,aY)];aU.addLine(aN,aP,aM,aO,a2,aV);a2=aV;var aX=aU.numVerts();aT.addAssoc(aW,aU,a3+a9,aX-1,aX+(a9===a8.length-1?0:1))}aT.setPerResidueColors(aW,a1);a4.float32Allocator.release(aZ);a4.float32Allocator.release(a5);return aW+1}}();var aD=function(aQ,aT,aM,aN,aR){var aO=aN.backboneTraces();var aU=W(aO,aM.splineDetail);var aS=aQ.addChainVertArray(aN,aU);for(var aP=0;aP<aO.length;++aP){aR=ab(aQ,aT,aS,aM,aR,aO[aP])}return aR};aE.sline=function(aM,aR,aP){console.time("sline");aP.color.begin(aM);var aO=new ae(aM,aP.splineDetail,1,true);var aQ=new ao(aR,aP.float32Allocator);aQ.addVertAssoc(aO);aQ.setLineWidth(aP.lineWidth);aQ.setShowRelated(aP.showRelated);var aN=0;aM.eachChain(function(aS){aN=aD(aQ,aO,aP,aS,aN)});aP.color.end(aM);console.timeEnd("sline");return aQ};var ai=function(aN,aQ,aP){var aM=0;for(var aO=0;aO<aN.length;++aO){aM+=aN[aO].length()*aQ;aM+=(aN[aO].length()-1)*aP}return aM};var ap=function(aM,aQ,aP){var aO=0;for(var aN=0;aN<aM.length;++aN){aO+=aM[aN].length()*aQ;aO+=(aM[aN].length()-1)*aP}return aO};var aL=function(aP,aS,aM,aQ,aN){var aR=aN.backboneTraces();var aU=ai(aR,aM.protoSphere.numVerts(),aM.protoCyl.numVerts());var aT=ap(aR,aM.protoSphere.numIndices(),aM.protoCyl.numIndices());aP.addChainVertArray(aN,aU,aT);for(var aO=0;aO<aR.length;++aO){av(aP,aS,aR[aO],aQ,aM);aQ++}return aQ};aE.trace=function(aM,aR,aP){console.time("trace");aP.protoCyl=new ak(aP.arcDetail);aP.protoSphere=new ac(aP.sphereDetail,aP.sphereDetail);var aQ=new ag(aR,aP.float32Allocator,aP.uint16Allocator);var aO=new ae(aM,1,true);aQ.addVertAssoc(aO);aQ.setShowRelated(aP.showRelated);aP.color.begin(aM);var aN=0;aM.eachChain(function(aS){aN=aL(aQ,aO,aP,aN,aS)});aP.color.end(aM);console.timeEnd("trace");return aQ};var aB=function(aO,aQ,aS){var aN=0;for(var aP=0;aP<aO.length;++aP){var aM=((aO[aP].length()-1)*aS+1)*aQ;var aR=Math.ceil((aM+2)/65536);aN+=aM+(aR-1)*aQ;aN+=2}return aN};var aq=function(aM,aO,aQ){var aP=0;for(var aN=0;aN<aM.length;++aN){aP+=(aM[aN].length()*aQ-1)*aO*6;aP+=2*3*aO}return aP};var aF=function(){var aQ=X.create();var aN=aJ.create(),aR=aJ.create(),aP=aJ.create();var aM=aJ.create();var aO=aI.create();return function(a3,aU,a5,a2){var aY=a2.radius*1.8;var aX=a2.protoCyl.numVerts()+2*a2.protoSphere.numVerts();for(var a8=0;a8<a5.length;++a8){var a9=a5[a8];var a7=a2.idPool.getContinuousRange(a9.length());a3.addIdRange(a7);for(var a6=0;a6<a9.length();++a6){var aV=a3.vertArrayWithSpaceFor(aX);var aS=aV.numVerts();var aT=a9.residueAt(a6);var a4=aT.name();var a0=aT.atom("C3'");var ba=null;if(a4==="A"||a4==="G"||a4==="DA"||a4==="DG"){ba=aT.atom("N1")}else{ba=aT.atom("N3")}if(ba===null||a0===null){continue}var a1=a7.nextId({geom:a3,atom:ba});aJ.add(aM,a0.pos(),ba.pos());aJ.scale(aM,aM,0.5);a2.color.colorFor(ba,aO,0);aJ.sub(aP,ba.pos(),a0.pos());var aW=aJ.length(aP);aJ.scale(aP,aP,1/aW);g.buildRotation(aQ,aP,aR,aN,false);a2.protoCyl.addTransformed(aV,aM,aW,aY,aQ,aO,aO,a1,a1);a2.protoSphere.addTransformed(aV,ba.pos(),aY,aO,a1);a2.protoSphere.addTransformed(aV,a0.pos(),aY,aO,a1);var aZ=aV.numVerts();console.assert(aZ<=65536,"too many vertices");aU.addAssoc(ba,aV,aS,aZ)}}}}();var al=function(aV,aY,aR,aM,aW,aN){var aX=aN.backboneTraces();var a0=aB(aX,aM.arcDetail*4,aM.splineDetail);var aZ=aq(aX,aM.arcDetail*4,aM.splineDetail);var aP=[];var aU=aM.protoCyl.numVerts()+2*aM.protoSphere.numVerts();var aQ=aM.protoCyl.numIndices()+2*aM.protoSphere.numIndices();for(var aT=0;aT<aX.length;++aT){var aS=aX[aT];if(aS.residueAt(0).isNucleotide()){aP.push(aS);a0+=aS.length()*aU;aZ+=aS.length()*aQ}}aV.addChainVertArray(aN,a0,aZ);for(var aO=0;aO<aX.length;++aO){aW=aC(aV,aY,aX[aO],aW,aM)}aF(aV,aR,aP,aM);return aW};aE.cartoon=function(aN,aT,aR){console.time("cartoon");aR.arrowSkip=Math.floor(aR.splineDetail*3/4);aR.coilProfile=new aA(ah,aR.arcDetail,1);aR.arrowProfile=new aA(aH,aR.arcDetail/2,0.1);aR.helixProfile=new aA(af,aR.arcDetail/2,0.1);aR.strandProfile=new aA(af,aR.arcDetail/2,0.1);aR.protoCyl=new ak(aR.arcDetail*4);aR.protoSphere=new ac(aR.arcDetail*4,aR.arcDetail*4);var aS=new ag(aT,aR.float32Allocator,aR.uint16Allocator);var aQ=new ae(aN,aR.splineDetail,true);aS.addVertAssoc(aQ);aS.setShowRelated(aR.showRelated);aR.color.begin(aN);var aP=0;var aO=aN.select({anames:["N1","N3"]});var aM=new V(aO,true);aS.addVertAssoc(aM);aN.eachChain(function(aU){aP=al(aS,aQ,aM,aR,aP,aU)});aR.color.end(aN);return aS};aE.surface=function(){var aO=aJ.create(),aN=aJ.create(),aM=aI.fromValues(0.8,0.8,0.8,1);return function(aV,aY,aP){var aS=0;aV.getUint32(0);aS+=4;var a2=aV.getUint32(aS);aS+=4;var aR=4*6;var a0=aR*a2+aS;var aQ=aV.getUint32(a0);var aX=new ag(aY,aP.float32Allocator,aP.uint16Allocator);aX.setShowRelated("asym");var a1=aX.addVertArray(a2,aQ*3);var aU;for(aU=0;aU<a2;++aU){aJ.set(aO,aV.getFloat32(aS+0),aV.getFloat32(aS+4),aV.getFloat32(aS+8));aS+=12;aJ.set(aN,aV.getFloat32(aS+0),aV.getFloat32(aS+4),aV.getFloat32(aS+8));aS+=12;a1.addVertex(aO,aN,aM,0)}aS=a0+4;for(aU=0;aU<aQ;++aU){var aZ=aV.getUint32(aS+0),aW=aV.getUint32(aS+4),aT=aV.getUint32(aS+8);aS+=12;a1.addTriangle(aZ-1,aT-1,aW-1)}return aX}}();var ay=function(){var aN=X.create();var aM=aJ.create();return function(aX,aW,aQ,aZ,aY,aR,aV,aT,aO,aS,aP){var aU=aO.coilProfile;if(aZ!=="C"&&!aO.forceTube){if(aZ==="H"){aU=aO.helixProfile}else{if(aZ==="E"){aU=aO.strandProfile}else{if(aZ==="A"){aU=aO.arrowProfile}}}}else{if(aT){g.ortho(aQ,aY)}else{aJ.cross(aQ,aM,aY)}}g.buildRotation(aN,aY,aQ,aM,true);aU.addTransformed(aX,aW,aV,aN,aR,aT,aS,aP)}}();var aG=function(){var aO=aJ.create();var aN=aJ.create(),aM=aJ.create();return function(aW,aU,aQ,aV,a0,a1,aY,aP){var aZ=null,aR=null;var aS=aU.length();aJ.set(aM,0,0,0);for(var aT=0;aT<aS;++aT){a1.push(aY.nextId({geom:aW,atom:aU.centralAtomAt(aT)}));aU.smoothPosAt(aO,aT,aP.strength);aV[aT*3]=aO[0];aV[aT*3+1]=aO[1];aV[aT*3+2]=aO[2];aU.smoothNormalAt(aN,aT,aP.strength);var aX=aU.centralAtomAt(aT);aP.color.colorFor(aX,aQ,aT*4);if(aJ.dot(aN,aM)<0){aJ.scale(aN,aN,-1)}if(aU.residueAt(aT).ss()==="E"&&!aP.forceTube){if(aZ===null){aZ=aT}aR=aT}if(aU.residueAt(aT).ss()==="C"&&aZ!==null){am(aV,aZ,aR,aS);am(a0,aZ,aR,aS);aZ=null;aR=null}a0[aT*3]=aV[3*aT]+aN[0]+aM[0];a0[aT*3+1]=aV[3*aT+1]+aN[1]+aM[1];a0[aT*3+2]=aV[3*aT+2]+aN[2]+aM[2];aJ.copy(aM,aN)}}}();function at(aP,aN,aM){for(var aO=0;aO<aM-1;++aO){aP.addTriangle(aN,aN+1+aO,aN+2+aO)}aP.addTriangle(aN,aN+aM,aN+1)}function aK(aQ,aO,aN){var aM=aO+aN;for(var aP=0;aP<aN-1;++aP){aQ.addTriangle(aM,aO+aP+1,aO+aP)}aQ.addTriangle(aM,aO,aO+aN-1)}var aC=function(){var aP=aJ.create(),aQ=aJ.create(),aM=aI.fromValues(0,0,0,1),aO=aJ.create(),aN=aJ.create();return function(bi,aW,a6,bv,a9){var bo=aB([a6],a9.arcDetail*4,a9.splineDetail);var a1=a9.float32Allocator.request(a6.length()*3);var bl=a9.float32Allocator.request(a6.length()*4);var a3=a9.float32Allocator.request(a6.length()*3);var be=[];var bp=a9.idPool.getContinuousRange(a6.length());bi.addIdRange(bp);aG(bi,a6,bl,a1,a3,be,bp,a9);var aY=bi.vertArrayWithSpaceFor(bo);var aS=g.catmullRomSpline(a1,a6.length(),a9.splineDetail,a9.strength,false,a9.float32Allocator);var bn=g.catmullRomSpline(a3,a6.length(),a9.splineDetail,a9.strength,false,a9.float32Allocator);aW.setPerResidueColors(bv,bl);var bm=a9.radius*(a6.residueAt(0).isAminoacid()?1:1.8);var aX=aj(bl,a9.splineDetail);aJ.set(aP,aS[3]-aS[0],aS[4]-aS[1],aS[5]-aS[2]);aJ.set(aQ,aS[0],aS[1],aS[2]);aJ.set(aO,bn[0]-aS[0],bn[1]-aS[0],bn[2]-aS[2]);aJ.normalize(aP,aP);aJ.normalize(aO,aO);aI.set(aM,aX[0],aX[1],aX[2],aX[3]);var bb=aY.numVerts();aY.addVertex(aQ,[-aP[0],-aP[1],-aP[2]],aM,be[0]);ay(aY,aQ,aO,a6.residueAt(0).ss(),aP,aM,bm,true,a9,0,be[0]);at(aY,bb,a9.arcDetail*4);var br=aY.numVerts();var a2=0;aW.addAssoc(bv,aY,a2,bb,br);a2+=1;var bd=Math.floor(a9.splineDetail/2);var bf=g.catmullRomSplineNumPoints(a6.length(),a9.splineDetail,false);var a5=a9.arcDetail*4;for(var bq=1,bt=bf;bq<bt;++bq){var aU=3*bq,aT=4*bq,bg=3*(bq+1),a7=3*(bq-1);aJ.set(aQ,aS[aU],aS[aU+1],aS[aU+2]);if(bq===bt-1){aJ.set(aP,aS[aU]-aS[a7],aS[aU+1]-aS[a7+1],aS[aU+2]-aS[a7+2])}else{aJ.set(aP,aS[bg]-aS[a7],aS[bg+1]-aS[a7+1],aS[bg+2]-aS[a7+2])}aJ.normalize(aP,aP);aI.set(aM,aX[aT],aX[aT+1],aX[aT+2],aX[aT+3]);var bj=0;var bk=Math.floor(bq/a9.splineDetail);var a0=Math.floor((bq-1)/a9.splineDetail);var bc=Math.floor((bq+a9.arrowSkip)/a9.splineDetail);var ba=false;var aZ=a6.residueAt(bk).ss();if(!a9.forceTube){if(bk!==a0){var a4=a6.residueAt(a0).ss();if(a4==="C"&&(aZ==="H"||aZ==="E")){aJ.set(aN,bn[a7]-aS[a7],bn[a7+1]-aS[a7+1],bn[a7+2]-aS[a7+2]);aJ.normalize(aN,aN);var aV=2*Math.PI/(a9.arcDetail*4);var a8=g.signedAngle(aO,aN,aP);bj=Math.round(a8/aV);bj=(bj+a9.arcDetail*4)%(a9.arcDetail*4)}}if(bc!==bk&&bc<a6.length()){var bu=a6.residueAt(bc).ss();if(bu==="C"&&aZ==="E"){ba=true}}}aJ.set(aO,bn[3*bq]-aS[aU],bn[aU+1]-aS[aU+1],bn[aU+2]-aS[aU+2]);aJ.normalize(aO,aO);bb=aY.numVerts();var aR=Math.floor((bq+bd)/a9.splineDetail);var bh=be[Math.min(be.length-1,aR)];ay(aY,aQ,aO,aZ,aP,aM,bm,false,a9,bj,bh);var bs=bq===bt-1?1:a5;if(aY.numVerts()+bs>aY.maxVerts()){br=aY.numVerts();aW.addAssoc(bv,aY,a2,bb,br);aY=bi.vertArrayWithSpaceFor(bs);bb=0;ay(aY,aQ,aO,aZ,aP,aM,bm,true,a9,0,bh)}if(ba){aW.addAssoc(bv,aY,a2,bb,br);ay(aY,aQ,aO,"A",aP,aM,bm,false,a9,0,bh);bq+=a9.arrowSkip}br=aY.numVerts();if(bq===bt-1){br+=1}aW.addAssoc(bv,aY,a2,bb,br);a2+=1;if(ba){a2+=a9.arrowSkip}}aY.addVertex(aQ,aP,aM,be[be.length-1]);aK(aY,bb,a9.arcDetail*4);a9.float32Allocator.release(a3);a9.float32Allocator.release(a1);return bv+1}}();var av=function(){var aU=X.create();var aP=aJ.create(),aO=aJ.create(),aQ=aJ.create(),aT=aJ.create(),aM=aJ.create(),aR=aJ.create();var aS=aI.fromValues(0,0,0,1);var aN=aI.fromValues(0,0,0,1);return function(a9,aW,bb,a3,a7){if(bb.length()===0){return}var ba=a7.idPool.getContinuousRange(bb.length());a9.addIdRange(ba);a7.color.colorFor(bb.centralAtomAt(0),aS,0);var bd=ai([bb],a7.protoSphere.numVerts(),a7.protoCyl.numVerts());var a8=bd;var aX=a9.vertArrayWithSpaceFor(bd);var aY=aX.maxVerts();var aV=aX.numVerts();bb.posAt(aM,0);var a6=ba.nextId({geom:a9,atom:bb.centralAtomAt(0)}),a0=0;a7.protoSphere.addTransformed(aX,aM,a7.radius,aS,a6);var a4=null;aW.addAssoc(a3,aX,0,aV,a4);var a5=a7.float32Allocator.request(bb.length()*4);a5[0]=aS[0];a5[1]=aS[1];a5[2]=aS[2];a5[3]=aS[3];var aZ=a7.protoCyl.numVerts()+a7.protoSphere.numVerts();for(var bc=1;bc<bb.length();++bc){a0=ba.nextId({geom:a9,atom:bb.centralAtomAt(bc)});bb.posAt(aM,bc-1);bb.posAt(aR,bc);a7.color.colorFor(bb.centralAtomAt(bc),aN,0);a5[bc*4+0]=aN[0];a5[bc*4+1]=aN[1];a5[bc*4+2]=aN[2];a5[bc*4+3]=aN[3];aJ.sub(aP,aR,aM);var a1=aJ.length(aP);aJ.scale(aP,aP,1/a1);g.buildRotation(aU,aP,aO,aQ,false);aJ.copy(aT,aM);aJ.add(aT,aT,aR);aJ.scale(aT,aT,0.5);if(aZ>aY-aX.numVerts()){aX=a9.vertArrayWithSpaceFor(a8)}a8-=aZ;var a2=aX.numVerts();a7.protoCyl.addTransformed(aX,aT,a1,a7.radius,aU,aS,aN,a6,a0);a4=aX.numVerts();a4=a4-(a4-a2)/2;a7.protoSphere.addTransformed(aX,aR,a7.radius,aN,a0);a6=a0;aW.addAssoc(a3,aX,bc,aV,a4);aV=a4;aJ.copy(aS,aN)}aW.setPerResidueColors(a3,a5);aW.addAssoc(a3,aX,bb.length()-1,aV,aX.numVerts())}}();return aE}(n,x,E,t);K=function(){function V(ab,Z,Y,ad,ae,af){R.call(this,ab);var X=af||{};this._options={};this._options.fillStyle=X.fillStyle||"#000";this._options.backgroundAlpha=X.backgroundAlpha||0;this._options.fontSize=X.fontSize||24;this._options.font=X.font||"Verdana";this._options.fontStyle=X.fontStyle||"normal";this._options.fontColor=X.fontColor||"#000";this._order=100;this._pos=ad;this._interleavedBuffer=this._gl.createBuffer();this._interleavedData=new Float32Array(5*6);this._prepareText(Z,Y,ae);var aa=0.5;var ac=0.5;this._interleavedData[0]=ad[0];this._interleavedData[1]=ad[1];this._interleavedData[2]=ad[2];this._interleavedData[3]=-aa;this._interleavedData[4]=-ac;this._interleavedData[5]=ad[0];this._interleavedData[6]=ad[1];this._interleavedData[7]=ad[2];this._interleavedData[8]=aa;this._interleavedData[9]=ac;this._interleavedData[10]=ad[0];this._interleavedData[11]=ad[1];this._interleavedData[12]=ad[2];this._interleavedData[13]=aa;this._interleavedData[14]=-ac;this._interleavedData[15]=ad[0];this._interleavedData[16]=ad[1];this._interleavedData[17]=ad[2];this._interleavedData[18]=-aa;this._interleavedData[19]=-ac;this._interleavedData[20]=ad[0];this._interleavedData[21]=ad[1];this._interleavedData[22]=ad[2];this._interleavedData[23]=-aa;this._interleavedData[24]=ac;this._interleavedData[25]=ad[0];this._interleavedData[26]=ad[1];this._interleavedData[27]=ad[2];this._interleavedData[28]=aa;this._interleavedData[29]=ac}function W(X){var Y=1;while(Y<X){Y*=2}return Y}U.derive(V,R,{updateProjectionIntervals:function(){},updateSquaredSphereRadius:function(Y,X){return X},_setupTextParameters:function(X){X.fillStyle=this._options.fontColor;X.textAlign="left";X.textBaseline="bottom";X.font=this._options.fontStyle+" "+this._options.fontSize+"px "+this._options.font},_prepareText:function(Z,X,ab){this._setupTextParameters(X);var aa=X.measureText(ab).width;var Y=24;Z.width=W(aa);Z.height=W(Y);X.fillStyle=this._options.fillStyle;X.globalAlpha=this._options.backgroundAlpha;X.fillRect(0,0,Z.width,Z.height);this._setupTextParameters(X);X.globalAlpha=1;X.lineWidth=0.5;X.lineStyle="none";X.fillText(ab,0,Z.height);X.strokeText(ab,0,Z.height);this._texture=this._gl.createTexture();this._textureFromCanvas(this._texture,Z);this._xScale=aa/Z.width;this._yScale=Y/Z.height;this._width=aa;this._height=Y},_textureFromCanvas:function(Y,X){var Z=this._gl;Z.pixelStorei(Z.UNPACK_FLIP_Y_WEBGL,true);Z.bindTexture(Z.TEXTURE_2D,Y);Z.texImage2D(Z.TEXTURE_2D,0,Z.RGBA,Z.RGBA,Z.UNSIGNED_BYTE,X);Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MAG_FILTER,Z.NEAREST);Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MIN_FILTER,Z.NEAREST);Z.generateMipmap(Z.TEXTURE_2D);Z.bindTexture(Z.TEXTURE_2D,null)},bind:function(){var X=this._gl;X.bindBuffer(X.ARRAY_BUFFER,this._interleavedBuffer);X.activeTexture(X.TEXTURE0);X.bindTexture(X.TEXTURE_2D,this._texture);if(this._ready){return}X.bufferData(X.ARRAY_BUFFER,this._interleavedData,X.STATIC_DRAW);this._ready=true},draw:function(X,af,Y,ae){if(!this._visible){return}if(ae!=="normal"){return}var ab=af.text;X.bind(ab);this.bind();var aa=this._gl;var ad=X.upsamplingFactor();aa.uniform1f(aa.getUniformLocation(ab,"xScale"),this._xScale);aa.uniform1f(aa.getUniformLocation(ab,"yScale"),this._yScale);aa.uniform1f(aa.getUniformLocation(ab,"width"),ad*2*this._width/X.viewportWidth());aa.uniform1f(aa.getUniformLocation(ab,"height"),ad*2*this._height/X.viewportHeight());aa.uniform1i(aa.getUniformLocation(ab,"sampler"),0);var Z=aa.getAttribLocation(ab,"attrCenter");aa.enableVertexAttribArray(Z);aa.vertexAttribPointer(Z,3,aa.FLOAT,false,5*4,0*4);var ac=aa.getAttribLocation(ab,"attrCorner");aa.vertexAttribPointer(ac,2,aa.FLOAT,false,5*4,3*4);aa.enableVertexAttribArray(ac);aa.enable(aa.BLEND);aa.blendFunc(aa.SRC_ALPHA,aa.ONE_MINUS_SRC_ALPHA);aa.drawArrays(aa.TRIANGLES,0,6);aa.disableVertexAttribArray(Z);aa.disableVertexAttribArray(ac);aa.disable(aa.BLEND)}});return V}();m=function(ad){var aa=o.vec3;var W=o.mat3;var X=w.forceRGB;var V=100;function ac(){this._vertData=[];this._indexData=[];this._numVerts=0}ac.prototype={numVerts:function(){return this._numVerts},addVertex:function(ah,ag,ae,af){this._numVerts+=1;this._vertData.push(ah[0],ah[1],ah[2],ag[0],ag[1],ag[2],ae[0],ae[1],ae[2],ae[3],af,0)},addTriangle:function(af,ae,ag){this._indexData.push(af,ae,ag)},numIndices:function(){return this._indexData.length},indexData:function(){return this._indexData},vertData:function(){return this._vertData}};function Y(ag,ai,ah,ae,af){R.call(this,ai);this._float32Allocator=ah;this._uint16Allocator=ae;this._data=new ac();this._protoSphere=new ad.ProtoSphere(8,8);this._protoCyl=new ad.ProtoCylinder(8);this._va=null;this._idRanges=[];this._idPool=af;this._ready=false;this._currentRange=null}function ab(ah,af,ae){for(var ag=0;ag<ae-1;++ag){ah.addTriangle(af,af+1+ag,af+2+ag)}ah.addTriangle(af,af+ae,af+1)}function Z(ai,ag,af){var ae=ag+af;for(var ah=0;ah<af-1;++ah){ai.addTriangle(ae,ag+ah+1,ag+ah)}ai.addTriangle(ae,ag,ag+af-1)}U.derive(Y,R,{updateProjectionIntervals:function(){},updateSquaredSphereRadius:function(af,ae){return ae},addTube:function(){var ai=aa.create();var ah=aa.create();var ae=aa.create();var af=aa.create();var ag=W.create();return function(ak,an,ao,au){au=au||{};var am=X(au.color||"white");var at=true;if(au.cap!==undefined){at=au.cap}aa.sub(af,an,ak);var al=aa.length(af);aa.normalize(af,af);aa.add(ai,ak,an);aa.scale(ai,ai,0.5);g.buildRotation(ag,af,ah,ae,false);if(at){var ar=this._data.numVerts();this._data.addVertex(ak,[-af[0],-af[1],-af[2]],am,0);ab(this._data,ar,8)}var aj=au.userData!==undefined?au.userData:null;console.log(aj);var ap=this._nextObjectId({center:ai,userData:aj,geom:this});this._protoCyl.addTransformed(this._data,ai,al,ao,ag,am,am,ap,ap);if(at){var aq=this._data.numVerts();this._data.addVertex(an,af,am,0);Z(this._data,aq-8,8)}this._ready=false}}(),_nextObjectId:function(ae){if(!this._currentRange||!this._currentRange.hasLeft()){this._currentRange=this._idPool.getContinuousRange(V);this._idRanges.push(this._currentRange)}return this._currentRange.nextId(ae)},destroy:function(){R.prototype.destroy.call(this);for(var ae=0;ae<this._idRanges.length;++ae){this._idRanges[ae].recycle()}},addSphere:function(ah,ag,aj){aj=aj||{};var ai=X(aj.color||"white");var af=aj.userData!==undefined?aj.userData:null;var ae=this._nextObjectId({center:ah,userData:af,geom:this});this._protoSphere.addTransformed(this._data,ah,ag,ai,ae);this._ready=false},_prepareVertexArray:function(){this._ready=true;if(this._va!==null){this._va.destroy()}this._va=new T(this._gl,this._data.numVerts(),this._data.numIndices(),this._float32Allocator,this._uint16Allocator);this._va.setIndexData(this._data.indexData());this._va.setVertData(this._data.vertData())},draw:function(aj,ai,ae,ah){if(!this._visible){return}if(!this._ready){this._prepareVertexArray()}var ag=this.shaderForStyleAndPass(ai,ae,ah);if(!ag){return}aj.bind(ag);this._gl.uniform1i(ag.symId,255);var af=this._va;af.bind(ag);af.draw();af.releaseAttribs(ag)},shaderForStyleAndPass:function(ah,ae,ag){if(ag==="normal"){if(ae==="hemilight"){return ah.hemilight}else{return ah.phong}}if(ag==="select"){return ah.select}if(ag==="outline"){return ah.outline}var af=ah[ag];return af!==undefined?af:null}});return Y}(n);l=function(){var ad=o.vec3;var X=o.quat;var W=o.mat3;function ac(al,ak,aj){this._from=al;this._to=ak;this._duration=aj;this._left=aj;this._start=Date.now();this._looping=false;this._finished=false}ac.prototype={setLooping:function(aj){this._looping=aj},step:function(am){var ak=Date.now();var aj=ak-this._start;var al;if(this._duration===0){al=1}else{if(this._looping){var an=Math.floor(aj/this._duration);al=(aj-an*this._duration)/this._duration}else{aj=Math.min(this._duration,aj);al=aj/this._duration;this._finished=al===1}}this.apply(am,al);return this._finished},apply:function(al,ak){var aj=(1-Math.cos(ak*Math.PI))/2;this._current=this._from*(1-aj)+this._to*aj;al.setZoom(this._current)},finished:function(){return this._finished}};function ae(al,ak,aj){ac.call(this,ad.clone(al),ad.clone(ak),aj);this._current=ad.clone(al)}U.derive(ae,ac,{apply:function(al,ak){var aj=(1-Math.cos(ak*Math.PI))/2;ad.lerp(this._current,this._from,this._to,aj);al.setCenter(this._current)}});function ag(al,am,ao){var ak=W.create();var ap=W.create();W.fromMat4(ak,al);W.fromMat4(ap,am);var aj=X.create();var an=X.create();X.fromMat3(aj,ak);X.fromMat3(an,ap);this._current=W.create();ac.call(this,aj,an,ao)}U.derive(ag,ac,{apply:function(){var aj=X.create();return function(al,ak){X.slerp(aj,this._from,this._to,ak);W.fromQuat(this._current,aj);al.setRotation(this._current)}}()});function af(aj,ak){ac.call(this,null,null,ak);this._axis=ad.clone(aj);this.setLooping(true);this._previousAngle=0}U.derive(af,ac,{apply:function(){var ak=W.create();var aj=W.create();return function(am,al){W.fromMat4(aj,am.rotation());var an=0.2*Math.sin(2*al*Math.PI);var ao=an-this._previousAngle;this._previousAngle=an;g.axisRotation(ak,this._axis,ao);W.mul(aj,ak,aj);am.setRotation(aj)}}()});function ab(aj,ak){var al=1000*(2*Math.PI/ak);ac.call(this,null,null,al);this._axis=ad.clone(aj);this.setLooping(true);this._speed=ak;this._previousT=0}U.derive(ab,ac,{apply:function(){var ak=W.create();var aj=W.create();return function(am,al){W.fromMat4(aj,am.rotation());var an=Math.PI*2*(al-this._previousT);this._previousT=al;g.axisRotation(ak,this._axis,an);W.mul(aj,ak,aj);am.setRotation(aj)}}(),setSpeed:function(aj){this._speed=aj},setAxis:function(aj){this._axis=aj}});function ah(){this._animations=[]}ah.prototype={run:function(aj){var ak=Date.now();this._animations=this._animations.filter(function(al){return !al.step(aj,ak)});return this._animations.length>0},add:function(aj){this._animations.push(aj)},remove:function(aj){this._animations=this._animations.filter(function(ak){return ak!==aj})}};function Z(al,ak,aj){return new ae(al,ak,aj)}function aa(al,ak,aj){return new ag(al,ak,aj)}function ai(al,ak,aj){return new ac(al,ak,aj)}function V(aj,ak){return new ab(aj,ak)}function Y(){return new af([0,1,0],2000)}return{AnimationControl:ah,move:Z,rotate:aa,zoom:ai,rockAndRoll:Y,spin:V}}();b=function(){function X(Z,Y){this.near=Z;this.far=Y}function V(Y){Y=Y||{};this._near=Y.near||0.1;this._far=Y.far||400}V.prototype.update=function(){return new X(this._near,this._far)};function W(){this._far=100}W.prototype.update=function(af,Y){var Z=Y.center();var ae=null;for(var ad=0;ad<af.length;++ad){var ab=af[ad];if(!ab.visible()){continue}ae=ab.updateSquaredSphereRadius(Z,ae)}if(ae===null){return null}ae=Math.sqrt(ae);var ag=Y.zoom();var ac=(ae+ag)*1.05;var aa=0.1;return new X(aa,ac)};return{FixedSlab:V,AutoSlab:W,Slab:X}}();C=function(ah,Z,Y,ag,ak,al,af,ap,ar,aq,ab,ai){var aj='<div style="vertical-align:middle; text-align:center;"><h1>WebGL not supported</h1><p>Your browser does not support WebGL. You might want to try Chrome, Firefox, IE 11, or newer versions of Safari</p><p>If you are using a recent version of one of the above browsers, your graphic card might be blocked. Check the browser documentation for details on how to unblock it.</p></div>';var X=o.vec3;var ac=o.mat4;function am(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)}var aa=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(at){window.setTimeout(at,1000/60)}}();function W(au,at){au=au||"auto";if(au==="fixed"){return new b.FixedSlab(at)}if(au==="auto"){return new b.AutoSlab(at)}return null}function ae(ax,aw,at,ay,av,au){this._pos=ay;this._target=ax;this._node=aw;this._symIndex=at;this._legacyObject=av;this._legacyTransform=au}ae.prototype={symIndex:function(){return this._symIndex},target:function(){return this._target},pos:function(){return this._pos},node:function(){return this._node},transform:function(){return this._legacyTransform},object:function(){return this._legacyObject}};function V(au,at){this._options=this._initOptions(at,au);this._initialized=false;this._objects=[];this._domElement=au;this._redrawRequested=false;this._resize=false;this._lastTimestamp=null;this._objectIdManager=new ah();this._spin=null;this._rockAndRoll=null;this.listenerMap={};this._animControl=new ai.AnimationControl();this._initKeyboardInput();this._initCanvas();this.quality(this._options.quality);if(this._options.click!==null){this.on("click",this._options.click)}if(this._options.doubleClicked!==null){this.on("doubleClick",this._options.doubleClick)}if(document.readyState==="complete"||document.readyState==="loaded"||document.readyState==="interactive"){this._initViewer()}else{document.addEventListener("DOMContentLoaded",U.bind(this,this._initViewer))}}function ao(av,au,at){if(au in av){return av[au]}return at}function an(at){if(at.atomDoubleClick){console.warn("use of atomDoubleClick is deprecated. ","use doubleClick instead");return at.atomDoubleClick}if(at.atomDoubleClicked){console.warn("use of atomDoubleClicked is deprecated. ","use doubleClick instead");return at.atomDoubleClicked}if(at.doubleClick){return at.doubleClick}return"center"}function ad(at){if(at.atomClick){console.warn("use of atomClick is deprecated. ","use click instead");return at.atomClick}if(at.atomClicked){console.warn("use of atomClicked is deprecated. ","use click instead");return at.atomClicked}if(at.click){return at.click}return null}V.prototype={_initOptions:function(av,aw){av=av||{};var au={width:av.width||500,height:av.height||500,animateTime:av.animateTime||0,antialias:av.antialias,quality:ao(av,"quality","low"),style:ao(av,"style","hemilight"),background:w.forceRGB(av.background||"white"),slabMode:W(av.slabMode),outline:ao(av,"outline",true),outlineColor:w.forceRGB(ao(av,"outlineColor","black")),outlineWidth:ao(av,"outlineWidth",1.5),selectionColor:w.forceRGB(ao(av,"selectionColor","#3f3")),fov:ao(av,"fov",45),doubleClick:an(av),click:ad(av),fog:ao(av,"fog",true),transparency:ao(av,"transparency","alpha")};var at=aw.getBoundingClientRect();if(au.width==="auto"){au.width=at.width}if(au.height==="auto"){au.height=at.height}return au},_ensureSize:function(){if(!this._resize){return}this._resize=false;this._cam.setViewportSize(this._canvas.viewportWidth(),this._canvas.viewportHeight());this._pickBuffer.resize(this._options.width,this._options.height)},resize:function(au,at){if(au===this._options.width&&at===this._options.height){return}this._canvas.resize(au,at);this._resize=true;this._options.width=au;this._options.height=at;this.requestRedraw()},fitParent:function(){var at=this._domElement.getBoundingClientRect();this.resize(at.width,at.height)},gl:function(){return this._canvas.gl()},ok:function(){return this._initialized},options:function(av,at){if(at!==undefined){this._options[av]=at;if(av==="fog"){this._cam.fog(at);this.requestRedraw()}else{if(av==="fov"){this._cam.setFieldOfViewY(at*Math.PI/180)}else{if(av==="selectionColor"){this._cam.setSelectionColor(w.forceRGB(at))}else{if(av==="outlineColor"){this._cam.setOutlineColorColor(w.forceRGB(at))}else{if(av==="outlineWidth"){this._cam.setOutlineWidth(at+0)}else{if(av==="transparency"){var au=at==="screendoor";this._cam.setScreenDoorTransparency(au)}}}}}}}return this._options[av]},quality:function(at){this._options.quality=at;if(at==="high"){this._options.arcDetail=4;this._options.sphereDetail=16;this._options.splineDetail=8;return}if(at==="medium"){this._options.arcDetail=2;this._options.sphereDetail=10;this._options.splineDetail=5;return}if(at==="low"){this._options.arcDetail=2;this._options.sphereDetail=8;this._options.splineDetail=3;return}console.error("invalid quality argument",at)},imageData:function(){return this._canvas.imageData()},_initPickBuffer:function(){var at={width:this._options.width,height:this._options.height};this._pickBuffer=new Y(this._canvas.gl(),at)},_initViewer:function(){if(!this._canvas.initGL()){this._domElement.removeChild(this._canvas.domElement());this._domElement.innerHTML=aj;this._domElement.style.width=this._options.width+"px";this._domElement.style.height=this._options.height+"px";return false}this._initPickBuffer();this._2dcontext=this._textureCanvas.getContext("2d");this._float32Allocator=new ag(Float32Array);this._uint16Allocator=new ag(Uint16Array);this._cam=new ak(this._canvas.gl());this._cam.setUpsamplingFactor(this._canvas.superSamplingFactor());this._cam.setOutlineWidth(this._options.outlineWidth);var au=this._options.transparency==="screendoor";this._cam.setScreenDoorTransparency(au);this._cam.fog(this._options.fog);this._cam.setFogColor(this._options.background);this._cam.setOutlineColor(this._options.outlineColor);this._cam.setSelectionColor(this._options.selectionColor);this._cam.setFieldOfViewY(this._options.fov*Math.PI/180);this._mouseHandler.setCam(this._cam);var av=this._canvas;var at=am()?"highp":"mediump";this._shaderCatalog={hemilight:av.initShader(al.HEMILIGHT_VS,al.PRELUDE_FS+al.HEMILIGHT_FS,at),phong:av.initShader(al.HEMILIGHT_VS,al.PRELUDE_FS+al.PHONG_FS,at),outline:av.initShader(al.OUTLINE_VS,al.PRELUDE_FS+al.OUTLINE_FS,at),lines:av.initShader(al.LINES_VS,al.PRELUDE_FS+al.LINES_FS,at),text:av.initShader(al.TEXT_VS,al.TEXT_FS,at),selectLines:av.initShader(al.SELECT_LINES_VS,al.SELECT_LINES_FS,at),select:av.initShader(al.SELECT_VS,al.SELECT_FS,at)};this._boundDraw=U.bind(this,this._draw);this._touchHandler=new af(this._canvas.domElement(),this,this._cam);if(!this._initialized){this._initialized=true;this._dispatchEvent({name:"viewerReadyEvent"},"viewerReady",this)}return true},requestRedraw:function(){if(this._redrawRequested){return}this._redrawRequested=true;aa(this._boundDraw)},boundingClientRect:function(){return this._canvas.domElement().getBoundingClientRect()},_drawWithPass:function(au){for(var at=0,av=this._objects.length;at!==av;++at){this._objects[at].draw(this._cam,this._shaderCatalog,this._options.style,au)}},_initKeyboardInput:function(){var at=document.createElement("div");at.setAttribute("style","overflow:hidden;width:0;height:0");this._keyInput=document.createElement("textarea");this._domElement.appendChild(at);at.appendChild(this._keyInput);this._keyInput.focus()},focus:function(){this._keyInput.focus()},_initCanvas:function(){var at={antialias:this._options.antialias,height:this._options.height,width:this._options.width,backgroundColor:this._options.background};this._canvas=new Z.Canvas(this._domElement,at);this._textureCanvas=document.createElement("canvas");this._textureCanvas.style.display="none";this._domElement.appendChild(this._textureCanvas);this._mouseHandler=new ap(this._canvas,this,this._cam,this._options.animateTime);this._canvas.domElement().addEventListener("mousedown",U.bind(this,this._gainFocus))},_gainFocus:function(){this._keyInput.focus()},setRotation:function(au,at){at|=0;if(at===0){this._cam.setRotation(au);this.requestRedraw();return}var av;if(au.length===9){av=ac.create();ac.fromMat3(av,au)}else{av=ac.clone(au)}this._animControl.add(ai.rotate(this._cam.rotation(),av,at));this.requestRedraw()},setCamera:function(av,at,aw,au){au|=0;this.setCenter(at,au);this.setRotation(av,au);this.setZoom(aw,au)},_animateCam:function(){var at=this._animControl.run(this._cam);if(at){this.requestRedraw()}},_draw:function(){if(this._canvas===null){return}this._redrawRequested=false;this._animateCam();this._canvas.bind();this._ensureSize();var au=this._canvas.gl();au.clear(au.COLOR_BUFFER_BIT|au.DEPTH_BUFFER_BIT);var at=this._options.slabMode.update(this._objects,this._cam);if(at!==null){this._cam.setNearFar(at.near,at.far)}au.enable(au.CULL_FACE);if(this._options.outline){au.cullFace(au.BACK);au.enable(au.CULL_FACE);this._drawWithPass("outline")}au.cullFace(au.FRONT);au.enable(au.BLEND);au.blendFunc(au.SRC_ALPHA,au.ONE_MINUS_SRC_ALPHA);this._drawWithPass("normal")},setCenter:function(at,au){au|=0;if(au===0){this._cam.setCenter(at);return}this._animControl.add(ai.move(this._cam.center(),X.clone(at),au));this.requestRedraw()},setZoom:function(au,at){at|=0;if(at===0){this._cam.setZoom(au);return}this._animControl.add(ai.zoom(this._cam.zoom(),au,at));this.requestRedraw()},centerOn:function(au,at){this.setCenter(au.center(),at)},clear:function(){for(var at=0;at<this._objects.length;++at){this._objects[at].destroy()}this._objects=[]},addListener:function(au,aw){if(au==="keypress"||au==="keydown"||au==="keyup"){console.log("keypress");this._keyInput.addEventListener(au,aw,false)}else{var av=this.listenerMap[au];if(typeof av==="undefined"){av=[];this.listenerMap[au]=av}if(aw==="center"){var at=U.bind(this._mouseHandler,this._mouseHandler._centerOnClicked);av.push(at)}else{av.push(aw)}if(this._initialized&&au==="viewerReady"){aw(this,null)}}},_dispatchEvent:function(av,aw,at){var au=this.listenerMap[aw];if(au){au.forEach(function(ax){ax(at,av)})}},RENDER_MODES:["sline","lines","trace","lineTrace","cartoon","tube","spheres","ballsAndSticks","points"],renderAs:function(au,at,ay,aw){var ax=false;for(var av=0;av<this.RENDER_MODES.length;++av){if(this.RENDER_MODES[av]===ay){ax=true;break}}if(!ax){console.error("render mode",ay,"not supported");return}return this[ay](au,at,aw)},_handleStandardMolOptions:function(au,at){au=this._handleStandardOptions(au);au.showRelated=au.showRelated||"asym";if(au.showRelated&&au.showRelated!=="asym"){if(at.assembly(au.showRelated)===null){console.error("no assembly with name",au.showRelated,". Falling back to asymmetric unit");au.showRelated="asym"}}return au},_handleStandardOptions:function(at){at=U.copy(at);at.float32Allocator=this._float32Allocator;at.uint16Allocator=this._uint16Allocator;at.idPool=this._objectIdManager;return at},lineTrace:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.uniform([1,0,1]);au.lineWidth=au.lineWidth||4;var ax=ar.lineTrace(at,this._canvas.gl(),au);return this.add(av,ax)},spheres:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.byElement();au.sphereDetail=this.options("sphereDetail");au.radiusMultiplier=au.radiusMultiplier||1;var ax=ar.spheres(at,this._canvas.gl(),au);return this.add(av,ax)},sline:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.uniform([1,0,1]);au.splineDetail=au.splineDetail||this.options("splineDetail");au.strength=au.strength||1;au.lineWidth=au.lineWidth||4;var ax=ar.sline(at,this._canvas.gl(),au);return this.add(av,ax)},cartoon:function(av,at,ax){var au=this._handleStandardMolOptions(ax,at);au.color=au.color||w.bySS();au.strength=au.strength||1;au.splineDetail=au.splineDetail||this.options("splineDetail");au.arcDetail=au.arcDetail||this.options("arcDetail");au.radius=au.radius||0.3;au.forceTube=au.forceTube||false;var ay=ar.cartoon(at,this._canvas.gl(),au);var aw=this.add(av,ay);return aw},surface:function(au,aw,av){var at=this._handleStandardOptions(av);var ax=ar.surface(aw,this._canvas.gl(),at);return this.add(au,ax)},tube:function(au,at,av){av=av||{};av.forceTube=true;return this.cartoon(au,at,av)},ballsAndSticks:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.byElement();au.radius=au.radius||0.3;au.arcDetail=(au.arcDetail||this.options("arcDetail"))*2;au.sphereDetail=au.sphereDetail||this.options("sphereDetail");var ax=ar.ballsAndSticks(at,this._canvas.gl(),au);return this.add(av,ax)},lines:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.byElement();au.lineWidth=au.lineWidth||4;var ax=ar.lines(at,this._canvas.gl(),au);return this.add(av,ax)},points:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.byElement();au.pointSize=au.pointSize||1;var ax=ar.points(at,this._canvas.gl(),au);return this.add(av,ax)},trace:function(av,at,aw){var au=this._handleStandardMolOptions(aw,at);au.color=au.color||w.uniform([1,0,0]);au.radius=au.radius||0.3;au.arcDetail=(au.arcDetail||this.options("arcDetail"))*2;au.sphereDetail=au.sphereDetail||this.options("sphereDetail");var ax=ar.trace(at,this._canvas.gl(),au);return this.add(av,ax)},_updateProjectionIntervals:function(aw,av,at){at.eachAtom(function(ay){var az=ay.pos();for(var ax=0;ax<3;++ax){av[ax].update(X.dot(az,aw[ax]))}});for(var au=0;au<3;++au){av[au].extend(1.5)}},fitTo:function(aw){var av=this._cam.mainAxes();var au=[new U.Range(),new U.Range(),new U.Range()];if(aw instanceof R){aw.updateProjectionIntervals(av[0],av[1],av[2],au[0],au[1],au[2])}else{if(aw.eachAtom!==undefined){this._updateProjectionIntervals(av,au,aw)}else{if(aw.length!==undefined){for(var at=0;at<aw.length;++at){this._updateProjectionIntervals(av,au,aw[at])}}}}this._fitToIntervals(av,au)},_fitToIntervals:function(aH,aB){if(aB[0].empty()||aB[1].empty()||aB[2].empty()){console.error("could not determine interval. No objects shown?");return}var ay=aB[0].center();var ax=aB[1].center();var aw=aB[2].center();var au=[ay*aH[0][0]+ax*aH[1][0]+aw*aH[2][0],ay*aH[0][1]+ax*aH[1][1]+aw*aH[2][1],ay*aH[0][2]+ax*aH[1][2]+aw*aH[2][2]];var aG=this._cam.fieldOfViewY();var at=this._cam.aspectRatio();var aD=aB[0].length()/at;var aA=aB[1].length();var aI=Math.max(aD,aA)*0.5;var av=aI/Math.tan(0.5*aG);var aC=av+0.5*aB[2].length();var aF=0.5;var aE=Math.max(av-aF,0.1);var az=2*aF+av+aB[2].length();this._cam.setNearFar(aE,az);this.setCamera(this._cam.rotation(),au,aC,this._options.animateTime);this.requestRedraw()},autoZoom:function(){var au=this._cam.mainAxes();var at=[new U.Range(),new U.Range(),new U.Range()];this.forEach(function(av){if(!av.visible()){return}av.updateProjectionIntervals(au[0],au[1],au[2],at[0],at[1],at[2])});this._fitToIntervals(au,at)},slabInterval:function(){},autoSlab:function(){var at=this._options._slabMode.update(this._objects,this._cam);if(at!==null){this._cam.setNearFar(at.near,at.far)}this.requestRedraw()},rockAndRoll:function(at){if(at===undefined){return this._rockAndRoll!==null}if(!!at){if(this._rockAndRoll===null){this._rockAndRoll=ai.rockAndRoll();this._animControl.add(this._rockAndRoll);this.requestRedraw()}return true}this._animControl.remove(this._rockAndRoll);this._rockAndRoll=null;this.requestRedraw();return false},spin:function(au,at){if(au===undefined){return this._spin!==null}if(au===false){this._animControl.remove(this._spin);this._spin=null;this.requestRedraw();return false}if(au===true){au=Math.PI/8}at=at||[0,1,0];if(this._spin===null){this._spin=ai.spin(at,au);this._animControl.add(this._spin)}else{this._spin.setSpeed(au);this._spin.setAxis(at)}this.requestRedraw();return true},slabMode:function(aw,au){au=au||{};var av=W(aw,au);var at=av.update(this._objects,this._cam);if(at!==null){this._cam.setNearFar(at.near,at.far)}this._options.slabMode=av;this.requestRedraw()},label:function(av,aw,ax,au){var at=new aq(this._canvas.gl(),this._textureCanvas,this._2dcontext,ax,aw,au);this.add(av,at);return at},customMesh:function(au,av){var at=this._handleStandardOptions(av);var aw=new ab(au,this._canvas.gl(),at.float32Allocator,at.uint16Allocator,at.idPool);this.add(au,aw);return aw},_drawPickingScene:function(){var at=this._canvas.gl();at.clearColor(0,0,0,0);at.disable(at.BLEND);at.clear(at.COLOR_BUFFER_BIT|at.DEPTH_BUFFER_BIT);at.clearColor(this._options.background[0],this._options.background[1],this._options.background[2],1);at.cullFace(at.FRONT);at.enable(at.CULL_FACE);this._drawWithPass("select")},pick:function(){return function(aA){this._pickBuffer.bind();this._drawPickingScene();var aw=new Uint8Array(4);var ax=this._canvas.gl();ax.readPixels(aA.x,this._options.height-aA.y,1,1,ax.RGBA,ax.UNSIGNED_BYTE,aw);this._pickBuffer.release();if(aw.data){aw=aw.data}var at=aw[0]|aw[1]<<8|aw[2]<<16;var az=aw[3];var au=this._objectIdManager.objectForId(at);if(au===undefined){return null}var aB=X.create();var ay=null;var av=null;if(az!==255){ay=au.atom;av=au.geom.symWithIndex(az);X.transformMat4(aB,au.atom.pos(),av)}else{if(au.atom!==undefined){ay=au.atom;aB=au.atom.pos()}else{ay=au.userData;aB=au.center}}return new ae(ay,au.geom,az<255?az:null,aB,au,av)}}(),add:function(at,au){au.name(at);this._objects.push(au);this._objects.sort(function(av,aw){return av.order()-aw.order()});this.requestRedraw();return au},_globToRegex:function(au){var at=au.replace(".","\\.").replace("*",".*");return new RegExp("^"+at+"$")},forEach:function(){var ax,av="*";if(arguments.length===2){ax=arguments[1];av=arguments[0]}else{ax=arguments[0]}var au=this._globToRegex(av);for(var at=0;at<this._objects.length;++at){var aw=this._objects[at];if(au.test(aw.name())){ax(aw,at)}}},get:function(at){for(var au=0;au<this._objects.length;++au){if(this._objects[au].name()===at){return this._objects[au]}}console.error("could not find object with name",at);return null},hide:function(at){this.forEach(at,function(au){au.hide()})},show:function(at){this.forEach(at,function(au){au.show()})},rm:function(ax){var at=[];var av=this._globToRegex(ax);for(var au=0;au<this._objects.length;++au){var aw=this._objects[au];if(!av.test(aw.name())){at.push(aw)}else{aw.destroy()}}this._objects=at},all:function(){return this._objects},isWebGLSupported:function(){return this._canvas.isWebGLSupported()},destroy:function(){this.clear();this._canvas.destroy();this._canvas=null}};V.prototype.on=V.prototype.addListener;return{Viewer:function(au,at){return new V(au,at)},isWebGLSupported:Z.isWebGLSupported}}(r,J,c,S,Q,s,L,A,i,K,m,l);p=function(){function W(Y,X){this._chains=Y||[];this._matrices=X||[]}W.prototype={addChain:function(X){this._chains.push(X)},chains:function(){return this._chains},addMatrix:function(X){this._matrices.push(X)},matrices:function(){return this._matrices},matrix:function(X){return this._matrices[X]}};function V(X){this._name=X;this._generators=[]}V.prototype={name:function(){return this._name},generators:function(){return this._generators},generator:function(X){return this._generators[X]},addGenerator:function(X){this._generators.push(X)}};return{SymGenerator:W,Assembly:V}}();N=function(){var X=o.vec3;function Y(){}Y.prototype={bondCount:function(){return this.bonds().length},eachBond:function(ac){var ab=this.bonds();for(var Z=0,aa=ab.length;Z<aa;++Z){ac(ab[Z])}},isConnectedTo:function(ab){if(ab===null){return false}var Z=ab.full();var ac=this.full();var af=this.bonds();for(var aa=0,ae=af.length;aa<ae;++aa){var ad=af[aa];if(ad.atom_one()===ac&&ad.atom_two()===Z||ad.atom_one()===Z&&ad.atom_two()===ac){return true}}return false}};function W(Z,ac,ag,ad,ab,af,aa,ae){Y.call(this);this._residue=Z;this._bonds=[];this._isHetatm=!!af;this._name=ac;this._pos=ag;this._index=ab;this._element=ad;this._occupancy=aa!==undefined?aa:null;this._tempFactor=ae!==undefined?ae:null}U.derive(W,Y,{addBond:function(Z){this._bonds.push(Z)},name:function(){return this._name},bonds:function(){return this._bonds},residue:function(){return this._residue},structure:function(){return this._residue.structure()},full:function(){return this},qualifiedName:function(){return this.residue().qualifiedName()+"."+this.name()},pos:function(){return this._pos},setPos:function(Z){X.copy(this._pos,Z)},element:function(){return this._element},index:function(){return this._index},prop:function(Z){return this[Z]()},occupancy:function(){return this._occupancy},tempFactor:function(){return this._tempFactor},isHetatm:function(){return this._isHetatm}});function V(aa,Z){Y.call(this);this._resView=aa;this._atom=Z;this._bonds=[]}U.derive(V,Y,{full:function(){return this._atom},name:function(){return this._atom.name()},pos:function(){return this._atom.pos()},element:function(){return this._atom.element()},residue:function(){return this._resView},bonds:function(){return this._atom.bonds()},index:function(){return this._atom.index()},occupancy:function(){return this._atom.occupancy()},tempFactor:function(){return this._atom.tempFactor()},qualifiedName:function(){return this._atom.qualifiedName()},isHetatm:function(){return this._atom.isHetatm()}});return{Atom:W,AtomView:V}}();u=function(Z){var Y=o.vec3;var X=Z.Atom;var V=Z.AtomView;function W(){}W.prototype={prop:function(ac){return this[ac]()},isWater:function(){return this.name()==="HOH"||this.name()==="DOD"},eachAtom:function(ae,ac){ac|=0;for(var ad=0;ad<this._atoms.length;ad+=1){if(ae(this._atoms[ad],ac)===false){return false}ac+=1}return ac},qualifiedName:function(){var ac=this.chain().name()+"."+this.name()+this.num();if(this.insCode()==="\0"){return ac}return ac+this.insCode()},atom:function(ad){if(typeof ad==="string"){for(var ac=0;ac<this._atoms.length;++ac){if(this._atoms[ac].name()===ad){return this._atoms[ac]}}return null}if(ad>=this._atoms.length&&ad<0){return null}return this._atoms[ad]},centralAtom:function(){if(this.isAminoacid()){return this.atom("CA")}if(this.isNucleotide()){return this.atom("C3'")}return null},center:function(){var ac=0;var ad=Y.create();this.eachAtom(function(ae){Y.add(ad,ad,ae.pos());ac+=1});if(ac>0){Y.scale(ad,ad,1/ac)}return ad},isAminoacid:function(){return this._isAminoacid},isNucleotide:function(){return this._isNucleotide}};function ab(af,ae,ad,ac){W.call(this);this._name=ae;this._num=ad;this._insCode=ac;this._atoms=[];this._ss="C";this._chain=af;this._isAminoacid=false;this._isNucleotide=false;this._index=af.residues().length}U.derive(ab,W,{_deduceType:function(){this._isNucleotide=this.atom("P")!==null&&this.atom("C3'")!==null;this._isAminoacid=this.atom("N")!==null&&this.atom("CA")!==null&&this.atom("C")!==null&&this.atom("O")!==null},name:function(){return this._name},insCode:function(){return this._insCode},num:function(){return this._num},full:function(){return this},addAtom:function(ad,ai,ae,ah,ac,ag){var af=new X(this,ad,ai,ae,this.structure().nextAtomIndex(),ah,ac,ag);this._atoms.push(af);return af},ss:function(){return this._ss},setSS:function(ac){this._ss=ac},index:function(){return this._index},atoms:function(){return this._atoms},chain:function(){return this._chain},structure:function(){return this._chain.structure()}});function aa(ad,ac){W.call(this);this._chainView=ad;this._atoms=[];this._residue=ac}U.derive(aa,W,{addAtom:function(ae,af){if(af){for(var ad=0;ad<this._atoms.length;++ad){var ac=this._atoms[ad];if(ac.index()===ae.index()){return ac}}}var ag=new V(this,ae.full());this._atoms.push(ag);return ag},removeAtom:function(ad){var ac=this._atoms.length;this._atoms=this._atoms.filter(function(ae){return ae.index()!==ad.index()});return ac!==this._atoms.length},full:function(){return this._residue},num:function(){return this._residue.num()},insCode:function(){return this._residue.insCode()},ss:function(){return this._residue.ss()},index:function(){return this._residue.index()},chain:function(){return this._chainView},name:function(){return this._residue.name()},atoms:function(){return this._atoms},qualifiedName:function(){return this._residue.qualifiedName()},containsResidue:function(ac){return this._residue.full()===ac.full()},isAminoacid:function(){return this._residue.isAminoacid()},isNucleotide:function(){return this._residue.isNucleotide()},isWater:function(){return this._residue.isWater()}});return{ResidueView:aa,Residue:ab}}(N);F=function(){var W=o.vec3;function V(){this._trace=[]}V.prototype={push:function(Y){this._trace.push(Y)},length:function(){return this._trace.length},residueAt:function(Y){return this._trace[Y]},posAt:function(Z,Y){W.copy(Z,this._trace[Y].centralAtom().pos());return Z},normalAt:function(aa,Z){var Y=this._trace[Z];if(Y.isAminoacid()){W.sub(aa,Y.atom("O").pos(),Y.atom("C").pos())}W.normalize(aa,aa);return aa},centralAtomAt:function(Y){return this._trace[Y].centralAtom()},tangentAt:function(){var Y=W.create();var Z=W.create();return function(ab,aa){if(aa>0){this.posAt(Y,aa-1)}else{this.posAt(Y,aa)}if(aa<this._trace.length-1){this.posAt(Z,aa+1)}else{this.posAt(Z,aa)}W.sub(ab,Z,Y)}}(),fullTraceIndex:function(Y){return Y},subsets:function(Y){var ae=0,aa=0;var Z=[];while(aa<Y.length&&ae<this._trace.length){var ad=Y[aa].full().index();while(this._trace.length>ae&&this._trace[ae].index()<ad){++ae}if(ae>=this._trace.length){break}var ab=this._trace[ae].index();while(Y.length>aa&&Y[aa].full().index()<ab){++aa}if(aa>=Y.length){break}var ac=ae;while(Y.length>aa&&this._trace.length>ae&&Y[aa].full().index()===this._trace[ae].index()){++aa;++ae}var af=ae;Z.push(new X(this,ac,af))}return Z}};V.prototype.smoothPosAt=V.prototype.posAt;V.prototype.smoothNormalAt=V.prototype.normalAt;function X(Y,aa,ab){this._fullTrace=Y;this._fullTraceBegin=aa;this._fullTraceEnd=ab;this._isNTerminal=this._fullTraceBegin===0;this._isCTerminal=this._fullTrace.length()===this._fullTraceEnd;var Z=this._fullTraceEnd-this._fullTraceBegin;if(!this._isCTerminal){++Z}if(!this._isNTerminal){++Z;this._fullTraceBegin-=1}this._length=Z}X.prototype={length:function(){return this._length},residueAt:function(Y){return this._fullTrace.residueAt(this._fullTraceBegin+Y)},_interpolate:function(){var Z=W.create();var Y=W.create();return function(ac,ab,aa,ad){this.tangentAt(Z,ab);this.tangentAt(Y,aa);W.scale(Z,Z,ad);W.scale(Y,Y,ad);g.cubicHermiteInterpolate(ac,this.centralAtomAt(ab).pos(),Z,this.centralAtomAt(aa).pos(),Y,0.5,0);return ac}}(),smoothPosAt:function(){return function(Z,Y,ab){if(Y===0&&!this._isNTerminal){return this._interpolate(Z,Y,Y+1,ab)}if(Y===this._length-1&&!this._isCTerminal){return this._interpolate(Z,Y-1,Y,ab)}var aa=this.centralAtomAt(Y);W.copy(Z,aa.pos());return Z}}(),smoothNormalAt:function(){return function(Z,Y){this._fullTrace.normalAt(Z,Y+this._fullTraceBegin);return Z}}(),posAt:function(aa,Z){var ab=this.centralAtomAt(Z);var Y=null;W.copy(aa,ab.pos());if(Z===0&&!this._isNTerminal){Y=this.centralAtomAt(Z+1);W.add(aa,aa,Y.pos());W.scale(aa,aa,0.5)}if(Z===this._length-1&&!this._isCTerminal){Y=this.centralAtomAt(Z-1);W.add(aa,aa,Y.pos());W.scale(aa,aa,0.5)}return aa},centralAtomAt:function(Y){return this.residueAt(Y).centralAtom()},fullTraceIndex:function(Y){return this._fullTraceBegin+Y},tangentAt:function(Z,Y){return this._fullTrace.tangentAt(Z,Y+this._fullTraceBegin)}};return{TraceSubset:X,BackboneTrace:V}}();h=function(X,ac){var ae=o.vec3;var ag=X.Residue;var ab=X.ResidueView;function W(ak,aj){return ak<<8|aj.charCodeAt(0)}function ad(aj,ak){return aj.num()<ak.num()}function Z(aj){return{num:function(){return aj}}}function V(){}V.prototype={eachAtom:function(al,aj){aj|=0;for(var ak=0;ak<this._residues.length;ak+=1){aj=this._residues[ak].eachAtom(al,aj);if(aj===false){return false}}return aj},atomCount:function(){var al=0;var aj=this.residues();for(var ak=0;ak<aj.length;++ak){al+=aj[ak].atoms().length}return al},eachResidue:function(ak){for(var aj=0;aj<this._residues.length;aj+=1){if(ak(this._residues[aj])===false){return false}}},residues:function(){return this._residues},structure:function(){return this._structure},asView:function(){var aj=this.structure().createEmptyView();aj.addChain(this,true);return aj},residueByRnum:function(ak){var aj=this.residues();if(this._rnumsOrdered){var al=U.binarySearch(aj,Z(ak),ad);if(al===-1){return null}return aj[al]}else{for(var am=0;am<aj.length;++am){if(aj[am].num()===ak){return aj[am]}}return null}},residuesInRnumRange:function(ak,am){var aj=[];var an,ao;var ap=this.residues();if(this._rnumsOrdered===true){var ar=U.indexFirstLargerEqualThan(ap,Z(ak),ad);if(ar===-1){return aj}var al=U.indexLastSmallerEqualThan(ap,Z(am),ad);if(al===-1){return aj}for(an=ar;an<=al;++an){aj.push(this._residues[an])}}else{for(an=0,ao=ap.length;an!==ao;++an){var aq=ap[an];if(aq.num()>=ak&&aq.num()<=am){aj.push(aq)}}}return aj},prop:function(aj){return this[aj]()}};function ah(aj,ak){V.call(this);this._structure=aj;this._name=ak;this._cachedTraces=[];this._residues=[];this._rnumsOrdered=true}function Y(an,ao,ak){var aj,am;if(an){aj=ao.atom("C");am=ak.atom("N")}else{aj=ao.atom("O3'");am=ak.atom("P")}if(aj.isConnectedTo(am)){return false}var al=ae.sqrDist(aj.pos(),am.pos());return Math.abs(al-1.5*1.5)>1}function ai(aj,ak){if(ak.length()<2){return}aj.push(ak)}function aa(aj,ao,an){if(aj.length===0){return true}if(!ao){return false}var al=W(an.num(),an.insCode());var am=aj[aj.length-1];var ak=W(am.num(),am.insCode());return ak<al}U.derive(ah,V,{name:function(){return this._name},full:function(){return this},addResidue:function(am,al,ak){ak=ak||"\0";var aj=new ag(this,am,al,ak);this._rnumsOrdered=aa(this._residues,this._rnumsOrdered,aj);this._residues.push(aj);return aj},assignSS:function(ao,an,am){var aq=W(ao[0],ao[1]);var ap=W(an[0],an[1]);for(var al=1;al<this._residues.length-1;++al){var ak=this._residues[al];var aj=W(ak.num(),ak.insCode());if(aj<=aq||aj>=ap){continue}ak.setSS(am)}},eachBackboneTrace:function(ak){this._cacheBackboneTraces();for(var aj=0;aj<this._cachedTraces.length;++aj){ak(this._cachedTraces[aj])}},_cacheBackboneTraces:function(){if(this._cachedTraces.length>0){return}var ak=new ac.BackboneTrace();var am=null;for(var al=0;al<this._residues.length;al+=1){var aj=this._residues[al];var ap=aj.isAminoacid();var an=aj.isNucleotide();if(am===true&&!ap||am===false&&!an||am===null&&!an&&!ap){ai(this._cachedTraces,ak);am=null;ak=new ac.BackboneTrace();continue}if(ak.length()===0){ak.push(aj);am=aj.isAminoacid();continue}var ao=this._residues[al-1];if(Y(am,ao,aj)){ai(this._cachedTraces,ak);ak=new ac.BackboneTrace()}ak.push(aj)}ai(this._cachedTraces,ak)},backboneTraces:function(){var aj=[];this.eachBackboneTrace(function(ak){aj.push(ak)});return aj}});function af(ak,aj){V.call(this);this._chain=aj;this._residues=[];this._molView=ak;this._residueMap={};this._rnumsOrdered=true}U.derive(af,V,{addResidue:function(aj,am){var an=new ab(this,aj.full());this._rnumsOrdered=aa(this._residues,this._rnumsOrdered,aj);this._residues.push(an);this._residueMap[aj.full().index()]=an;if(am){var ak=aj.atoms();for(var al=0;al<ak.length;++al){an.addAtom(ak[al].full(),false)}}return an},addAtom:function(aj){var ak=this._residueMap[aj.residue().full().index()];if(ak===undefined){ak=this.addResidue(aj.residue())}return ak.addAtom(aj,true)},removeAtom:function(ak,aj){var am=this._residueMap[ak.residue().full().index()];if(am===undefined){return false}var al=am.removeAtom(ak);if(al&&am.atoms().length===0&&aj){delete this._residueMap[ak.residue().full().index()];this._residues=this._residues.filter(function(an){return an!==am})}return al},containsResidue:function(aj){var ak=this._residueMap[aj.full().index()];if(ak===undefined){return false}return ak.full()===aj.full()},eachBackboneTrace:function(an){var am=this._chain.backboneTraces();for(var al=0;al<am.length;++al){var aj=am[al].subsets(this._residues);for(var ak=0;ak<aj.length;++ak){an(aj[ak])}}},backboneTraces:function(){var aj=[];this.eachBackboneTrace(function(ak){aj.push(ak)});return aj},full:function(){return this._chain},name:function(){return this._chain.name()},structure:function(){return this._molView}});return{Chain:ah,ChainView:af}}(u,F);j=function(){var V=o.vec3;var W=function(Y,X){var Z={atom_one:Y,atom_two:X};return{atom_one:function(){return Z.atom_one},atom_two:function(){return Z.atom_two},mid_point:function(aa){if(!aa){aa=V.create()}V.add(aa,Z.atom_one.pos(),Z.atom_two.pos());V.scale(aa,aa,0.5);return aa}}};return{Bond:W}}();D=function(){function Z(ad,ab){for(var ac=0;ac<ab.length;++ac){if(!ab[ac](ad)){return false}}return true}function X(ac){var ab=[];if(ac.aname!==undefined){ab.push(function(ad){return ad.name()===ac.aname})}if(ac.hetatm!==undefined){ab.push(function(ad){return ad.isHetatm()===ac.hetatm})}if(ac.anames!==undefined){ab.push(function(ad){var af=ad.name();for(var ae=0;ae<ac.anames.length;++ae){if(af===ac.anames[ae]){return true}}return false})}return ab}function W(ae){var ab=[];if(ae.rname!==undefined){ab.push(function(af){return af.name()===ae.rname})}if(ae.rnames!==undefined){ab.push(function(ag){var ah=ag.name();for(var af=0;af<ae.rnames.length;++af){if(ah===ae.rnames[af]){return true}}return false})}if(ae.rnums!==undefined){var ad={};for(var ac=0;ac<ae.rnums.length;++ac){ad[ae.rnums[ac]]=true}ab.push(function(af){var ag=af.num();return ad[ag]===true})}if(ae.rnum!==undefined){ab.push(function(af){return af.num()===ae.rnum})}return ab}function Y(ac){var ab=[];if(ac.cname!==undefined){ac.chain=ac.cname}if(ac.cnames!==undefined){ac.chains=ac.cnames}if(ac.chain!==undefined){ab.push(function(ad){return ad.name()===ac.chain})}if(ac.chains!==undefined){ab.push(function(af){var ae=af.name();for(var ad=0;ad<ac.chains.length;++ad){if(ae===ac.chains[ad]){return true}}return false})}return ab}function aa(ad,ag){var ab=ad.residues();if(ag.rnumRange){ab=ad.residuesInRnumRange(ag.rnumRange[0],ag.rnumRange[1])}var af=[],ac,ae;if(ag.rindexRange!==undefined){for(ac=ag.rindexRange[0],ae=Math.min(ab.length-1,ag.rindexRange[1]);ac<=ae;++ac){af.push(ab[ac])}return af}if(ag.rindices){if(ag.rindices.length!==undefined){af=[];for(ac=0;ac<ag.rindices.length;++ac){af.push(ab[ag.rindices[ac]])}return af}}return ab}function V(ae,al,ad){var aj=W(ad);var an=X(ad);var ac=Y(ad);if(ad.rindex){ad.rindices=[ad.rindex]}for(var ap=0;ap<ae._chains.length;++ap){var ab=ae._chains[ap];if(!Z(ab,ac)){continue}var ah=aa(ab,ad);var af=null;for(var am=0;am<ah.length;++am){if(!Z(ah[am],aj)){continue}if(!af){af=al.addChain(ab,false)}var ao=null;var ag=ah[am].atoms();for(var ak=0;ak<ag.length;++ak){if(!Z(ag[ak],an)){continue}if(!ao){ao=af.addResidue(ah[am],false)}ao.addAtom(ag[ak])}}}return al}return{dict:V}}();P=a=function(V,ah,ae){var Z=o.vec3;var af=V.Chain;var ab=V.ChainView;var W=ah.Bond;var ai={H:0.31,HE:0.28,LI:1.28,BE:0.96,B:0.84,C:0.76,N:0.71,O:0.66,F:0.57,NE:0.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69};function Y(ak){var aj=ai[ak.toUpperCase()];if(aj!==undefined){return aj}return 1.5}function ac(aj,ao,an){var am=ao.atom("C");var al=an.atom("N");if(am&&al){var ak=Z.sqrDist(am.pos(),al.pos());if(ak<1.6*1.6){aj.connect(al,am)}}}function ad(aj,an,am){var ao=an.atom("O3'");var al=am.atom("P");if(ao&&al){var ak=Z.sqrDist(ao.pos(),al.pos());if(ak<1.7*1.7){aj.connect(ao,al)}}}function ag(){}ag.prototype={eachResidue:function(ak){for(var aj=0;aj<this._chains.length;aj+=1){if(this._chains[aj].eachResidue(ak)===false){return false}}},eachAtom:function(al,aj){aj|=0;for(var ak=0;ak<this._chains.length;ak+=1){aj=this._chains[ak].eachAtom(al,aj);if(aj===false){return false}}},residueCount:function(){var al=this.chains();var ak=0;for(var aj=0;aj<al.length;++aj){ak+=al[aj].residues().length}return ak},eachChain:function(al){var ak=this.chains();for(var aj=0;aj<ak.length;++aj){if(al(ak[aj])===false){return}}},atomCount:function(){var al=this.chains();var ak=0;for(var aj=0;aj<al.length;++aj){ak+=al[aj].atomCount()}return ak},atoms:function(){var aj=[];this.eachAtom(function(ak){aj.push(ak)});return aj},atom:function(ak){var am=ak.split(".");var al=this.chain(am[0]);if(al===null){return null}var aj=al.residueByRnum(parseInt(am[1],10));if(aj===null){return null}return aj.atom(am[2])},center:function(){var aj=Z.create();var ak=0;this.eachAtom(function(al){Z.add(aj,aj,al.pos());ak+=1});if(ak){Z.scale(aj,aj,1/ak)}return aj},boundingSphere:function(){var aj=this.center();var ak=0;this.eachAtom(function(al){ak=Math.max(ak,Z.sqrDist(aj,al.pos()))});return new g.Sphere(aj,Math.sqrt(ak))},backboneTraces:function(){var al=this.chains();var aj=[];for(var ak=0;ak<al.length;++ak){Array.prototype.push.apply(aj,al[ak].backboneTraces())}return aj},select:function(aj){if(aj==="protein"){return this.residueSelect(function(ak){return ak.isAminoacid()})}if(aj==="water"){return this.residueSelect(function(ak){return ak.isWater()})}if(aj==="ligand"){return this.residueSelect(function(ak){return !ak.isAminoacid()&&!ak.isWater()})}return ae.dict(this,new aa(this),aj||{})},residueSelect:function(ak){console.time("Mol.residueSelect");var am=new aa(this.full());for(var ao=0;ao<this._chains.length;++ao){var an=this._chains[ao];var ap=null;var aj=an.residues();for(var al=0;al<aj.length;++al){if(ak(aj[al])){if(!ap){ap=am.addChain(an,false)}ap.addResidue(aj[al],true)}}}console.timeEnd("Mol.residueSelect");return am},atomSelect:function(ar){console.time("Mol.atomSelect");var ap=new aa(this.full());for(var au=0;au<this._chains.length;++au){var aj=this._chains[au];var al=null;var an=aj.residues();for(var aq=0;aq<an.length;++aq){var at=null;var ak=an[aq];var am=ak.atoms();for(var ao=0;ao<am.length;++ao){if(!ar(am[ao])){continue}if(!al){al=ap.addChain(aj,false)}if(!at){at=al.addResidue(ak,false)}at.addAtom(am[ao])}}}console.timeEnd("Mol.atomSelect");return ap},assembly:function(al){var ak=this.assemblies();for(var aj=0;aj<ak.length;++aj){if(ak[aj].name()===al){return ak[aj]}}return null},chainsByName:function(aj){var al={};var ao=this.chains();for(var am=0;am<ao.length;++am){al[ao[am].name()]=ao[am]}var an=[];for(var ak=0;ak<aj.length;++ak){var ap=al[aj[ak]];if(ap!==undefined){an.push(ap)}}return an},selectWithin:function(){var aj=Z.create();return function(an,aB){console.time("Mol.selectWithin");aB=aB||{};var aq=aB.radius||4;var ay=aq*aq;var az=!!aB.matchResidues;var al=[];an.eachAtom(function(aC){al.push(aC)});var av=new aa(this.full());var am=null,ap=null;var at=this.chains();var ax=false;for(var aA=0;aA<at.length;++aA){var ar=at[aA].residues();ap=null;for(var aw=0;aw<ar.length;++aw){am=null;ax=false;var ao=ar[aw].atoms();for(var au=0;au<ao.length;++au){if(ax){break}for(var ak=0;ak<al.length;++ak){Z.sub(aj,ao[au].pos(),al[ak].pos());if(Z.sqrLen(aj)>ay){continue}if(!ap){ap=av.addChain(at[aA].full(),false)}if(!am){am=ap.addResidue(ar[aw].full(),az)}if(az){ax=true;break}am.addAtom(ao[au].full());break}}}}console.timeEnd("Mol.selectWithin");return av}}(),createEmptyView:function(){return new aa(this.full())}};function X(){ag.call(this);this._chains=[];this._assemblies=[];this._nextAtomIndex=0}U.derive(X,ag,{addAssembly:function(aj){this._assemblies.push(aj)},setAssemblies:function(aj){this._assemblies=aj},assemblies:function(){return this._assemblies},chains:function(){return this._chains},full:function(){return this},containsResidue:function(aj){return aj.full().structure()===this},chainByName:function(aj){for(var ak=0;ak<this._chains.length;++ak){if(this._chains[ak].name()===aj){return this._chains[ak]}}return null},chain:function(aj){return this.chainByName(aj)},nextAtomIndex:function(){var aj=this._nextAtomIndex;this._nextAtomIndex+=1;return aj},addChain:function(aj){var ak=new af(this,aj);this._chains.push(ak);return ak},connect:function(ak,aj){var al=new W(ak,aj);ak.addBond(al);aj.addBond(al);return al},deriveConnectivity:function(){console.time("Mol.deriveConnectivity");var aj=this;var ak=null;this.eachResidue(function(aw){var ao;var au=aw.atoms();var av=au.length;for(var at=0;at<av;at+=1){var ap=au[at];var ax=ap.pos();var am=Y(ap.element());for(var aq=0;aq<at;aq+=1){var an=au[aq];var al=Y(an.element());ao=Z.sqrDist(ax,an.pos());var ar=am+al-0.3;var ay=am+al+0.3;if(ao<ay*ay&&ao>ar*ar){aj.connect(ap,an)}}}aw._deduceType();if(ak!==null){if(aw.isAminoacid()&&ak.isAminoacid()){ac(aj,ak,aw)}if(aw.isNucleotide()&&ak.isNucleotide()){ad(aj,ak,aw)}}ak=aw});console.timeEnd("Mol.deriveConnectivity")}});function aa(aj){ag.call(this);this._mol=aj;this._chains=[]}U.derive(aa,ag,{full:function(){return this._mol},assemblies:function(){return this._mol.assemblies()},addChain:function(al,am){var an=new ab(this,al.full());this._chains.push(an);if(am){var aj=al.residues();for(var ak=0;ak<aj.length;++ak){an.addResidue(aj[ak],true)}}return an},addAtom:function(ak){var aj=this.chain(ak.residue().chain().name());if(aj===null){aj=this.addChain(ak.residue().chain())}return aj.addAtom(ak)},removeAtom:function(al,aj){if(al===null){return false}var ak=this.chain(al.residue().chain().name());if(ak===null){return false}var am=ak.removeAtom(al,aj);if(am&&ak.residues().length===0){this._chains=this._chains.filter(function(an){return an!==ak})}return am},containsResidue:function(aj){if(!aj){return false}var ak=this.chain(aj.chain().name());if(!ak){return false}return ak.containsResidue(aj)},addResidues:function(aj,al){var ak=this;var am={};aj.forEach(function(an){var ao=an.chain().name();if(typeof am[ao]==="undefined"){am[ao]=ak.addChain(an.chain(),false)}am[ao].addResidue(an,al)});return am},chains:function(){return this._chains},chain:function(aj){for(var ak=0;ak<this._chains.length;++ak){if(this._chains[ak].name()===aj){return this._chains[ak]}}return null}});return{MolView:aa,Mol:X}}(h,j,D);d=function(){function V(ag){var aw;var W=Math.pow(2,-52);var aq=1e-64/W;var au=50;var ax=0;var ao=0;var an=0;var am=0;var ak=0;var ad=ag;var ai=ad.length;var ah=ad[0].length;if(ai<ah){throw"Need more rows than columns"}var av=new Array(ah);var af=new Array(ah);for(ao=0;ao<ah;ao++){av[ao]=af[ao]=0}var ac=[];for(var ao=0;ao<ah;++ao){var aj=[];ac.push([]);for(var an=0;an<ah;++an){aj.push(0)}ac.push(aj)}function Y(aA,az){aA=Math.abs(aA);az=Math.abs(az);if(aA>az){return aA*Math.sqrt(1+az*az/aA/aA)}else{if(az==0){return aA}}return az*Math.sqrt(1+aA*aA/az/az)}var at=0;var ar=0;var ap=0;var ab=0;var aa=0;var Z=0;var ae=0;for(ao=0;ao<ah;ao++){av[ao]=ar;ae=0;ak=ao+1;for(an=ao;an<ai;an++){ae+=ad[an][ao]*ad[an][ao]}if(ae<=aq){ar=0}else{at=ad[ao][ao];ar=Math.sqrt(ae);if(at>=0){ar=-ar}ap=at*ar-ae;ad[ao][ao]=at-ar;for(an=ak;an<ah;an++){ae=0;for(am=ao;am<ai;am++){ae+=ad[am][ao]*ad[am][an]}at=ae/ap;for(am=ao;am<ai;am++){ad[am][an]+=at*ad[am][ao]}}}af[ao]=ar;ae=0;for(an=ak;an<ah;an++){ae=ae+ad[ao][an]*ad[ao][an]}if(ae<=aq){ar=0}else{at=ad[ao][ao+1];ar=Math.sqrt(ae);if(at>=0){ar=-ar}ap=at*ar-ae;ad[ao][ao+1]=at-ar;for(an=ak;an<ah;an++){av[an]=ad[ao][an]/ap}for(an=ak;an<ai;an++){ae=0;for(am=ak;am<ah;am++){ae+=ad[an][am]*ad[ao][am]}for(am=ak;am<ah;am++){ad[an][am]+=ae*av[am]}}}aa=Math.abs(af[ao])+Math.abs(av[ao]);if(aa>ab){ab=aa}}for(ao=ah-1;ao!=-1;ao+=-1){if(ar!=0){ap=ar*ad[ao][ao+1];for(an=ak;an<ah;an++){ac[an][ao]=ad[ao][an]/ap}for(an=ak;an<ah;an++){ae=0;for(am=ak;am<ah;am++){ae+=ad[ao][am]*ac[am][an]}for(am=ak;am<ah;am++){ac[am][an]+=ae*ac[am][ao]}}}for(an=ak;an<ah;an++){ac[ao][an]=0;ac[an][ao]=0}ac[ao][ao]=1;ar=av[ao];ak=ao}for(ao=ah-1;ao!=-1;ao+=-1){ak=ao+1;ar=af[ao];for(an=ak;an<ah;an++){ad[ao][an]=0}if(ar!=0){ap=ad[ao][ao]*ar;for(an=ak;an<ah;an++){ae=0;for(am=ak;am<ai;am++){ae+=ad[am][ao]*ad[am][an]}at=ae/ap;for(am=ao;am<ai;am++){ad[am][an]+=at*ad[am][ao]}}for(an=ao;an<ai;an++){ad[an][ao]=ad[an][ao]/ar}}else{for(an=ao;an<ai;an++){ad[an][ao]=0}}ad[ao][ao]+=1}W=W*ab;for(am=ah-1;am!=-1;am+=-1){for(var X=0;X<au;X++){var ay=false;for(ak=am;ak!=-1;ak+=-1){if(Math.abs(av[ak])<=W){ay=true;break}if(Math.abs(af[ak-1])<=W){break}}if(!ay){ax=0;ae=1;var al=ak-1;for(ao=ak;ao<am+1;ao++){at=ae*av[ao];av[ao]=ax*av[ao];if(Math.abs(at)<=W){break}ar=af[ao];ap=Y(at,ar);af[ao]=ap;ax=ar/ap;ae=-at/ap;for(an=0;an<ai;an++){aa=ad[an][al];Z=ad[an][ao];ad[an][al]=aa*ax+Z*ae;ad[an][ao]=-aa*ae+Z*ax}}}Z=af[am];if(ak==am){if(Z<0){af[am]=-Z;for(an=0;an<ah;an++){ac[an][am]=-ac[an][am]}}break}if(X>=au-1){throw"Error: no convergence."}ab=af[ak];aa=af[am-1];ar=av[am-1];ap=av[am];at=((aa-Z)*(aa+Z)+(ar-ap)*(ar+ap))/(2*ap*aa);ar=Y(at,1);if(at<0){at=((ab-Z)*(ab+Z)+ap*(aa/(at-ar)-ap))/ab}else{at=((ab-Z)*(ab+Z)+ap*(aa/(at+ar)-ap))/ab}ax=1;ae=1;for(ao=ak+1;ao<am+1;ao++){ar=av[ao];aa=af[ao];ap=ae*ar;ar=ax*ar;Z=Y(at,ap);av[ao-1]=Z;ax=at/Z;ae=ap/Z;at=ab*ax+ar*ae;ar=-ab*ae+ar*ax;ap=aa*ae;aa=aa*ax;for(an=0;an<ah;an++){ab=ac[an][ao-1];Z=ac[an][ao];ac[an][ao-1]=ab*ax+Z*ae;ac[an][ao]=-ab*ae+Z*ax}Z=Y(at,ap);af[ao-1]=Z;ax=at/Z;ae=ap/Z;at=ax*ar+ae*aa;ab=-ae*ar+ax*aa;for(an=0;an<ai;an++){aa=ad[an][ao-1];Z=ad[an][ao];ad[an][ao-1]=aa*ax+Z*ae;ad[an][ao]=-aa*ae+Z*ax}}av[ak]=0;av[am]=at;af[am]=ab}}for(ao=0;ao<af.length;ao++){if(af[ao]<W){af[ao]=0}}for(ao=0;ao<ah;ao++){for(an=ao-1;an>=0;an--){if(af[an]<af[ao]){ax=af[an];af[an]=af[ao];af[ao]=ax;for(am=0;am<ad.length;am++){aw=ad[am][ao];ad[am][ao]=ad[am][an];ad[am][an]=aw}for(am=0;am<ac.length;am++){aw=ac[am][ao];ac[am][ao]=ac[am][an];ac[am][an]=aw}ao=an}}}return{U:ad,S:af,V:ac}}return V}();M=function(){var aa=o.vec3;var V=o.mat3;var W=o.quat;var ac=function(ah,ag){aa.set(ag,0,0,0);if(ah.length===0){return}for(var ai=0;ai<ah.length;++ai){var aj=ah[ai];aa.add(ag,ag,aj.pos())}aa.scale(ag,ag,1/ah.length)};var X=function(){var ah=aa.create();var ag=aa.create();return function(ao,aj,an,ai,ap){ap[0]=0;ap[1]=0;ap[2]=0;ap[3]=0;ap[4]=0;ap[5]=0;ap[6]=0;ap[7]=0;ap[8]=0;for(var al=0;al<aj.length;++al){aa.sub(ah,ao[al].pos(),an);aa.sub(ag,aj[al].pos(),ai);var ak=ah;var am=ag;ap[0]+=ak[0]*am[0];ap[1]+=ak[0]*am[1];ap[2]+=ak[0]*am[2];ap[3]+=ak[1]*am[0];ap[4]+=ak[1]*am[1];ap[5]+=ak[1]*am[2];ap[6]+=ak[2]*am[0];ap[7]+=ak[2]*am[1];ap[8]+=ak[2]*am[2]}}}();var af=function(){var ah=aa.create();var al=aa.create();var am=aa.create();var ak=V.create();var aj=V.create();var ai=V.create();var ag=V.create();var an=V.create();return function(ao,ap){var az=ao.atoms();var av=ap.atoms();ac(av,ah);ac(az,al);if(az.length!==av.length){console.error("atom counts do not match ("+az.length+"in structure vs "+av.length+" in reference)");return false}if(az.length<3){console.error("at least 3 atoms are required for superposition");return false}X(az,av,al,ah,aj);var ax=[[aj[0],aj[1],aj[2]],[aj[3],aj[4],aj[5]],[aj[6],aj[7],aj[8]]];var aB=[[],[],[]];var aA=[[],[],[]];var ar=d(ax);ag[0]=ar.U[0][0];ag[1]=ar.U[0][1];ag[2]=ar.U[0][2];ag[3]=ar.U[1][0];ag[4]=ar.U[1][1];ag[5]=ar.U[1][2];ag[6]=ar.U[2][0];ag[7]=ar.U[2][1];ag[8]=ar.U[2][2];var ay=V.determinant(ag);an[0]=ar.V[0][0];an[1]=ar.V[0][1];an[2]=ar.V[0][2];an[3]=ar.V[1][0];an[4]=ar.V[1][1];an[5]=ar.V[1][2];an[6]=ar.V[2][0];an[7]=ar.V[2][1];an[8]=ar.V[2][2];var aw=V.determinant(an);V.identity(ai);if(ay*aw<0){console.log("determinants smaller than zero!");ai[8]=-1;V.mul(ag,ag,ai)}console.log(V.str(ag));V.mul(ak,V.transpose(an,an),ag);var at=ao.full().atoms();for(var aq=0;aq<at.length;++aq){var au=at[aq];aa.sub(am,au.pos(),al);aa.transformMat3(am,am,ak);aa.add(am,ah,am);au.setPos(am)}return true}}();function Y(ah){if(ah===undefined||ah===null||ah==="all"){return null}if(ah==="backbone"){return{CA:true,C:true,O:true,N:true}}if(ah.substr!==undefined){var aj={};var ag=ah.split(",");for(var ai=0;ai<ag.length;++ai){aj[ag[ai].trim()]=true}return aj}else{var aj={};for(var ai=0;ai<ah.length;++ai){aj[ah[ai]]=true}return aj}}function ab(ap,ao,ah,ag,aq){var al=ap.atoms();var ak=ao.atoms();for(var aj=0;aj<al.length;++aj){var an=al[aj];if(aq!==null&&aq[an.name()]!==true){continue}for(var ai=0;ai<ak.length;++ai){var am=ak[ai];if(am.name()===an.name()){ah.push(an);ag.push(am);break}}}}function ad(ai,ah,aj,ar){var al=ai.full().createEmptyView();var ak=ah.full().createEmptyView();var ag=Math.min(ai.chains().length,ah.chains().length);var ao=Y(aj);for(var ax=0;ax<ag;++ax){var az=ai.chains()[ax];var ay=ah.chains()[ax];var aE=ar(az,ay);var an=aE[0];var am=aE[1];if(an.length!==am.length){console.error("chains",az.name()," and",ay.name()," do not contain the same number of residues.");return null}var aq=al.addChain(az);var ap=ak.addChain(ay);for(var av=0;av<an.length;++av){var aD=an[av];var aC=am[av];var aw=[],au=[];ab(aD,aC,aw,au,ao);if(aw.length===0){continue}var aB=aq.addResidue(aD);var aA=ap.addResidue(aC);for(var at=0;at<aw.length;++at){aB.addAtom(aw[at]);aA.addAtom(au[at])}}}return[al,ak]}function Z(ai,ah,ag){return ad(ai,ah,ag,function(ak,aj){return[ak.residues(),aj.residues()]})}function ae(ai,ah,ag){return ad(ai,ah,ag,function(an,al){var am=[],ak=[];var ap=an.residues();for(var ao=0;ao<ap.length;++ao){var aj=al.residueByRnum(ap[ao].num());if(aj!==null){am.push(ap[ao]);ak.push(aj)}}return[am,ak]})}return{superpose:af,matchResiduesByNum:ae,matchResiduesByIndex:Z,parseAtomNames:Y,addAtomsPresentInBoth:ab}}();k=a=function(aa){var X=o.vec3;var ab=function(){var ad=X.create();var ac=X.create();return function(ai,ah,af,ak){for(var ag=Math.max(0,ah-2);ag<=ah;++ag){for(var ae=2;ae<5;++ae){if(ag+ae>=ai.length()){continue}var aj=X.dist(ai.posAt(ad,ag),ai.posAt(ac,ag+ae));if(Math.abs(aj-af[ae-2])>ak){return false}}}return true}}();var W=function(af,ac){var ae=[5.45,5.18,6.37];var ad=2.1;return ab(af,ac,ae,ad)};var Z=function(ad,ac){var af=[6.1,10.4,13];var ae=1.42;return ab(ad,ac,af,ae)};function Y(ad){for(var ac=0;ac<ad.length();++ac){if(W(ad,ac)){ad.residueAt(ac).setSS("H");continue}if(Z(ad,ac)){ad.residueAt(ac).setSS("E");continue}ad.residueAt(ac).setSS("C")}}function V(ac){console.time("mol.assignHelixSheet");var af=ac.chains();for(var ae=0;ae<af.length;++ae){var ad=af[ae];ad.eachBackboneTrace(Y)}console.timeEnd("mol.assignHelixSheet")}return{Mol:a.Mol,MolView:a.MolView,assignHelixSheet:V,superpose:aa.superpose,matchResiduesByIndex:aa.matchResiduesByIndex,matchResiduesByNum:aa.matchResiduesByNum}}(M);y=function(ag){var ab=o.vec3;var W=o.mat4;function ad(){this._assemblies={};this._current=null}ad.prototype={assemblies:function(){var aj=[];for(var ai in this._assemblies){if(this._assemblies.hasOwnProperty(ai)){aj.push(this._assemblies[ai])}}return aj},assembly:function(ai){return this._assemblies[ai]},nextLine:function(at){at=at.substr(11);if(at[0]==="B"&&at.substr(0,12)==="BIOMOLECULE:"){var ai=at.substr(13).trim();this._currentAssembly=new ag.Assembly(ai);this._assemblies[ai]=this._currentAssembly;return}if(at.substr(0,30)==="APPLY THE FOLLOWING TO CHAINS:"||at.substr(0,30)==="                   AND CHAINS:"){var am=at.substr(30).split(",");if(at[0]==="A"){this._currentSymGen=new ag.SymGenerator();this._currentAssembly.addGenerator(this._currentSymGen)}this._currentMatrix=W.create();for(var al=0;al<am.length;++al){var ar=am[al].trim();if(ar.length){this._currentSymGen.addChain(ar)}}return}if(at.substr(0,7)==="  BIOMT"){var aj=parseInt(at[7],10)-1;var ak=0;while(at[12+ak]!==" "){ak+=1}var ap=parseFloat(at.substr(13+ak,9));var ao=parseFloat(at.substr(23+ak,9));var an=parseFloat(at.substr(33+ak,9));var aq=parseFloat(at.substr(43+ak,14));this._currentMatrix[4*0+aj]=ap;this._currentMatrix[4*1+aj]=ao;this._currentMatrix[4*2+aj]=an;this._currentMatrix[4*3+aj]=aq;if(aj===2){this._currentSymGen.addMatrix(this._currentMatrix);this._currentMatrix=W.create()}return}}};function X(aj){if(aj[0]!==" "){var am=aj.trim();if(am.length===4){var ak=0;var ai=am.charCodeAt(ak);while(ak<4&&(ai<65||ai>122||ai>90&&ai<97)){++ak;ai=am.charCodeAt(ak)}return am[ak]}var al=am.charCodeAt(0);if(al>=48&&al<=57){return am[1]}return am.substr(0,2)}return aj[1]}function ah(ai){this._helices=[];this._sheets=[];this._conect=[];this._serialToAtomMap={};this._structure=new a.Mol();this._remark350Reader=new ad();this._currChain=null;this._currRes=null;this._currAtom=null;this._options={};this._options.conectRecords=!!ai.conectRecords}ah.prototype={CONTINUE:1,MODEL_COMPLETE:2,FILE_END:3,ERROR:4,parseHelixRecord:function(ak){var aj=parseInt(ak.substr(21,4),10);var al=ak[25]===" "?"\0":ak[25];var ai=parseInt(ak.substr(33,4),10);var am=ak[37]===" "?"\0":ak[37];var an=ak[19];this._helices.push({first:[aj,al],last:[ai,am],chainName:an});return true},parseSheetRecord:function(ak){var aj=parseInt(ak.substr(22,4),10);var al=ak[26]===" "?"\0":ak[26];var ai=parseInt(ak.substr(33,4),10);var am=ak[37]===" "?"\0":ak[37];var an=ak[21];this._sheets.push({first:[aj,al],last:[ai,am],chainName:an});return true},parseAndAddAtom:function(ar){var al=ar[16];if(al!==" "&&al!=="A"){return true}var av=ar[0]==="H";var an=ar[21];var ax=ar.substr(17,3).trim();var aw=ar.substr(12,4);var ai=aw.trim();var ay=parseInt(ar.substr(22,4),10);if(ay!==ay){ay=1}var at=ar[26]===" "?"\0":ar[26];var aA=false;var au=false;if(!this._currChain||this._currChain.name()!==an){au=true;aA=true}if(!this._currRes||this._currRes.num()!==ay||this._currRes.insCode()!==at){aA=true}if(au){this._currChain=this._structure.chain(an)||this._structure.addChain(an)}if(aA){this._currRes=this._currChain.addResidue(ax,ay,at)}var ap=ab.create();for(var az=0;az<3;++az){ap[az]=parseFloat(ar.substr(30+az*8,8))}var ak=ar.substr(76,2).trim();if(ak===""){ak=X(aw)}var aq=parseFloat(ar.substr(54,6).trim());var ao=parseFloat(ar.substr(60,6).trim());var aj=this._currRes.addAtom(ai,ap,ak,av,isNaN(aq)?null:aq,isNaN(ao)?null:ao);if(this._options.conectRecords){var am=parseInt(ar.substr(6,5).trim(),10);this._serialToAtomMap[am]=aj}return true},parseConectRecord:function(ai){var ak=parseInt(ai.substr(6,5).trim(),10);var aj=[];for(var al=0;al<4;++al){var am=parseInt(ai.substr(11+al*5,6).trim(),10);if(isNaN(am)){continue}if(am>ak){continue}aj.push(am)}this._conect.push({from:ak,to:aj});return true},processLine:function(ai){var ak=ai.substr(0,6);if(ak==="ATOM  "||ak==="HETATM"){return this.parseAndAddAtom(ai)?this.CONTINUE:this.ERROR}if(ak==="REMARK"){var aj=ai.substr(7,3);if(aj==="350"){this._remark350Reader.nextLine(ai)}return this.CONTINUE}if(ak==="HELIX "){return this.parseHelixRecord(ai)?this.CONTINUE:this.ERROR}if(ak==="SHEET "){return this.parseSheetRecord(ai)?this.CONTINUE:this.ERROR}if(this._options.conectRecords&&ak==="CONECT"){return this.parseConectRecord(ai)?this.CONTINUE:this.ERROR}if(ak==="END   "){return this.FILE_END}if(ak==="ENDMDL"){return this.MODEL_COMPLETE}return this.CONTINUE},finish:function(){if(this._currChain===null){return null}var am=null;var al;for(al=0;al<this._sheets.length;++al){var ak=this._sheets[al];am=this._structure.chain(ak.chainName);if(am){am.assignSS(ak.first,ak.last,"E")}}for(al=0;al<this._helices.length;++al){var aj=this._helices[al];am=this._structure.chain(aj.chainName);if(am){am.assignSS(aj.first,aj.last,"H")}}this._structure.setAssemblies(this._remark350Reader.assemblies());if(this._options.conectRecords){this._assignBondsFromConectRecords(this._structure)}this._structure.deriveConnectivity();console.log("imported",this._structure.chains().length,"chain(s),",this._structure.residueCount(),"residue(s)");var ai=this._structure;this._structure=new a.Mol();this._currChain=null;this._currRes=null;this._currAtom=null;return ai},_assignBondsFromConectRecords:function(aj){for(var al=0;al<this._conect.length;++al){var ai=this._conect[al];var an=this._serialToAtomMap[ai.from];for(var ak=0;ak<ai.to.length;++ak){var am=this._serialToAtomMap[ai.to[ak]];aj.connect(an,am)}}}};function ac(ai){return ai.split(/\r\n|\r|\n/g)}function Z(an,ap){console.time("pdb");var ai=ap||{};var aq=ac(an);var am=new ah(ai);var ao=[];for(var al=0;al<aq.length;al++){var ar=am.processLine(aq[al]);if(ar===am.ERROR){console.timeEnd("pdb");return null}if(ar===am.CONTINUE){continue}var ak=am.finish();if(ak!==null){ao.push(ak)}if(ar===am.MODEL_COMPLETE&&ai.loadAllModels){continue}break}var aj=am.finish();if(aj!==null){ao.push(aj)}console.timeEnd("pdb");if(ai.loadAllModels){return ao}return ao[0]}function aa(){this._structure=new a.Mol();this._reset();this._sawEnd=false}aa.prototype={processLine:function(ar){var ai=this._state;if(ai<3){if(ai===0){var an=ar.trim();if(an.length===0){return false}this._title=an}this._sawEnd=false;this._state++;return true}if(ai===3){this._expectedAtomCount=parseInt(ar.substr(0,3).trim(),10);this._expectedBondCount=parseInt(ar.substr(3,3).trim(),10);if(isNaN(this._expectedAtomCount)||isNaN(this._expectedBondCount)){console.error("invalid bond definition");return false}this._state++;var ap=""+(this._structure.chains().length+1);this._currentChain=this._structure.addChain(ap);this._currentResidue=this._currentChain.addResidue(this._title,1)}if(ai===4){var ao=[0,0,0];for(var aj=0;aj<3;++aj){ao[aj]=parseFloat(ar.substr(aj*10,10).trim());if(isNaN(ao[aj])){console.error("invalid atom position");return false}}var ak=ar.substr(31,3).trim();this._currentResidue.addAtom(ak,ao,ak,false);this._atomCount++;if(this._atomCount===this._expectedAtomCount){this._state++}}if(ai===5){var aq=parseInt(ar.substr(0,3).trim(),10)-1;var am=parseInt(ar.substr(3,3).trim(),10)-1;if(isNaN(aq)||isNaN(am)){console.error("invalid bond definition");return false}var al=this._currentResidue.atoms();this._structure.connect(al[aq],al[am]);this._bondCount++;if(this._bondCount===this._expectedBondCount){this._state++}}if(ar.substr(0,6)==="M  END"){this._sawEnd=true;this._state++}if(ar.substr(0,4)==="$$$$"){this._reset()}return true},_reset:function(){this._state=0;this._currentResidue=null;this._currentChain=null;this._expectedAtomCount=null;this._expectedBondount=null;this._atomCount=0;this._bondCount=0;this._title=""},finish:function(){if(!this._sawEnd){console.error("truncated SDF file");return null}return this._structure}};function af(am){console.time("sdf");var ai=new aa();var ak=ac(am);for(var al=0;al<ak.length;al++){if(!ai.processLine(ak[al])){break}}var aj=ai.finish();console.timeEnd("sdf");return aj}function V(ai,ak){var aj=new XMLHttpRequest();aj.open("GET",ai,true);aj.onload=function(){if(aj.response){ak(aj.response)}};aj.send(null)}function ae(aj,ak,ai){V(aj,function(am){var al=Z(am,ai);ak(al)})}function Y(ai,aj){V(ai,function(al){var ak=af(al);aj(ak)})}return{pdb:Z,sdf:af,Remark350Reader:ad,fetchPdb:ae,fetchSdf:Y,guessAtomElementFromName:X}}(p);I=function(){var W=o.vec3;var V=o.mat3;var X=function(){var Z=W.create();var aa=W.create();return function(ab,ac){W.set(Z,0,0,0);var ad=0;ab.eachCentralAtom(function(ae,af){W.add(Z,Z,af);ad+=1});if(ad===0){return}W.scale(Z,Z,1/ad);ac[0]=0;ac[1]=0;ac[2]=0;ac[3]=0;ac[4]=0;ac[5]=0;ac[6]=0;ac[7]=0;ac[8]=0;ab.eachCentralAtom(function(af,ag){W.sub(aa,ag,Z);var ae=aa[0],ai=aa[1],ah=aa[2];ac[0]+=ai*ai+ah*ah;ac[1]-=ae*ai;ac[2]-=ae*ah;ac[5]-=ai*ah;ac[4]+=ae*ae+ah*ah;ac[8]+=ae*ae+ai*ai});ac[3]=ac[1];ac[6]=ac[2];ac[7]=ac[5]}}();var Y=function(){var ac=V.create();var ab=V.create();var Z=W.create();var af=W.create();var ah=W.create();var aa=W.create();var ag=W.create();var ae=W.create();var ad=W.create();return function(al){X(al,ac);var am=g.diagonalizer(ac);V.fromQuat(ab,am);var ao=true;al.eachCentralAtom(function(ap,aq){W.transformMat3(ah,aq,ab);if(ao){W.copy(Z,ah);W.copy(af,ah);ao=false}else{W.min(Z,Z,ah);W.max(af,af,ah)}});W.sub(aa,af,Z);var an=[[aa[0],0],[aa[1],1],[aa[2],2]];an.sort(function(aq,ap){return ap[0]-aq[0]});var aj=an[0][1];var ai=an[1][1];W.set(ag,ab[aj+0],ab[aj+3],ab[aj+6]);W.set(ae,ab[ai+0],ab[ai+3],ab[ai+6]);W.cross(ad,ag,ae);var ak=V.create();ak[0]=ag[0];ak[1]=ae[0];ak[2]=ad[0];ak[3]=ag[1];ak[4]=ae[1];ak[5]=ad[1];ak[6]=ag[2];ak[7]=ae[2];ak[8]=ad[2];return ak}}();return{principalAxes:Y}}();f=function(){return{Viewer:C.Viewer,isWebGLSupported:C.isWebGLSupported,io:y,color:w,mol:a,rgb:{setColorPalette:w.setColorPalette,hex2rgb:w.hex2rgb},vec3:o.vec3,vec4:o.vec4,mat3:o.mat3,mat4:o.mat4,quat:o.quat,viewpoint:I}}();return f}));gth>listIdx&&residues[listIdx].full().index()<traceIndex){++listIdx}if(listIdx>=residues.length){break}var fullTraceBegin=fullTraceIdx;while(residues.length>listIdx&&this._trace.length>fullTraceIdx&&residues[listIdx].full().index()===this._trace[fullTraceIdx].index()){++listIdx;++fullTraceIdx}var fullTraceEnd=fullTraceIdx;subsets.push(new TraceSubset(this,fullTraceBegin,fullTraceEnd))}return subsets}};BackboneTrace.prototype.smoothPosAt=BackboneTrace.prototype.posAt;BackboneTrace.prototype.smoothNormalAt=BackboneTrace.prototype.normalAt;function TraceSubset(fullTrace,fullTraceBegin,fullTraceEnd){this._fullTrace=fullTrace;this._fullTraceBegin=fullTraceBegin;this._fullTraceEnd=fullTraceEnd;this._isNTerminal=this._fullTraceBegin===0;this._isCTerminal=this._fullTrace.length()===this._fullTraceEnd;var length=this._fullTraceEnd-this._fullTraceBegin;if(!this._isCTerminal){++length}if(!this._isNTerminal){++length;this._fullTraceBegin-=1}this._length=length}TraceSubset.prototype={length:function(){return this._length},residueAt:function(index){return this._fullTrace.residueAt(this._fullTraceBegin+index)},_interpolate:function(){var tangentOne=vec3.create();var tangentTwo=vec3.create();return function(out,indexOne,indexTwo,strength){this.tangentAt(tangentOne,indexOne);this.tangentAt(tangentTwo,indexTwo);vec3.scale(tangentOne,tangentOne,strength);vec3.scale(tangentTwo,tangentTwo,strength);geom.cubicHermiteInterpolate(out,this.centralAtomAt(indexOne).pos(),tangentOne,this.centralAtomAt(indexTwo).pos(),tangentTwo,.5,0);return out}}(),smoothPosAt:function(){return function(out,index,strength){if(index===0&&!this._isNTerminal){return this._interpolate(out,index,index+1,strength)}if(index===this._length-1&&!this._isCTerminal){return this._interpolate(out,index-1,index,strength)}var atom=this.centralAtomAt(index);vec3.copy(out,atom.pos());return out}}(),smoothNormalAt:function(){return function(out,index){this._fullTrace.normalAt(out,index+this._fullTraceBegin);return out}}(),posAt:function(out,index){var atom=this.centralAtomAt(index);var atom2=null;vec3.copy(out,atom.pos());if(index===0&&!this._isNTerminal){atom2=this.centralAtomAt(index+1);vec3.add(out,out,atom2.pos());vec3.scale(out,out,.5)}if(index===this._length-1&&!this._isCTerminal){atom2=this.centralAtomAt(index-1);vec3.add(out,out,atom2.pos());vec3.scale(out,out,.5)}return out},centralAtomAt:function(index){return this.residueAt(index).centralAtom()},fullTraceIndex:function(index){return this._fullTraceBegin+index},tangentAt:function(out,index){return this._fullTrace.tangentAt(out,index+this._fullTraceBegin)}};return{TraceSubset:TraceSubset,BackboneTrace:BackboneTrace}}();molChain=function(residue,trace){var vec3=glMatrix.vec3;var Residue=residue.Residue;var ResidueView=residue.ResidueView;function rnumInsCodeHash(num,insCode){return num<<8|insCode.charCodeAt(0)}function rnumComp(lhs,rhs){return lhs.num()<rhs.num()}function numify(val){return{num:function(){return val}}}function ChainBase(){}ChainBase.prototype={eachAtom:function(callback,index){index|=0;for(var i=0;i<this._residues.length;i+=1){index=this._residues[i].eachAtom(callback,index);if(index===false){return false}}return index},atomCount:function(){var count=0;var residues=this.residues();for(var ri=0;ri<residues.length;++ri){count+=residues[ri].atoms().length}return count},eachResidue:function(callback){for(var i=0;i<this._residues.length;i+=1){if(callback(this._residues[i])===false){return false}}},residues:function(){return this._residues},structure:function(){return this._structure},asView:function(){var view=this.structure().createEmptyView();view.addChain(this,true);return view},residueByRnum:function(rnum){var residues=this.residues();if(this._rnumsOrdered){var index=utils.binarySearch(residues,numify(rnum),rnumComp);if(index===-1){return null}return residues[index]}else{for(var i=0;i<residues.length;++i){if(residues[i].num()===rnum){return residues[i]}}return null}},residuesInRnumRange:function(start,end){var matching=[];var i,e;var residues=this.residues();if(this._rnumsOrdered===true){var startIdx=utils.indexFirstLargerEqualThan(residues,numify(start),rnumComp);if(startIdx===-1){return matching}var endIdx=utils.indexLastSmallerEqualThan(residues,numify(end),rnumComp);if(endIdx===-1){return matching}for(i=startIdx;i<=endIdx;++i){matching.push(this._residues[i])}}else{for(i=0,e=residues.length;i!==e;++i){var res=residues[i];if(res.num()>=start&&res.num()<=end){matching.push(res)}}}return matching},prop:function(propName){return this[propName]()}};function Chain(structure,name){ChainBase.call(this);this._structure=structure;this._name=name;this._cachedTraces=[];this._residues=[];this._rnumsOrdered=true}function shouldIntroduceTraceBreak(aaStretch,prevResidue,thisResidue){var prevAtom,thisAtom;if(aaStretch){prevAtom=prevResidue.atom("C");thisAtom=thisResidue.atom("N")}else{prevAtom=prevResidue.atom("O3'");thisAtom=thisResidue.atom("P")}if(prevAtom.isConnectedTo(thisAtom)){return false}var sqrDist=vec3.sqrDist(prevAtom.pos(),thisAtom.pos());return Math.abs(sqrDist-1.5*1.5)>1}function addNonEmptyTrace(traces,trace){if(trace.length()<2){return}traces.push(trace)}function checkRnumsOrdered(residues,orderedFlag,newResidue){if(residues.length===0){return true}if(!orderedFlag){return false}var combinedRNum=rnumInsCodeHash(newResidue.num(),newResidue.insCode());var last=residues[residues.length-1];var lastCombinedRNum=rnumInsCodeHash(last.num(),last.insCode());return lastCombinedRNum<combinedRNum}utils.derive(Chain,ChainBase,{name:function(){return this._name},full:function(){return this},addResidue:function(name,num,insCode){insCode=insCode||"\0";var residue=new Residue(this,name,num,insCode);this._rnumsOrdered=checkRnumsOrdered(this._residues,this._rnumsOrdered,residue);this._residues.push(residue);return residue},assignSS:function(fromNumAndIns,toNumAndIns,ss){var from=rnumInsCodeHash(fromNumAndIns[0],fromNumAndIns[1]);var to=rnumInsCodeHash(toNumAndIns[0],toNumAndIns[1]);for(var i=1;i<this._residues.length-1;++i){var res=this._residues[i];var combined=rnumInsCodeHash(res.num(),res.insCode());if(combined<=from||combined>=to){continue}res.setSS(ss)}},eachBackboneTrace:function(callback){this._cacheBackboneTraces();for(var i=0;i<this._cachedTraces.length;++i){callback(this._cachedTraces[i])}},_cacheBackboneTraces:function(){if(this._cachedTraces.length>0){return}var stretch=new trace.BackboneTrace;var aaStretch=null;for(var i=0;i<this._residues.length;i+=1){var residue=this._residues[i];var isAminoacid=residue.isAminoacid();var isNucleotide=residue.isNucleotide();if(aaStretch===true&&!isAminoacid||aaStretch===false&&!isNucleotide||aaStretch===null&&!isNucleotide&&!isAminoacid){addNonEmptyTrace(this._cachedTraces,stretch);aaStretch=null;stretch=new trace.BackboneTrace;continue}if(stretch.length()===0){stretch.push(residue);aaStretch=residue.isAminoacid();continue}var prevResidue=this._residues[i-1];if(shouldIntroduceTraceBreak(aaStretch,prevResidue,residue)){addNonEmptyTrace(this._cachedTraces,stretch);stretch=new trace.BackboneTrace}stretch.push(residue)}addNonEmptyTrace(this._cachedTraces,stretch)},backboneTraces:function(){var traces=[];this.eachBackboneTrace(function(trace){traces.push(trace)});return traces}});function ChainView(molView,chain){ChainBase.call(this);this._chain=chain;this._residues=[];this._molView=molView;this._residueMap={};this._rnumsOrdered=true}utils.derive(ChainView,ChainBase,{addResidue:function(residue,recurse){var resView=new ResidueView(this,residue.full());this._rnumsOrdered=checkRnumsOrdered(this._residues,this._rnumsOrdered,residue);this._residues.push(resView);this._residueMap[residue.full().index()]=resView;if(recurse){var atoms=residue.atoms();for(var i=0;i<atoms.length;++i){resView.addAtom(atoms[i].full(),false)}}return resView},addAtom:function(atom){var resView=this._residueMap[atom.residue().full().index()];if(resView===undefined){resView=this.addResidue(atom.residue())}return resView.addAtom(atom,true)},removeAtom:function(atom,removeEmptyResidues){var resView=this._residueMap[atom.residue().full().index()];if(resView===undefined){return false}var removed=resView.removeAtom(atom);if(removed&&resView.atoms().length===0&&removeEmptyResidues){delete this._residueMap[atom.residue().full().index()];this._residues=this._residues.filter(function(r){return r!==resView})}return removed},containsResidue:function(residue){var resView=this._residueMap[residue.full().index()];if(resView===undefined){return false}return resView.full()===residue.full()},eachBackboneTrace:function(callback){var fullTraces=this._chain.backboneTraces();for(var i=0;i<fullTraces.length;++i){var subsets=fullTraces[i].subsets(this._residues);for(var j=0;j<subsets.length;++j){callback(subsets[j])}}},backboneTraces:function(){var traces=[];this.eachBackboneTrace(function(trace){traces.push(trace)});return traces},full:function(){return this._chain},name:function(){return this._chain.name()},structure:function(){return this._molView}});return{Chain:Chain,ChainView:ChainView}}(molResidue,molTrace);molBond=function(){var vec3=glMatrix.vec3;var Bond=function(atom_a,atom_b){var self={atom_one:atom_a,atom_two:atom_b};return{atom_one:function(){return self.atom_one},atom_two:function(){return self.atom_two},mid_point:function(out){if(!out){out=vec3.create()}vec3.add(out,self.atom_one.pos(),self.atom_two.pos());vec3.scale(out,out,.5);return out}}};return{Bond:Bond}}();molSelect=function(){function fulfillsPredicates(obj,predicates){for(var i=0;i<predicates.length;++i){if(!predicates[i](obj)){return false}}return true}function _atomPredicates(dict){var predicates=[];if(dict.aname!==undefined){predicates.push(function(a){return a.name()===dict.aname})}if(dict.hetatm!==undefined){predicates.push(function(a){return a.isHetatm()===dict.hetatm})}if(dict.anames!==undefined){predicates.push(function(a){var n=a.name();for(var k=0;k<dict.anames.length;++k){if(n===dict.anames[k]){return true}}return false})}return predicates}function _residuePredicates(dict){var predicates=[];if(dict.rname!==undefined){predicates.push(function(r){return r.name()===dict.rname})}if(dict.rnames!==undefined){predicates.push(function(r){var n=r.name();for(var k=0;k<dict.rnames.length;++k){if(n===dict.rnames[k]){return true}}return false})}if(dict.rnums!==undefined){var num_set={};for(var i=0;i<dict.rnums.length;++i){num_set[dict.rnums[i]]=true}predicates.push(function(r){var n=r.num();return num_set[n]===true})}if(dict.rnum!==undefined){predicates.push(function(r){return r.num()===dict.rnum})}return predicates}function _chainPredicates(dict){var predicates=[];if(dict.cname!==undefined){dict.chain=dict.cname}if(dict.cnames!==undefined){dict.chains=dict.cnames}if(dict.chain!==undefined){predicates.push(function(c){return c.name()===dict.chain})}if(dict.chains!==undefined){predicates.push(function(c){var n=c.name();for(var k=0;k<dict.chains.length;++k){if(n===dict.chains[k]){return true}}return false})}return predicates}function _filterResidues(chain,dict){var residues=chain.residues();if(dict.rnumRange){residues=chain.residuesInRnumRange(dict.rnumRange[0],dict.rnumRange[1])}var selResidues=[],i,e;if(dict.rindexRange!==undefined){for(i=dict.rindexRange[0],e=Math.min(residues.length-1,dict.rindexRange[1]);i<=e;++i){selResidues.push(residues[i])}return selResidues}if(dict.rindices){if(dict.rindices.length!==undefined){selResidues=[];for(i=0;i<dict.rindices.length;++i){selResidues.push(residues[dict.rindices[i]])}return selResidues}}return residues}function dictSelect(structure,view,dict){var residuePredicates=_residuePredicates(dict);var atomPredicates=_atomPredicates(dict);var chainPredicates=_chainPredicates(dict);if(dict.rindex){dict.rindices=[dict.rindex]}for(var ci=0;ci<structure._chains.length;++ci){var chain=structure._chains[ci];if(!fulfillsPredicates(chain,chainPredicates)){continue}var residues=_filterResidues(chain,dict);var chainView=null;for(var ri=0;ri<residues.length;++ri){if(!fulfillsPredicates(residues[ri],residuePredicates)){continue}if(!chainView){chainView=view.addChain(chain,false)}var residueView=null;var atoms=residues[ri].atoms();for(var ai=0;ai<atoms.length;++ai){if(!fulfillsPredicates(atoms[ai],atomPredicates)){continue}if(!residueView){residueView=chainView.addResidue(residues[ri],false)}residueView.addAtom(atoms[ai])}}}return view}return{dict:dictSelect}}();molMol=mol=function(chain,bond,select){var vec3=glMatrix.vec3;var Chain=chain.Chain;var ChainView=chain.ChainView;var Bond=bond.Bond;var ELEMENT_COVALENT_RADII={H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69};function covalentRadius(ele){var r=ELEMENT_COVALENT_RADII[ele.toUpperCase()];if(r!==undefined){return r}return 1.5}function connectPeptides(structure,left,right){var cAtom=left.atom("C");var nAtom=right.atom("N");if(cAtom&&nAtom){var sqrDist=vec3.sqrDist(cAtom.pos(),nAtom.pos());if(sqrDist<1.6*1.6){structure.connect(nAtom,cAtom)}}}function connectNucleotides(structure,left,right){var o3Prime=left.atom("O3'");var pAtom=right.atom("P");if(o3Prime&&pAtom){var sqrDist=vec3.sqrDist(o3Prime.pos(),pAtom.pos());if(sqrDist<1.7*1.7){structure.connect(o3Prime,pAtom)}}}function MolBase(){}MolBase.prototype={eachResidue:function(callback){for(var i=0;i<this._chains.length;i+=1){if(this._chains[i].eachResidue(callback)===false){return false}}},eachAtom:function(callback,index){index|=0;for(var i=0;i<this._chains.length;i+=1){index=this._chains[i].eachAtom(callback,index);if(index===false){return false}}},residueCount:function(){var chains=this.chains();var count=0;for(var ci=0;ci<chains.length;++ci){count+=chains[ci].residues().length}return count},eachChain:function(callback){var chains=this.chains();for(var i=0;i<chains.length;++i){if(callback(chains[i])===false){return}}},atomCount:function(){var chains=this.chains();var count=0;for(var ci=0;ci<chains.length;++ci){count+=chains[ci].atomCount()}return count},atoms:function(){var atoms=[];this.eachAtom(function(atom){atoms.push(atom)});return atoms},atom:function(name){var parts=name.split(".");var chain=this.chain(parts[0]);if(chain===null){return null}var residue=chain.residueByRnum(parseInt(parts[1],10));if(residue===null){return null}return residue.atom(parts[2])},center:function(){var sum=vec3.create();var count=0;this.eachAtom(function(atom){vec3.add(sum,sum,atom.pos());count+=1});if(count){vec3.scale(sum,sum,1/count)}return sum},boundingSphere:function(){var center=this.center();var radiusSquare=0;this.eachAtom(function(atom){radiusSquare=Math.max(radiusSquare,vec3.sqrDist(center,atom.pos()))});return new geom.Sphere(center,Math.sqrt(radiusSquare))},backboneTraces:function(){var chains=this.chains();var traces=[];for(var i=0;i<chains.length;++i){Array.prototype.push.apply(traces,chains[i].backboneTraces())}return traces},select:function(what){if(what==="protein"){return this.residueSelect(function(r){return r.isAminoacid()})}if(what==="water"){return this.residueSelect(function(r){return r.isWater()})}if(what==="ligand"){return this.residueSelect(function(r){return!r.isAminoacid()&&!r.isWater()})}return select.dict(this,new MolView(this),what||{})},residueSelect:function(predicate){console.time("Mol.residueSelect");var view=new MolView(this.full());for(var ci=0;ci<this._chains.length;++ci){var chain=this._chains[ci];var chainView=null;var residues=chain.residues();for(var ri=0;ri<residues.length;++ri){if(predicate(residues[ri])){if(!chainView){chainView=view.addChain(chain,false)}chainView.addResidue(residues[ri],true)}}}console.timeEnd("Mol.residueSelect");return view},atomSelect:function(predicate){console.time("Mol.atomSelect");var view=new MolView(this.full());for(var ci=0;ci<this._chains.length;++ci){var chain=this._chains[ci];var chainView=null;var residues=chain.residues();for(var ri=0;ri<residues.length;++ri){var residueView=null;var residue=residues[ri];var atoms=residue.atoms();for(var ai=0;ai<atoms.length;++ai){if(!predicate(atoms[ai])){continue}if(!chainView){chainView=view.addChain(chain,false)}if(!residueView){residueView=chainView.addResidue(residue,false)}residueView.addAtom(atoms[ai])}}}console.timeEnd("Mol.atomSelect");return view},assembly:function(id){var assemblies=this.assemblies();for(var i=0;i<assemblies.length;++i){if(assemblies[i].name()===id){return assemblies[i]}}return null},chainsByName:function(chainNames){var chainMap={};var chains=this.chains();for(var i=0;i<chains.length;++i){chainMap[chains[i].name()]=chains[i]}var filteredChains=[];for(var j=0;j<chainNames.length;++j){var filteredChain=chainMap[chainNames[j]];if(filteredChain!==undefined){filteredChains.push(filteredChain)}}return filteredChains},selectWithin:function(){var dist=vec3.create();return function(mol,options){console.time("Mol.selectWithin");options=options||{};var radius=options.radius||4;var radiusSqr=radius*radius;var matchResidues=!!options.matchResidues;var targetAtoms=[];mol.eachAtom(function(a){targetAtoms.push(a)});var view=new MolView(this.full());var addedRes=null,addedChain=null;var chains=this.chains();var skipResidue=false;for(var ci=0;ci<chains.length;++ci){var residues=chains[ci].residues();addedChain=null;for(var ri=0;ri<residues.length;++ri){addedRes=null;skipResidue=false;var atoms=residues[ri].atoms();for(var ai=0;ai<atoms.length;++ai){if(skipResidue){break}for(var wi=0;wi<targetAtoms.length;++wi){vec3.sub(dist,atoms[ai].pos(),targetAtoms[wi].pos());if(vec3.sqrLen(dist)>radiusSqr){continue}if(!addedChain){addedChain=view.addChain(chains[ci].full(),false)}if(!addedRes){addedRes=addedChain.addResidue(residues[ri].full(),matchResidues)}if(matchResidues){skipResidue=true;break}addedRes.addAtom(atoms[ai].full());break}}}}console.timeEnd("Mol.selectWithin");return view}}(),createEmptyView:function(){return new MolView(this.full())}};function Mol(){MolBase.call(this);this._chains=[];this._assemblies=[];this._nextAtomIndex=0}utils.derive(Mol,MolBase,{addAssembly:function(assembly){this._assemblies.push(assembly)},setAssemblies:function(assemblies){this._assemblies=assemblies},assemblies:function(){return this._assemblies},chains:function(){return this._chains},full:function(){return this},containsResidue:function(residue){return residue.full().structure()===this},chainByName:function(name){for(var i=0;i<this._chains.length;++i){if(this._chains[i].name()===name){return this._chains[i]}}return null},chain:function(name){return this.chainByName(name)},nextAtomIndex:function(){var nextIndex=this._nextAtomIndex;this._nextAtomIndex+=1;return nextIndex},addChain:function(name){var chain=new Chain(this,name);this._chains.push(chain);return chain},connect:function(atom_a,atom_b){var bond=new Bond(atom_a,atom_b);atom_a.addBond(bond);atom_b.addBond(bond);return bond},deriveConnectivity:function(){console.time("Mol.deriveConnectivity");var thisStructure=this;var prevResidue=null;this.eachResidue(function(res){var sqrDist;var atoms=res.atoms();var numAtoms=atoms.length;for(var i=0;i<numAtoms;i+=1){var atomI=atoms[i];var posI=atomI.pos();var covalentI=covalentRadius(atomI.element());for(var j=0;j<i;j+=1){var atomJ=atoms[j];var covalentJ=covalentRadius(atomJ.element());sqrDist=vec3.sqrDist(posI,atomJ.pos());var lower=covalentI+covalentJ-.3;var upper=covalentI+covalentJ+.3;if(sqrDist<upper*upper&&sqrDist>lower*lower){thisStructure.connect(atomI,atomJ)}}}res._deduceType();if(prevResidue!==null){if(res.isAminoacid()&&prevResidue.isAminoacid()){connectPeptides(thisStructure,prevResidue,res)}if(res.isNucleotide()&&prevResidue.isNucleotide()){connectNucleotides(thisStructure,prevResidue,res)}}prevResidue=res});console.timeEnd("Mol.deriveConnectivity")}});function MolView(mol){MolBase.call(this);this._mol=mol;this._chains=[]}utils.derive(MolView,MolBase,{full:function(){return this._mol},assemblies:function(){return this._mol.assemblies()},addChain:function(chain,recurse){var chainView=new ChainView(this,chain.full());this._chains.push(chainView);if(recurse){var residues=chain.residues();for(var i=0;i<residues.length;++i){chainView.addResidue(residues[i],true)}}return chainView},addAtom:function(atom){var chain=this.chain(atom.residue().chain().name());if(chain===null){chain=this.addChain(atom.residue().chain())}return chain.addAtom(atom)},removeAtom:function(atom,removeEmptyResiduesAndChains){if(atom===null){return false}var chain=this.chain(atom.residue().chain().name());if(chain===null){return false}var removed=chain.removeAtom(atom,removeEmptyResiduesAndChains);if(removed&&chain.residues().length===0){this._chains=this._chains.filter(function(c){return c!==chain})}return removed},containsResidue:function(residue){if(!residue){return false}var chain=this.chain(residue.chain().name());if(!chain){return false}return chain.containsResidue(residue)},addResidues:function(residues,recurse){var that=this;var chainsViews={};residues.forEach(function(residue){var chainName=residue.chain().name();if(typeof chainsViews[chainName]==="undefined"){chainsViews[chainName]=that.addChain(residue.chain(),false)}chainsViews[chainName].addResidue(residue,recurse)});return chainsViews},chains:function(){return this._chains},chain:function(name){for(var i=0;i<this._chains.length;++i){if(this._chains[i].name()===name){return this._chains[i]}}return null}});return{MolView:MolView,Mol:Mol}}(molChain,molBond,molSelect);svd=function(){function svd(A){var temp;var prec=Math.pow(2,-52);var tolerance=1e-64/prec;var itmax=50;var c=0;var i=0;var j=0;var k=0;var l=0;var u=A;var m=u.length;var n=u[0].length;if(m<n)throw"Need more rows than columns";var e=new Array(n);var q=new Array(n);for(i=0;i<n;i++)e[i]=q[i]=0;var v=[];for(var i=0;i<n;++i){var xxx=[];v.push([]);for(var j=0;j<n;++j){xxx.push(0)}v.push(xxx)}function pythag(a,b){a=Math.abs(a);b=Math.abs(b);if(a>b)return a*Math.sqrt(1+b*b/a/a);else if(b==0)return a;return b*Math.sqrt(1+a*a/b/b)}var f=0;var g=0;var h=0;var x=0;var y=0;var z=0;var s=0;for(i=0;i<n;i++){e[i]=g;s=0;l=i+1;for(j=i;j<m;j++)s+=u[j][i]*u[j][i];if(s<=tolerance)g=0;else{f=u[i][i];g=Math.sqrt(s);if(f>=0)g=-g;h=f*g-s;u[i][i]=f-g;for(j=l;j<n;j++){s=0;for(k=i;k<m;k++)s+=u[k][i]*u[k][j];f=s/h;for(k=i;k<m;k++)u[k][j]+=f*u[k][i]}}q[i]=g;s=0;for(j=l;j<n;j++)s=s+u[i][j]*u[i][j];if(s<=tolerance)g=0;else{f=u[i][i+1];g=Math.sqrt(s);if(f>=0)g=-g;h=f*g-s;u[i][i+1]=f-g;for(j=l;j<n;j++)e[j]=u[i][j]/h;for(j=l;j<m;j++){s=0;for(k=l;k<n;k++)s+=u[j][k]*u[i][k];for(k=l;k<n;k++)u[j][k]+=s*e[k]}}y=Math.abs(q[i])+Math.abs(e[i]);if(y>x)x=y}for(i=n-1;i!=-1;i+=-1){if(g!=0){h=g*u[i][i+1];for(j=l;j<n;j++)v[j][i]=u[i][j]/h;for(j=l;j<n;j++){s=0;for(k=l;k<n;k++)s+=u[i][k]*v[k][j];for(k=l;k<n;k++)v[k][j]+=s*v[k][i]}}for(j=l;j<n;j++){v[i][j]=0;v[j][i]=0}v[i][i]=1;g=e[i];l=i}for(i=n-1;i!=-1;i+=-1){l=i+1;g=q[i];for(j=l;j<n;j++)u[i][j]=0;if(g!=0){h=u[i][i]*g;for(j=l;j<n;j++){s=0;for(k=l;k<m;k++)s+=u[k][i]*u[k][j];f=s/h;for(k=i;k<m;k++)u[k][j]+=f*u[k][i]}for(j=i;j<m;j++)u[j][i]=u[j][i]/g}else for(j=i;j<m;j++)u[j][i]=0;u[i][i]+=1}prec=prec*x;for(k=n-1;k!=-1;k+=-1){for(var iteration=0;iteration<itmax;iteration++){var test_convergence=false;for(l=k;l!=-1;l+=-1){if(Math.abs(e[l])<=prec){test_convergence=true;break}if(Math.abs(q[l-1])<=prec)break}if(!test_convergence){c=0;s=1;var l1=l-1;for(i=l;i<k+1;i++){f=s*e[i];e[i]=c*e[i];if(Math.abs(f)<=prec)break;g=q[i];h=pythag(f,g);q[i]=h;c=g/h;s=-f/h;for(j=0;j<m;j++){y=u[j][l1];z=u[j][i];u[j][l1]=y*c+z*s;u[j][i]=-y*s+z*c}}}z=q[k];if(l==k){if(z<0){q[k]=-z;for(j=0;j<n;j++)v[j][k]=-v[j][k]}break}if(iteration>=itmax-1)throw"Error: no convergence.";x=q[l];y=q[k-1];g=e[k-1];h=e[k];f=((y-z)*(y+z)+(g-h)*(g+h))/(2*h*y);g=pythag(f,1);if(f<0)f=((x-z)*(x+z)+h*(y/(f-g)-h))/x;else f=((x-z)*(x+z)+h*(y/(f+g)-h))/x;c=1;s=1;for(i=l+1;i<k+1;i++){g=e[i];y=q[i];h=s*g;g=c*g;z=pythag(f,h);e[i-1]=z;c=f/z;s=h/z;f=x*c+g*s;g=-x*s+g*c;h=y*s;y=y*c;for(j=0;j<n;j++){x=v[j][i-1];z=v[j][i];v[j][i-1]=x*c+z*s;v[j][i]=-x*s+z*c}z=pythag(f,h);q[i-1]=z;c=f/z;s=h/z;f=c*g+s*y;x=-s*g+c*y;for(j=0;j<m;j++){y=u[j][i-1];z=u[j][i];u[j][i-1]=y*c+z*s;u[j][i]=-y*s+z*c}}e[l]=0;e[k]=f;q[k]=x}}for(i=0;i<q.length;i++)if(q[i]<prec)q[i]=0;for(i=0;i<n;i++){for(j=i-1;j>=0;j--){if(q[j]<q[i]){c=q[j];q[j]=q[i];q[i]=c;for(k=0;k<u.length;k++){temp=u[k][i];u[k][i]=u[k][j];u[k][j]=temp}for(k=0;k<v.length;k++){temp=v[k][i];v[k][i]=v[k][j];v[k][j]=temp}i=j}}}return{U:u,S:q,V:v}}return svd}();molSuperpose=function(){var vec3=glMatrix.vec3;var mat3=glMatrix.mat3;var quat=glMatrix.quat;var calculateCenter=function(atoms,center){vec3.set(center,0,0,0);if(atoms.length===0){return}for(var i=0;i<atoms.length;++i){var atom=atoms[i];vec3.add(center,center,atom.pos())}vec3.scale(center,center,1/atoms.length)};var calculateCov=function(){var shiftedSubject=vec3.create();var shiftedReference=vec3.create();return function(subjectAtoms,referenceAtoms,subjectCenter,referenceCenter,covariance){covariance[0]=0;covariance[1]=0;covariance[2]=0;covariance[3]=0;covariance[4]=0;covariance[5]=0;covariance[6]=0;covariance[7]=0;covariance[8]=0;for(var i=0;i<referenceAtoms.length;++i){vec3.sub(shiftedSubject,subjectAtoms[i].pos(),subjectCenter);vec3.sub(shiftedReference,referenceAtoms[i].pos(),referenceCenter);var ss=shiftedSubject;var sr=shiftedReference;covariance[0]+=ss[0]*sr[0];covariance[1]+=ss[0]*sr[1];covariance[2]+=ss[0]*sr[2];covariance[3]+=ss[1]*sr[0];covariance[4]+=ss[1]*sr[1];covariance[5]+=ss[1]*sr[2];covariance[6]+=ss[2]*sr[0];covariance[7]+=ss[2]*sr[1];covariance[8]+=ss[2]*sr[2]}}}();var superpose=function(){var referenceCenter=vec3.create();var subjectCenter=vec3.create();var shiftedPos=vec3.create();var rotation=mat3.create();var cov=mat3.create();var tmp=mat3.create();var uMat=mat3.create();var vMat=mat3.create();return function(structure,reference){var subjectAtoms=structure.atoms();var referenceAtoms=reference.atoms();calculateCenter(referenceAtoms,referenceCenter);calculateCenter(subjectAtoms,subjectCenter);if(subjectAtoms.length!==referenceAtoms.length){console.error("atom counts do not match ("+subjectAtoms.length+"in structure vs "+referenceAtoms.length+" in reference)");return false}if(subjectAtoms.length<3){console.error("at least 3 atoms are required for superposition");return false}calculateCov(subjectAtoms,referenceAtoms,subjectCenter,referenceCenter,cov);var input=[[cov[0],cov[1],cov[2]],[cov[3],cov[4],cov[5]],[cov[6],cov[7],cov[8]]];var u=[[],[],[]];var v=[[],[],[]];var decomp=svd(input);uMat[0]=decomp.U[0][0];uMat[1]=decomp.U[0][1];uMat[2]=decomp.U[0][2];uMat[3]=decomp.U[1][0];uMat[4]=decomp.U[1][1];uMat[5]=decomp.U[1][2];uMat[6]=decomp.U[2][0];uMat[7]=decomp.U[2][1];uMat[8]=decomp.U[2][2];var detU=mat3.determinant(uMat);vMat[0]=decomp.V[0][0];vMat[1]=decomp.V[0][1];vMat[2]=decomp.V[0][2];vMat[3]=decomp.V[1][0];vMat[4]=decomp.V[1][1];vMat[5]=decomp.V[1][2];vMat[6]=decomp.V[2][0];vMat[7]=decomp.V[2][1];vMat[8]=decomp.V[2][2];var detV=mat3.determinant(vMat);mat3.identity(tmp);if(detU*detV<0){console.log("determinants smaller than zero!");tmp[8]=-1;mat3.mul(uMat,uMat,tmp)}console.log(mat3.str(uMat));mat3.mul(rotation,mat3.transpose(vMat,vMat),uMat);var allAtoms=structure.full().atoms();for(var i=0;i<allAtoms.length;++i){var atom=allAtoms[i];vec3.sub(shiftedPos,atom.pos(),subjectCenter);vec3.transformMat3(shiftedPos,shiftedPos,rotation);vec3.add(shiftedPos,referenceCenter,shiftedPos);atom.setPos(shiftedPos)}return true}}();function parseAtomNames(atoms){if(atoms===undefined||atoms===null||atoms==="all"){return null}if(atoms==="backbone"){return{CA:true,C:true,O:true,N:true}}if(atoms.substr!==undefined){var results={};var atomNames=atoms.split(",");for(var i=0;i<atomNames.length;++i){results[atomNames[i].trim()]=true}return results}else{var results={};for(var i=0;i<atoms.length;++i){results[atoms[i]]=true}return results}}function addAtomsPresentInBoth(inA,inB,outA,outB,atomSet){var atomsA=inA.atoms();var atomsB=inB.atoms();for(var i=0;i<atomsA.length;++i){var atomA=atomsA[i];if(atomSet!==null&&atomSet[atomA.name()]!==true){continue}for(var j=0;j<atomsB.length;++j){var atomB=atomsB[j];if(atomB.name()===atomA.name()){outA.push(atomA);outB.push(atomB);break}}}}function matchResidues(inA,inB,atoms,matchFn){var outA=inA.full().createEmptyView();var outB=inB.full().createEmptyView();var numChains=Math.min(inA.chains().length,inB.chains().length);var atomSet=parseAtomNames(atoms);for(var i=0;i<numChains;++i){var chainA=inA.chains()[i];var chainB=inB.chains()[i];var matchedResidues=matchFn(chainA,chainB);var residuesA=matchedResidues[0];var residuesB=matchedResidues[1];if(residuesA.length!==residuesB.length){console.error("chains",chainA.name()," and",chainB.name()," do not contain the same number of residues.");return null}var outChainA=outA.addChain(chainA);var outChainB=outB.addChain(chainB);for(var j=0;j<residuesA.length;++j){var residueA=residuesA[j];var residueB=residuesB[j];var outAtomsA=[],outAtomsB=[];addAtomsPresentInBoth(residueA,residueB,outAtomsA,outAtomsB,atomSet);if(outAtomsA.length===0){continue}var outResidueA=outChainA.addResidue(residueA);var outResidueB=outChainB.addResidue(residueB);for(var k=0;k<outAtomsA.length;++k){outResidueA.addAtom(outAtomsA[k]);outResidueB.addAtom(outAtomsB[k])}}}return[outA,outB]}function matchResiduesByIndex(inA,inB,atoms){return matchResidues(inA,inB,atoms,function(chainA,chainB){return[chainA.residues(),chainB.residues()]})}function matchResiduesByNum(inA,inB,atoms){return matchResidues(inA,inB,atoms,function(chainA,chainB){var outA=[],outB=[];var inA=chainA.residues();for(var i=0;i<inA.length;++i){var resB=chainB.residueByRnum(inA[i].num());if(resB!==null){outA.push(inA[i]);outB.push(resB)}}return[outA,outB]})}return{superpose:superpose,matchResiduesByNum:matchResiduesByNum,matchResiduesByIndex:matchResiduesByIndex,parseAtomNames:parseAtomNames,addAtomsPresentInBoth:addAtomsPresentInBoth}}();molAll=mol=function(sp){var vec3=glMatrix.vec3;var zhangSkolnickSS=function(){var posOne=vec3.create();var posTwo=vec3.create();return function(trace,i,distances,delta){for(var j=Math.max(0,i-2);j<=i;++j){for(var k=2;k<5;++k){if(j+k>=trace.length()){continue}var d=vec3.dist(trace.posAt(posOne,j),trace.posAt(posTwo,j+k));if(Math.abs(d-distances[k-2])>delta){return false}}}return true}}();var isHelical=function(trace,i){var helixDistances=[5.45,5.18,6.37];var helixDelta=2.1;return zhangSkolnickSS(trace,i,helixDistances,helixDelta)};var isSheet=function(trace,i){var sheetDistances=[6.1,10.4,13];var sheetDelta=1.42;return zhangSkolnickSS(trace,i,sheetDistances,sheetDelta)};function traceAssignHelixSheet(trace){for(var i=0;i<trace.length();++i){if(isHelical(trace,i)){trace.residueAt(i).setSS("H");continue}if(isSheet(trace,i)){trace.residueAt(i).setSS("E");continue}trace.residueAt(i).setSS("C")}}function assignHelixSheet(structure){console.time("mol.assignHelixSheet");var chains=structure.chains();for(var ci=0;ci<chains.length;++ci){var chain=chains[ci];chain.eachBackboneTrace(traceAssignHelixSheet)}console.timeEnd("mol.assignHelixSheet")}return{Mol:mol.Mol,MolView:mol.MolView,assignHelixSheet:assignHelixSheet,superpose:sp.superpose,matchResiduesByIndex:sp.matchResiduesByIndex,matchResiduesByNum:sp.matchResiduesByNum}}(molSuperpose);io=function(symmetry){var vec3=glMatrix.vec3;var mat4=glMatrix.mat4;function Remark350Reader(){this._assemblies={};this._current=null}Remark350Reader.prototype={assemblies:function(){var assemblies=[];for(var c in this._assemblies){if(this._assemblies.hasOwnProperty(c)){assemblies.push(this._assemblies[c])}}return assemblies},assembly:function(id){return this._assemblies[id]},nextLine:function(line){line=line.substr(11);if(line[0]==="B"&&line.substr(0,12)==="BIOMOLECULE:"){var name=line.substr(13).trim();this._currentAssembly=new symmetry.Assembly(name);this._assemblies[name]=this._currentAssembly;return}if(line.substr(0,30)==="APPLY THE FOLLOWING TO CHAINS:"||line.substr(0,30)==="                   AND CHAINS:"){var chains=line.substr(30).split(",");if(line[0]==="A"){this._currentSymGen=new symmetry.SymGenerator;this._currentAssembly.addGenerator(this._currentSymGen)}this._currentMatrix=mat4.create();for(var i=0;i<chains.length;++i){var trimmedChainName=chains[i].trim();if(trimmedChainName.length){this._currentSymGen.addChain(trimmedChainName)}}return}if(line.substr(0,7)==="  BIOMT"){var col=parseInt(line[7],10)-1;var offset=0;while(line[12+offset]!==" "){offset+=1}var x=parseFloat(line.substr(13+offset,9));var y=parseFloat(line.substr(23+offset,9));var z=parseFloat(line.substr(33+offset,9));var w=parseFloat(line.substr(43+offset,14));this._currentMatrix[4*0+col]=x;this._currentMatrix[4*1+col]=y;this._currentMatrix[4*2+col]=z;this._currentMatrix[4*3+col]=w;if(col===2){this._currentSymGen.addMatrix(this._currentMatrix);this._currentMatrix=mat4.create()}return}}};function guessAtomElementFromName(fourLetterName){if(fourLetterName[0]!==" "){var trimmed=fourLetterName.trim();if(trimmed.length===4){var i=0;var charCode=trimmed.charCodeAt(i);while(i<4&&(charCode<65||charCode>122||charCode>90&&charCode<97)){++i;charCode=trimmed.charCodeAt(i)}return trimmed[i]}var firstCharCode=trimmed.charCodeAt(0);if(firstCharCode>=48&&firstCharCode<=57){return trimmed[1]}return trimmed.substr(0,2)}return fourLetterName[1]}function PDBReader(options){this._helices=[];this._sheets=[];this._conect=[];this._serialToAtomMap={};this._structure=new mol.Mol;this._remark350Reader=new Remark350Reader;this._currChain=null;this._currRes=null;this._currAtom=null;this._options={};this._options.conectRecords=!!options.conectRecords}PDBReader.prototype={CONTINUE:1,MODEL_COMPLETE:2,FILE_END:3,ERROR:4,parseHelixRecord:function(line){var frstNum=parseInt(line.substr(21,4),10);var frstInsCode=line[25]===" "?"\0":line[25];var lastNum=parseInt(line.substr(33,4),10);var lastInsCode=line[37]===" "?"\0":line[37];var chainName=line[19];this._helices.push({first:[frstNum,frstInsCode],last:[lastNum,lastInsCode],chainName:chainName});return true},parseSheetRecord:function(line){var frstNum=parseInt(line.substr(22,4),10);var frstInsCode=line[26]===" "?"\0":line[26];var lastNum=parseInt(line.substr(33,4),10);var lastInsCode=line[37]===" "?"\0":line[37];var chainName=line[21];this._sheets.push({first:[frstNum,frstInsCode],last:[lastNum,lastInsCode],chainName:chainName});return true},parseAndAddAtom:function(line){var alt_loc=line[16];if(alt_loc!==" "&&alt_loc!=="A"){return true}var isHetatm=line[0]==="H";var chainName=line[21];var resName=line.substr(17,3).trim();var fullAtomName=line.substr(12,4);var atomName=fullAtomName.trim();var rnumNum=parseInt(line.substr(22,4),10);if(rnumNum!==rnumNum){rnumNum=1}var insCode=line[26]===" "?"\0":line[26];var updateResidue=false;var updateChain=false;if(!this._currChain||this._currChain.name()!==chainName){updateChain=true;updateResidue=true}if(!this._currRes||this._currRes.num()!==rnumNum||this._currRes.insCode()!==insCode){updateResidue=true}if(updateChain){this._currChain=this._structure.chain(chainName)||this._structure.addChain(chainName)}if(updateResidue){this._currRes=this._currChain.addResidue(resName,rnumNum,insCode)}var pos=vec3.create();for(var i=0;i<3;++i){pos[i]=parseFloat(line.substr(30+i*8,8))}var element=line.substr(76,2).trim();if(element===""){element=guessAtomElementFromName(fullAtomName)}var occupancy=parseFloat(line.substr(54,6).trim());var tempFactor=parseFloat(line.substr(60,6).trim());var atom=this._currRes.addAtom(atomName,pos,element,isHetatm,isNaN(occupancy)?null:occupancy,isNaN(tempFactor)?null:tempFactor);if(this._options.conectRecords){var serial=parseInt(line.substr(6,5).trim(),10);this._serialToAtomMap[serial]=atom}return true},parseConectRecord:function(line){var atomSerial=parseInt(line.substr(6,5).trim(),10);var bondPartnerIds=[];for(var i=0;i<4;++i){var partnerId=parseInt(line.substr(11+i*5,6).trim(),10);if(isNaN(partnerId)){continue}if(partnerId>atomSerial){continue}bondPartnerIds.push(partnerId)}this._conect.push({from:atomSerial,to:bondPartnerIds});return true},processLine:function(line){var recordName=line.substr(0,6);if(recordName==="ATOM  "||recordName==="HETATM"){return this.parseAndAddAtom(line)?this.CONTINUE:this.ERROR}if(recordName==="REMARK"){var remarkNumber=line.substr(7,3);if(remarkNumber==="350"){this._remark350Reader.nextLine(line)}return this.CONTINUE}if(recordName==="HELIX "){return this.parseHelixRecord(line)?this.CONTINUE:this.ERROR}if(recordName==="SHEET "){return this.parseSheetRecord(line)?this.CONTINUE:this.ERROR}if(this._options.conectRecords&&recordName==="CONECT"){return this.parseConectRecord(line)?this.CONTINUE:this.ERROR}if(recordName==="END   "){return this.FILE_END}if(recordName==="ENDMDL"){return this.MODEL_COMPLETE}return this.CONTINUE},finish:function(){if(this._currChain===null){return null}var chain=null;var i;for(i=0;i<this._sheets.length;++i){var sheet=this._sheets[i];chain=this._structure.chain(sheet.chainName);if(chain){chain.assignSS(sheet.first,sheet.last,"E")}}for(i=0;i<this._helices.length;++i){var helix=this._helices[i];chain=this._structure.chain(helix.chainName);if(chain){chain.assignSS(helix.first,helix.last,"H")}}this._structure.setAssemblies(this._remark350Reader.assemblies());if(this._options.conectRecords){this._assignBondsFromConectRecords(this._structure)}this._structure.deriveConnectivity();console.log("imported",this._structure.chains().length,"chain(s),",this._structure.residueCount(),"residue(s)");var result=this._structure;this._structure=new mol.Mol;this._currChain=null;this._currRes=null;this._currAtom=null;return result},_assignBondsFromConectRecords:function(structure){for(var i=0;i<this._conect.length;++i){var record=this._conect[i];var fromAtom=this._serialToAtomMap[record.from];for(var j=0;j<record.to.length;++j){var toAtom=this._serialToAtomMap[record.to[j]];structure.connect(fromAtom,toAtom)}}}};function getLines(data){return data.split(/\r\n|\r|\n/g)}function pdb(text,options){console.time("pdb");var opts=options||{};var lines=getLines(text);var reader=new PDBReader(opts);var structures=[];for(var i=0;i<lines.length;i++){var result=reader.processLine(lines[i]);if(result===reader.ERROR){console.timeEnd("pdb");return null}if(result===reader.CONTINUE){continue}var struct=reader.finish();if(struct!==null){structures.push(struct)}if(result===reader.MODEL_COMPLETE&&opts.loadAllModels){continue}break}var structure=reader.finish();if(structure!==null){structures.push(structure)}console.timeEnd("pdb");if(opts.loadAllModels){return structures}return structures[0]}function SDFReader(){this._structure=new mol.Mol;this._reset();this._sawEnd=false}SDFReader.prototype={processLine:function(line){var state=this._state;if(state<3){if(state===0){var trimmed=line.trim();if(trimmed.length===0){return false}this._title=trimmed}this._sawEnd=false;this._state++;return true}if(state===3){this._expectedAtomCount=parseInt(line.substr(0,3).trim(),10);this._expectedBondCount=parseInt(line.substr(3,3).trim(),10);if(isNaN(this._expectedAtomCount)||isNaN(this._expectedBondCount)){console.error("invalid bond definition");return false}this._state++;var chainName=""+(this._structure.chains().length+1);this._currentChain=this._structure.addChain(chainName);this._currentResidue=this._currentChain.addResidue(this._title,1)}if(state===4){var pos=[0,0,0];for(var i=0;i<3;++i){pos[i]=parseFloat(line.substr(i*10,10).trim());if(isNaN(pos[i])){console.error("invalid atom position");return false}}var element=line.substr(31,3).trim();this._currentResidue.addAtom(element,pos,element,false);this._atomCount++;if(this._atomCount===this._expectedAtomCount){this._state++}}if(state===5){var firstAtomIndex=parseInt(line.substr(0,3).trim(),10)-1;var secondAtomIndex=parseInt(line.substr(3,3).trim(),10)-1;if(isNaN(firstAtomIndex)||isNaN(secondAtomIndex)){console.error("invalid bond definition");return false}var atoms=this._currentResidue.atoms();this._structure.connect(atoms[firstAtomIndex],atoms[secondAtomIndex]);this._bondCount++;if(this._bondCount===this._expectedBondCount){this._state++}}if(line.substr(0,6)==="M  END"){this._sawEnd=true;this._state++}if(line.substr(0,4)==="$$$$"){this._reset()}return true},_reset:function(){this._state=0;this._currentResidue=null;this._currentChain=null;this._expectedAtomCount=null;this._expectedBondount=null;this._atomCount=0;this._bondCount=0;this._title=""},finish:function(){if(!this._sawEnd){console.error("truncated SDF file");return null}return this._structure}};function sdf(text){console.time("sdf");var reader=new SDFReader;var lines=getLines(text);for(var i=0;i<lines.length;i++){if(!reader.processLine(lines[i])){break}}var structure=reader.finish();console.timeEnd("sdf");return structure}function fetch(url,callback){var oReq=new XMLHttpRequest;oReq.open("GET",url,true);oReq.onload=function(){if(oReq.response){callback(oReq.response)}};oReq.send(null)}function fetchPdb(url,callback,options){fetch(url,function(data){var structure=pdb(data,options);callback(structure)})}function fetchSdf(url,callback){fetch(url,function(data){var structure=sdf(data);callback(structure)})}return{pdb:pdb,sdf:sdf,Remark350Reader:Remark350Reader,fetchPdb:fetchPdb,fetchSdf:fetchSdf,guessAtomElementFromName:guessAtomElementFromName}}(molSymmetry);viewpoint=function(){var vec3=glMatrix.vec3;var mat3=glMatrix.mat3;var calculateCovariance=function(){var center=vec3.create();var shiftedPos=vec3.create();return function(go,covariance){vec3.set(center,0,0,0);var atomCount=0;go.eachCentralAtom(function(atom,transformedPos){vec3.add(center,center,transformedPos);atomCount+=1});if(atomCount===0){return}vec3.scale(center,center,1/atomCount);covariance[0]=0;covariance[1]=0;covariance[2]=0;covariance[3]=0;covariance[4]=0;covariance[5]=0;covariance[6]=0;covariance[7]=0;covariance[8]=0;go.eachCentralAtom(function(atom,transformedPos){vec3.sub(shiftedPos,transformedPos,center);var x=shiftedPos[0],y=shiftedPos[1],z=shiftedPos[2];covariance[0]+=y*y+z*z;covariance[1]-=x*y;covariance[2]-=x*z;covariance[5]-=y*z;covariance[4]+=x*x+z*z;covariance[8]+=x*x+y*y});covariance[3]=covariance[1];covariance[6]=covariance[2];covariance[7]=covariance[5]}}();var principalAxes=function(){var covariance=mat3.create();var diag=mat3.create();var min=vec3.create();var max=vec3.create();var projected=vec3.create();var range=vec3.create();var x=vec3.create();var y=vec3.create();var z=vec3.create();return function(go){calculateCovariance(go,covariance);var q=geom.diagonalizer(covariance);mat3.fromQuat(diag,q);var first=true;go.eachCentralAtom(function(atom,transformedPos){vec3.transformMat3(projected,transformedPos,diag);if(first){vec3.copy(min,projected);vec3.copy(max,projected);first=false}else{vec3.min(min,min,projected);vec3.max(max,max,projected)}});vec3.sub(range,max,min);var axes=[[range[0],0],[range[1],1],[range[2],2]];axes.sort(function(a,b){return b[0]-a[0]});var xIndex=axes[0][1];var yIndex=axes[1][1];vec3.set(x,diag[xIndex+0],diag[xIndex+3],diag[xIndex+6]);vec3.set(y,diag[yIndex+0],diag[yIndex+3],diag[yIndex+6]);vec3.cross(z,x,y);var rotation=mat3.create();rotation[0]=x[0];rotation[1]=y[0];rotation[2]=z[0];rotation[3]=x[1];rotation[4]=y[1];rotation[5]=z[1];rotation[6]=x[2];rotation[7]=y[2];rotation[8]=z[2];return rotation}}();return{principalAxes:principalAxes}}();pv=function(){return{Viewer:viewer.Viewer,isWebGLSupported:viewer.isWebGLSupported,io:io,color:color,mol:mol,rgb:{setColorPalette:color.setColorPalette,hex2rgb:color.hex2rgb},vec3:glMatrix.vec3,vec4:glMatrix.vec4,mat3:glMatrix.mat3,mat4:glMatrix.mat4,quat:glMatrix.quat,viewpoint:viewpoint}}();return pv});